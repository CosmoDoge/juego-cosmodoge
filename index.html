<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CosmoDoge Flotante üöÄ</title>

  <!-- ethers.js -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getFirestore, collection, query, orderBy, limit, getDocs, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDaM9HtMtTlJXc-V4HfsZ7bbC__ZPe9zIk",
      authDomain: "cosmodogelive.firebaseapp.com",
      projectId: "cosmodogelive",
      storageBucket: "cosmodogelive.appspot.com",
      messagingSenderId: "648227069914",
      appId: "1:648227069914:web:3ef7ac8da4ab52c30deae3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    window.guardarJugadorAutomatic = async function(username, puntaje, monedas) {
      try {
        await addDoc(collection(db, "jugadores"), {
          nombre: String(username),
          puntaje: Number(puntaje),
          monedas: Number(monedas),
          fecha: serverTimestamp()
        });
      } catch (error) {
        console.error("‚ùå Error guardando jugador:", error);
      }
    };

    window.mostrarTopRanking = async function() {
      const lista = document.getElementById("topRanking");
      try {
        const q = query(collection(db, "jugadores"), orderBy("puntaje", "desc"), limit(5));
        const querySnapshot = await getDocs(q);
        let html = "<h2>üèÜ Top 5 CosmoDoge</h2><ul style='list-style:none;padding:0;'>";
        querySnapshot.forEach((doc, index) => {
          const data = doc.data();
          html += `<li>#${index + 1} <strong>${data.nombre}</strong> - ${data.puntaje} pts - ${data.monedas} ü™ô</li>`;
        });
        html += "</ul>";
        lista.innerHTML = html;
      } catch (error) {
        console.error("‚ùå Error cargando ranking:", error);
        lista.innerHTML = "<p style='color:red;'>Error cargando ranking.</p>";
      }
    };
  </script>

  <!-- Estilos -->
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body {
      overflow: hidden;
      width: 100%;
      height: 100%;
      touch-action: none;
      background: black;
      font-family: 'Orbitron', Arial, sans-serif;
    }
    canvas {
      display: block;
      margin: auto;
      max-width: 100vw;
      max-height: 100vh;
    }
    #scoreDisplay, #coinDisplay, #highScoreDisplay, #contadorCDOGE {
      position: absolute;
      left: 10px;
      color: white;
      font-size: 18px;
      text-shadow: 2px 2px 5px #000;
    }
    #scoreDisplay { top: 10px; }
    #coinDisplay { top: 40px; }
    #highScoreDisplay { top: 70px; }
    #contadorCDOGE { top: 100px; color: #00ffcc; }
    #nombreJugador {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 18px;
      color: #00ffff;
      z-index: 10;
    }
    #conectarWalletBtn, #reanudarBtn, #menuPrincipal button, .btn {
      background: #00ffff;
      color: black;
      border: none;
      border-radius: 12px;
      padding: 10px 20px;
      font-size: 16px;
      font-family: 'Orbitron', sans-serif;
      cursor: pointer;
      z-index: 10000;
      transition: background-color 0.3s ease;
    }
    .btn:hover, #conectarWalletBtn:hover, #menuPrincipal button:hover {
      background-color: #00e7f5;
    }
    #conectarWalletBtn { position: fixed; top: 20px; right: 20px; }
    #reanudarBtn { display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
    #menuPrincipal { position: fixed; top: 70px; right: 20px; display: flex; flex-direction: column; gap: 10px; }
    #tiendaCDOGE {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: rgba(0,0,0,0.85);
      border: 2px solid #00ffff;
      border-radius: 15px;
      padding: 15px;
      display: none;
      width: 300px;
      color: white;
    }
    #contadorIman {
      position: fixed;
      bottom: 10px;
      right: 20px;
      background: rgba(0,0,0,0.7);
      padding: 8px 12px;
      border-radius: 10px;
      display: none;
      font-size: 16px;
      color: #00ffff;
      z-index: 1000;
    }
    #pantallaCarga {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: black;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      z-index: 9999;
    }
    .spinner {
      width: 60px; height: 60px;
      border: 6px solid #ffffff22;
      border-top: 6px solid #00ffff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    #gameOverScreen {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(0, 0, 0, 0.85);
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      color: white;
      text-align: center;
      opacity: 0;
      transition: opacity 1s;
      z-index: 9998;
    }
    #gameOverScreen.show { display: flex; opacity: 1; }
    #balanceCDOGE {
      position: fixed;
      top: 120px;
      right: 20px;
      background: rgba(0,0,0,0.7);
      padding: 10px;
      color: #00ffcc;
      font-size: 16px;
      border-radius: 10px;
      display: none;
      z-index: 10000;
    }
  </style>
</head>
<body>
  <div id="pantallaCarga">
    <div class="spinner"></div>
    <p style="color: white; font-size: 20px; margin-top: 20px;">Iniciando viaje intergal√°ctico...</p>
  </div>

  <canvas id="gameCanvas" width="480" height="640"></canvas>

  <div id="scoreDisplay">üöÄ x 0</div>
  <div id="coinDisplay">üí∞ x 0</div>
  <div id="highScoreDisplay">üîù M√°x: 0</div>
  <div id="contadorCDOGE">üí∞ CDOGE: 0</div>
  <div id="nombreJugador"></div>

  <button id="conectarWalletBtn">üîó Conectar Wallet</button>
  <div id="balanceCDOGE"></div>

  <div id="menuPrincipal">
    <button onclick="toggleTienda()">üõí Tienda</button>
  </div>

  <div id="tiendaCDOGE">
    <h3 style="margin-bottom: 10px; color: #00ffff;">üõí Tienda CosmoDoge</h3>
    <div style="margin-bottom: 15px; padding: 10px; background: #111; border-radius: 10px; border: 1px solid #00ffcc;">
      <p style="margin: 0;">üß≤ Im√°n Espacial</p>
      <p style="font-size: 14px; color: #bbb;">Atrae monedas durante 1 hora autom√°ticamente.</p>
      <button id="comprarIman" class="btn" style="margin-top: 5px;">Comprar por 5,000 $CDOGE</button>
    </div>
  </div>

  <div id="contadorIman">üß≤ Im√°n activo: 60:00</div>

  <div id="startScreen" style="display:none;">
    <h1>üöÄ Mant√©n a CosmoDoge flotando</h1>
    <button class="btn" id="startButton">¬°Comenzar!</button>
  </div>

  <div id="gameOverScreen">
    <h1>üö® GAME OVER üö®</h1>
    <p>Puntaje: <span id="finalScore">0</span></p>
    <button class="btn" id="reiniciarBtn" style="margin-top: 20px;">Reiniciar</button>
  </div>

  <div id="newRecordMessage" style="display:none;">
    <h1>üåü ¬°Nuevo r√©cord gal√°ctico!</h1>
    <p>üèÜ ¬°Has superado todos los l√≠mites de CosmoDoge!</p>
  </div>

  <div id="playerNameForm" style="display:none; margin-top: 20px;">
    <input type="text" id="playerName" placeholder="Tu nombre gal√°ctico" style="padding: 10px; font-size: 16px; border-radius: 8px; margin-bottom: 10px;">
    <button class="btn" id="saveScoreButton">Guardar Puntaje</button>
  </div>

  <div id="rankingPanel" style="position: absolute; top: 10%; left: 50%; transform: translateX(-50%); text-align: center;">
    <div id="topRanking"></div>
    <button class="btn" id="closeRankingBtn" onclick="this.parentNode.style.display='none'">Cerrar</button>
  </div>

  <button id="reanudarBtn">Reanudar Juego</button>
  <script>
    // ====================
    // VARIABLES DEL JUEGO
    // ====================
    let canvas = document.getElementById('gameCanvas');
    let ctx = canvas.getContext('2d');
    let gameLoop;
    let doge, fondo, fondos, fondoIndex, coinsArray = [], specialObstacles = [], monedasCDOGE = [];
    let score = 0, coins = 0, totalCDOGERecolectado = 0, highScore = 0, gameStarted = false, isGameOver = false;
    let gravedad = 0.5, saltar = -10, timeElapsed = 0, lastScoreTime = 0, lastFondoChange = 0;
    let imanActivo = false, auraAzul = false, intervaloIman;
    let esMovil = /Mobi|Android/i.test(navigator.userAgent);
    
    // ====================
    // CARGA DE ASSETS
    // ====================
    const dogeImg = new Image(); dogeImg.src = "cosmodoge-cohete-juego.png";
    const coinImg = new Image(); coinImg.src = "coin-cosmodoge.png";
    const monedaCdogeImg = new Image(); monedaCdogeImg.src = "moneda-cosmodoge.png";
    fondos = ["fondo-cosmodoge-v2.png", "fondo-cosmodoge-v3.png", "fondo-cosmodoge-v4.png"];
    fondoIndex = 0; fondo = new Image(); fondo.src = fondos[fondoIndex];
    
    // ====================
    // SONIDOS
    // ====================
    const sndJump = new Audio("jump.mp3");
    const sndCoin = new Audio("coin.mp3");
    const sndBoom = new Audio("boom.mp3");
    const sndRecord = new Audio("record.mp3");
    const music = new Audio("music-cosmodoge-theme.mp3");
    music.loop = true;
    music.volume = 0.3;
    
    // ====================
    // FUNCIONES PRINCIPALES
    // ====================
    function inicializarJuego() {
      doge = { x: 80, y: 200, width: 50, height: 50, velocity: 0, img: dogeImg };
      coins = parseInt(localStorage.getItem("cdogeCoins")) || 0;
      totalCDOGERecolectado = parseInt(localStorage.getItem("cdogeRecolectados")) || 0;
      highScore = parseInt(localStorage.getItem("cdogeFloatHighScore")) || 0;
      actualizarContadores();
    }
    
    function actualizarContadores() {
      document.getElementById('coinDisplay').textContent = `üí∞ x ${coins}`;
      document.getElementById('highScoreDisplay').textContent = `üîù M√°x: ${highScore}`;
      document.getElementById('contadorCDOGE').textContent = `üí∞ CDOGE: ${totalCDOGERecolectado}`;
    }
   // ====================
// ESTADO DEL IM√ÅN
// ====================
function actualizarEstadoIman() {
  clearInterval(intervaloIman);
  const expiracion = parseInt(localStorage.getItem("imanExpiraEn") || 0);
  const restante = expiracion - Date.now();
  if (restante > 0) {
    imanActivo = true; auraAzul = true;
    iniciarContadorIman(restante);
  } else {
    imanActivo = false; auraAzul = false;
    document.getElementById('contadorIman').style.display = "none";
    localStorage.removeItem("imanExpiraEn");
  }
}

function iniciarContadorIman(tiempo) {
  const div = document.getElementById("contadorIman");
  div.style.display = "block";
  intervaloIman = setInterval(() => {
    const expiracion = parseInt(localStorage.getItem("imanExpiraEn") || 0);
    const restante = expiracion - Date.now();
    if (restante <= 0) {
      clearInterval(intervaloIman);
      div.style.display = "none";
      imanActivo = false; auraAzul = false;
      localStorage.removeItem("imanExpiraEn");
    } else {
      const minutos = Math.floor(restante / 60000);
      const segundos = Math.floor((restante % 60000) / 1000);
      div.textContent = `üß≤ Im√°n activo: ${minutos.toString().padStart(2,'0')}:${segundos.toString().padStart(2,'0')}`;
    }
  }, 1000);
}

// ====================
// MOTOR DEL JUEGO
// ====================
function updateGame() {
  if (isGameOver) return;

  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.drawImage(fondo, 0, 0, canvas.width, canvas.height);

  // Movimiento Doge
  doge.velocity += gravedad;
  doge.y += doge.velocity;
  if (doge.y + doge.height >= canvas.height || doge.y <= 0) {
    finalizarJuego();
    return;
  }

  // Dibujar Doge
  ctx.drawImage(doge.img, doge.x, doge.y, doge.width, doge.height);
  if (auraAzul) dibujarAura(doge);

  // Dibujar monedas normales y monedas CDOGE
  dibujarCoins();
  dibujarMonedasCDOGE();
  detectarColisionMonedas();

  // Obst√°culos especiales
  dibujarObstaculos();

  // Score y cambios de fondo
  timeElapsed += 16;
  if (timeElapsed - lastScoreTime >= 5000) {
    score++;
    lastScoreTime = timeElapsed;
    document.getElementById('scoreDisplay').textContent = `üöÄ x ${score}`;
  }

  if (timeElapsed - lastFondoChange >= 30000) {
    fondoIndex = (fondoIndex + 1) % fondos.length;
    fondo.src = fondos[fondoIndex];
    lastFondoChange = timeElapsed;
  }

  gameLoop = requestAnimationFrame(updateGame);
}

function dibujarAura(doge) {
  ctx.beginPath();
  ctx.arc(doge.x + doge.width/2, doge.y + doge.height/2, doge.width * 1.5, 0, Math.PI * 2);
  ctx.strokeStyle = '#00ffff88';
  ctx.lineWidth = 4;
  ctx.stroke();
}

function dibujarCoins() {
  coinsArray.forEach((coin, index) => {
    coin.x -= 2;
    ctx.drawImage(coinImg, coin.x, coin.y, coin.width, coin.height);
    if (checkCollision(doge, coin)) {
      coins++;
      localStorage.setItem("cdogeCoins", coins);
      document.getElementById('coinDisplay').textContent = `üí∞ x ${coins}`;
      sndCoin.play().catch(()=>{});
      coinsArray.splice(index, 1);
    }
  });
}

function dibujarMonedasCDOGE() {
  monedasCDOGE.forEach((moneda, index) => {
    if (!moneda.recolectada) {
      ctx.drawImage(monedaCdogeImg, moneda.x, moneda.y, moneda.width, moneda.height);
    }
    if (imanActivo && distancia(doge, moneda) < 150) {
      moneda.x += (doge.x - moneda.x) * 0.05;
      moneda.y += (doge.y - moneda.y) * 0.05;
    }
    if (!moneda.recolectada && checkCollision(doge, moneda)) {
      moneda.recolectada = true;
      totalCDOGERecolectado += 50;
      localStorage.setItem("cdogeRecolectados", totalCDOGERecolectado);
      document.getElementById('contadorCDOGE').textContent = `üí∞ CDOGE: ${totalCDOGERecolectado}`;
      sndCoin.play().catch(()=>{});
    }
  });
}

function detectarColisionMonedas() {
  monedasCDOGE = monedasCDOGE.filter(m => !m.recolectada);
}

function dibujarObstaculos() {
  specialObstacles.forEach((obs, index) => {
    obs.x -= obs.speedX;
    obs.y += obs.speedY;
    ctx.drawImage(obs.img, obs.x, obs.y, obs.width, obs.height);
    if (checkCollision(doge, obs)) finalizarJuego();
  });
  specialObstacles = specialObstacles.filter(obs => obs.x + obs.width > 0);
}

function distancia(a, b) {
  return Math.sqrt((a.x - b.x)**2 + (a.y - b.y)**2);
}

function checkCollision(a, b) {
  return (a.x < b.x + b.width && a.x + a.width > b.x && a.y < b.y + b.height && a.y + a.height > b.y);
}
 // ====================
// FINALIZAR JUEGO
// ====================
function finalizarJuego() {
  isGameOver = true;
  cancelAnimationFrame(gameLoop);
  music.pause();
  music.currentTime = 0;
  document.getElementById('finalScore').textContent = score;
  document.getElementById('gameOverScreen').classList.add('show');

  setTimeout(() => {
    document.getElementById('reiniciarBtn').style.display = "block";
  }, 1500);

  if (score > highScore) {
    localStorage.setItem("cdogeFloatHighScore", score);
    document.getElementById('highScoreDisplay').textContent = `üîù M√°x: ${score}`;
    document.getElementById('newRecordMessage').style.display = "flex";
    sndRecord.play().catch(()=>{});
    const username = localStorage.getItem("cosmodogeliveUserName");
    if (username) {
      guardarJugadorAutomatic(username, score, coins);
    } else {
      document.getElementById('playerNameForm').style.display = "flex";
    }
  } else {
    sndBoom.play().catch(()=>{});
  }
}

// ====================
// FUNCIONES GUARDAR JUGADOR
// ====================
function guardarNombreJugador() {
  const nombre = document.getElementById('playerName').value.trim();
  if (nombre) {
    localStorage.setItem("cosmodogeliveUserName", nombre);
    guardarJugadorAutomatic(nombre, score, coins);
    document.getElementById('playerNameForm').style.display = "none";
  } else {
    alert("Por favor, ingresa tu nombre gal√°ctico.");
  }
}

// ====================
// REANUDAR JUEGO
// ====================
function reanudarJuego() {
  document.getElementById('reanudarBtn').style.display = "none";
  gameLoop = requestAnimationFrame(updateGame);
}

// ====================
// META MASK / WALLET
// ====================
async function conectarWallet() {
  if (!window.ethereum) {
    alert("ü¶ä Instala MetaMask.");
    return;
  }
  try {
    const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
    const account = accounts[0];
    const provider = new ethers.providers.Web3Provider(window.ethereum);
    const contrato = new ethers.Contract("0x5dE25281305992d3552a45A3D8ccA7BdfB4AcD3A", [
      "function balanceOf(address) view returns (uint256)",
      "function decimals() view returns (uint8)"
    ], provider);
    const balance = await contrato.balanceOf(account);
    const decimals = await contrato.decimals();
    const formatted = Number(balance / (10 ** decimals)).toLocaleString();
    document.getElementById('balanceCDOGE').innerHTML = `üöÄ Balance: <strong>${formatted}</strong> $CDOGE`;
    document.getElementById('balanceCDOGE').style.display = "block";
    document.getElementById('conectarWalletBtn').textContent = `üßë‚ÄçüöÄ ${account.slice(0,6)}...${account.slice(-4)}`;
  } catch (err) {
    console.error("Error conectando wallet:", err);
  }
}

// ====================
// TIENDA / COMPRAR IM√ÅN
// ====================
async function comprarImanConCDOGE() {
  if (!window.ethereum) {
    alert("‚ùå Instala MetaMask para comprar.");
    return;
  }
  const provider = new ethers.providers.Web3Provider(window.ethereum);
  const signer = provider.getSigner();
  const tokenAddress = "0x5dE25281305992d3552a45A3D8ccA7BdfB4AcD3A";
  const walletDelJuego = "0x1980dCdDA07071970dEAa69c975F590976Ee667D";
  const tokenABI = [
    "function transfer(address to, uint256 amount) public returns (bool)",
    "function decimals() view returns (uint8)"
  ];
  const token = new ethers.Contract(tokenAddress, tokenABI, signer);
  const decimals = await token.decimals();
  const amount = ethers.utils.parseUnits("5000", decimals);

  if (confirm("¬øComprar üß≤ Im√°n por 5,000 $CDOGE?")) {
    try {
      const tx = await token.transfer(walletDelJuego, amount);
      await tx.wait();
      activarIman();
      alert("‚úÖ ¬°Im√°n activado!");
    } catch (error) {
      console.error(error);
      alert("‚ùå Error o compra cancelada.");
    }
  }
}

// ====================
// MOSTRAR/OCULTAR TIENDA
// ====================
function toggleTienda() {
  const tienda = document.getElementById("tiendaCDOGE");
  tienda.style.display = tienda.style.display === "block" ? "none" : "block";
}

// ====================
// INICIO AUTOM√ÅTICO
// ====================
window.addEventListener("DOMContentLoaded", () => {
  inicializarJuego();
  actualizarEstadoIman();
  setTimeout(() => document.getElementById('pantallaCarga').style.display = "none", 3000);
  document.getElementById('startScreen').style.display = "flex";
});

document.getElementById('startButton').addEventListener('click', iniciarJuego);
document.getElementById('reiniciarBtn').addEventListener('click', () => location.reload());
document.getElementById('saveScoreButton').addEventListener('click', guardarNombreJugador);
document.getElementById('comprarIman').addEventListener('click', comprarImanConCDOGE);
document.getElementById('conectarWalletBtn').addEventListener('click', conectarWallet);
document.getElementById('reanudarBtn').addEventListener('click', reanudarJuego);

document.addEventListener("keydown", e => { if (e.code === "Space" && gameStarted && !isGameOver) saltarDoge(); });
if (esMovil) {
  document.addEventListener("touchstart", () => { if (gameStarted && !isGameOver) saltarDoge(); });
}

function iniciarJuego() {
  document.getElementById('menuPrincipal').style.display = "none";
  document.getElementById('startScreen').style.display = "none";
  document.getElementById('conectarWalletBtn').style.display = "none";
  music.play().catch(()=>{});
  gameStarted = true;
  gameLoop = requestAnimationFrame(updateGame);
}

function saltarDoge() {
  doge.velocity = saltar;
  sndJump.play().catch(()=>{});
}
</script>
