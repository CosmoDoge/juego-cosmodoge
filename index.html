<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CosmoDoge Flotante 🚀</title>
  <!-- Librerías on-chain -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.69.0/lib/index.iife.min.js"></script>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { width: 100%; height: 100%; overflow: hidden; background: #000; color: #fff; font-family: Arial, sans-serif; }
    canvas { display: block; }
    #gameCanvas { background: #000; }
    #preloader, #startScreen, #gameOverScreen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; flex-direction: column; z-index: 10; }
    .button { padding: 10px 20px; margin: 10px; background: #1e1e1e; border: 2px solid #fff; border-radius: 8px; cursor: pointer; }
    #hud { position: absolute; bottom: 0; width: 100%; display: flex; justify-content: space-around; align-items: center; padding: 5px 0; z-index: 5; display: none; }
    #menu { position: absolute; top: 10px; right: 10px; display: none; flex-direction: column; z-index: 5; }
    .panel { position: absolute; top: 50px; right: 50px; width: 300px; max-height: 80%; overflow-y: auto; background: rgba(20,20,20,0.9); padding: 20px; border-radius: 10px; display: none; z-index: 6; }
    #logoCanvas { background: transparent; }
    input, label { color: #000; }
  </style>
</head>
<body>
  <canvas id="gameCanvas" width="800" height="600"></canvas>

  <!-- Preloader -->
  <div id="preloader"><h1>Cargando CosmoDoge...</h1></div>

  <!-- Pantalla de Inicio -->
  <div id="startScreen">
    <h1>CosmoDoge Flotante 🚀</h1>
    <canvas id="logoCanvas" width="300" height="150"></canvas>
    <div class="button" id="startButton">Comenzar</div>
    <div class="button" id="connectWalletBtn">Conectar Wallet</div>
  </div>

  <!-- HUD -->
  <div id="hud">
    <div>Monedas: <span id="coinCount">0</span></div>
    <div>Score: <span id="score">0</span></div>
    <div>High Score: <span id="highScore">0</span></div>
    <div>Escudo: <span id="shieldCount">0</span></div>
    <div>$CDOGE: <span id="balanceCDOGE">0</span></div>
    <div>$BCOSMO: <span id="balanceBCOSMO">0</span></div>
  </div>

  <!-- Menú -->
  <div id="menu">
    <div class="button" id="shopBtn">Tienda</div>
    <div class="button" id="rankBtn">Ranking</div>
  </div>

  <!-- Panel Tienda -->
  <div id="shopPanel" class="panel">
    <h2>Tienda</h2>
    <div class="button" id="buyMagnet">Comprar Imán</div>
    <div class="button" id="buyShield">Comprar Escudo</div>
    <div class="button" id="closeShop">Cerrar</div>
  </div>

  <!-- Panel Ranking -->
  <div id="rankPanel" class="panel">
    <h2>Ranking</h2>
    <ul id="rankingList"></ul>
    <div class="button" id="closeRank">Cerrar</div>
  </div>

  <!-- Game Over -->
  <div id="gameOverScreen">
    <h1>Game Over</h1>
    <p>Tu puntaje: <span id="finalScore">0</span></p>
    <label for="playerName">Nombre:</label>
    <input type="text" id="playerName" maxlength="12" />
    <div class="button" id="saveScore">Guardar</div>
    <div class="button" id="restartBtn">Reiniciar</div>
  </div>

  <script>
    // Variables globales
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    let assets = {}, sounds = {};
    let gameStarted = false, gameOver = false;
    let coinCount = 0, score = 0, highScore = 0, shieldCount = 0;
    let cdogeBalance = 0, bcosmoBalance = 0;
    let player = { x: 100, y: 300, vy: 0, w: 50, h: 50, isMagnet: false, isShield: false };
    let obstacles = [], coinsArr = [], blackholes = [], backgrounds = [];
    let backgroundIndex = 0, bgMusic;
    const GRAVITY = 0.5, SPAWN_INTERVAL = 1500;
    let lastSpawn = 0;

    // Configuración Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDaM9HtMtTlJXc-V4HfsZ7bbC__ZPe9zIk",
      authDomain: "cosmodogelive.firebaseapp.com",
      projectId: "cosmodogelive",
      storageBucket: "cosmodogelive.appspot.com",
      messagingSenderId: "648227069914",
      appId: "1:648227069914:web:3ef7ac8da4ab52c30deae3"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Carga de assets
    const imageList = ['fondo1.png','fondo2.png','doge.png','obstacle.png','coin.png','magnetAura.png','shieldAura.png','blackhole.png'];
    const soundList = ['jump.mp3','coin.mp3','hit.mp3','bgMusic.mp3'];
    let loadedCount = 0, totalAssets = imageList.length + soundList.length;

    function loadAssets() {
      imageList.forEach(src => {
        const img = new Image(); img.src = 'assets/' + src;
        img.onload = assetLoaded; assets[src] = img;
      });
      soundList.forEach(src => {
        const aud = new Audio('assets/' + src);
        aud.onloadeddata = assetLoaded; sounds[src] = aud;
      });
    }
    function assetLoaded() {
      if (++loadedCount === totalAssets) init();
    }

    // Inicialización
    function init() {
      document.getElementById('preloader').style.display = 'none';
      document.getElementById('startScreen').style.display = 'flex';
      backgrounds = [assets['fondo1.png'], assets['fondo2.png']];
      bgMusic = sounds['bgMusic.mp3']; bgMusic.loop = true;
      loadHighScore(); loadLocal(); updateWalletBtn(); drawLogoAnimation();
    }

    // Animación logo
    function drawLogoAnimation() {
      const lc = document.getElementById('logoCanvas'), lctx = lc.getContext('2d');
      let ang = 0;
      function anim() {
        lctx.clearRect(0, 0, lc.width, lc.height);
        lctx.save(); lctx.translate(lc.width/2, lc.height/2); lctx.rotate(ang);
        lctx.drawImage(assets['doge.png'], -50, -50, 100, 100);
        lctx.restore(); ang += 0.01;
        if (!gameStarted) requestAnimationFrame(anim);
      }
      anim();
    }

    // Eventos UI
    document.getElementById('startButton').addEventListener('click', ()=> {
      document.getElementById('startScreen').style.display = 'none';
      startGame();
    });
    document.getElementById('connectWalletBtn').addEventListener('click', toggleWalletConnection);

    // Iniciar juego
    function startGame() {
      gameStarted = true; gameOver = false;
      coinCount = 0; score = 0; shieldCount = 0;
      player.y = 300; player.vy = 0;
      obstacles = []; coinsArr = []; blackholes = [];
      document.getElementById('hud').style.display = 'flex';
      document.getElementById('menu').style.display = 'flex';
      playBgMusic(); lastSpawn = Date.now();
      requestAnimationFrame(gameLoop);
    }

    // Música
    function playBgMusic() { if (bgMusic) bgMusic.play().catch(()=>{}); }
    function stopBgMusic() { if (bgMusic) bgMusic.pause(); }

    // Bucle principal
    function gameLoop() {
      const now = Date.now(); update(now); draw();
      if (!gameOver) requestAnimationFrame(gameLoop);
    }
    function update(now) {
      player.vy += GRAVITY; player.y += player.vy;
      if (player.y + player.h > canvas.height) endGame();
      if (now - lastSpawn > SPAWN_INTERVAL) {
        spawnObstacle(); spawnCoin(); if (Math.random() < 0.3) spawnBlackhole();
        lastSpawn = now;
      }
      obstacles.forEach(o => { o.x -= o.speed; if (collide(o, player)) endGame(); });
      coinsArr = coinsArr.filter(c => { c.x -= c.speed; if (collide(c, player)) { collectCoin(c); return false; } return c.x + c.size > 0; });
      blackholes.forEach(b => { b.x -= b.speed; applyBlackholeAttraction(b); if (collide(b, player)) endGameSpecial(); });
      document.getElementById('coinCount').innerText = coinCount;
      document.getElementById('score').innerText = score;
    }
    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(backgrounds[backgroundIndex % backgrounds.length], 0, 0, canvas.width, canvas.height);
      // Jugador
      ctx.drawImage(assets['doge.png'], player.x, player.y, player.w, player.h);
      if (player.isShield) ctx.drawImage(assets['shieldAura.png'], player.x-10, player.y-10, player.w+20, player.h+20);
      if (player.isMagnet) ctx.drawImage(assets['magnetAura.png'], player.x-20, player.y-20, player.w+40, player.h+40);
      // Obstáculos, monedas, agujeros
      obstacles.forEach(o => ctx.drawImage(assets['obstacle.png'], o.x, o.y, o.w, o.h));
      coinsArr.forEach(c => ctx.drawImage(assets['coin.png'], c.x, c.y, c.size, c.size));
      blackholes.forEach(b => ctx.drawImage(assets['blackhole.png'], b.x, b.y, b.size, b.size));
    }

    // Spawn entidades
    function spawnObstacle() { obstacles.push({ x: canvas.width, y: Math.random() * (canvas.height - 100), w: 50, h: 50, speed: 3 }); }
    function spawnCoin()     { coinsArr.push({ x: canvas.width, y: Math.random() * (canvas.height - 100), size: 30, speed: 3 }); }
    function spawnBlackhole(){ blackholes.push({ x: canvas.width, y: Math.random() * (canvas.height - 150), size: 80, speed: 2 }); }

    // Colisiones y recolección
    function collide(a,b){ return a.x < b.x + b.w && a.x + (a.w||a.size) > b.x && a.y < b.y + b.h && a.y + (a.h||a.size) > b.y; }
    function collectCoin(c){ coinCount++; score++; sounds['coin.mp3'].play(); backgroundIndex++; loadRealTokenBalance(); }

    // Atracción de agujero negro
    function applyBlackholeAttraction(b){
      coinsArr.forEach(c => { const dx = b.x - c.x, dy = b.y - c.y, dist = Math.hypot(dx, dy);
        if (dist < 200) { c.x += dx * 0.01; c.y += dy * 0.01; }
      });
      obstacles.forEach(o => { const dx = b.x - o.x, dy = b.y - o.y, dist = Math.hypot(dx, dy);
        if (dist < 200) { o.x += dx * 0.01; o.y += dy * 0.01; }
      });
    }

    // Fin de juego
    function endGame() { gameOver = true; stopBgMusic(); showGameOver(); }
    function endGameSpecial() { gameOver = true; stopBgMusic(); showGameOver(); }

    // UI Game Over
    function showGameOver(){
      document.getElementById('finalScore').innerText = score;
      document.getElementById('gameOverScreen').style.display = 'flex';
      saveLocal();
    }
    document.getElementById('restartBtn').addEventListener('click', ()=>{ document.getElementById('gameOverScreen').style.display = 'none'; startGame(); });
    document.getElementById('saveScore').addEventListener('click', saveToFirestore);

    // LocalStorage
    function saveLocal(){
      localStorage.setItem('highScore', Math.max(score, highScore));
      localStorage.setItem('coins', coinCount);
      localStorage.setItem('shield', shieldCount);
    }
    function loadHighScore(){ highScore = parseInt(localStorage.getItem('highScore')) || 0; document.getElementById('highScore').innerText = highScore; }
    function loadLocal(){ coinCount = parseInt(localStorage.getItem('coins')) || 0; shieldCount = parseInt(localStorage.getItem('shield')) || 0; document.getElementById('coinCount').innerText = coinCount; document.getElementById('shieldCount').innerText = shieldCount; }

    // Firebase Ranking
    function saveToFirestore(){ const name = document.getElementById('playerName').value || 'Anon';
      db.collection('scores').add({ name, score, date: new Date() }).then(loadRanking);
    }
    function loadRanking(){
      db.collection('scores').orderBy('score','desc').limit(10).get().then(snap => {
        const list = document.getElementById('rankingList'); list.innerHTML = '';
        snap.forEach(doc => { const d = doc.data(); list.innerHTML += `<li>${d.name}: ${d.score}</li>`; });
      });
    }

    // Menús y tienda
    document.getElementById('shopBtn').onclick = () => document.getElementById('shopPanel').style.display = 'block';
    document.getElementById('closeShop').onclick = () => document.getElementById('shopPanel').style.display = 'none';
    document.getElementById('rankBtn').onclick = () => { document.getElementById('rankPanel').style.display = 'block'; loadRanking(); };
    document.getElementById('closeRank').onclick = () => document.getElementById('rankPanel').style.display = 'none';
    document.getElementById('buyShield').onclick = () => {
      if (coinCount >= 10) { coinCount -= 10; shieldCount++; player.isShield = true; sounds['coin.mp3'].play(); setTimeout(() => { player.isShield = false; }, 10000); }
    };
    document.getElementById('buyMagnet').onclick = () => {
      if (cdogeBalance >= 1 || bcosmoBalance >= 1) { player.isMagnet = true; sounds['coin.mp3'].play(); setTimeout(() => { player.isMagnet = false; }, 15000); }
    };

    // Control jugador
    document.addEventListener('keydown', e => { if (e.code === 'Space') jump(); });
    document.addEventListener('click', jump);
    function jump(){ if (gameStarted && !gameOver){ player.vy = -10; sounds['jump.mp3'].play(); } }

    // Wallet
    async function toggleWalletConnection(){
      if (window.solana && solana.isPhantom) {
        try { const resp = await solana.connect(); bcosmoBalance = await getPhantomBalance(resp.publicKey); updateBalances(); }
        catch {}
      } else if (window.ethereum) {
        try {
          await ethereum.request({ method: 'eth_requestAccounts' });
          const provider = new ethers.providers.Web3Provider(window.ethereum);
          const signer = provider.getSigner();
          const address = await signer.getAddress();
          cdogeBalance = await getCDogeBalance(provider, address);
          updateBalances();
        } catch {}
      }
      updateWalletBtn();
    }
    function updateWalletBtn(){
      const btn = document.getElementById('connectWalletBtn');
      if (cdogeBalance || bcosmoBalance) {
        btn.innerText = 'Cerrar Wallet'; btn.onclick = disconnect;
      } else {
        btn.innerText = 'Conectar Wallet'; btn.onclick = toggleWalletConnection;
      }
    }
    function disconnect(){ cdogeBalance = 0; bcosmoBalance = 0; updateBalances(); updateWalletBtn(); }
    function updateBalances(){ document.getElementById('balanceCDOGE').innerText = cdogeBalance; document.getElementById('balanceBCOSMO').innerText = bcosmoBalance; }
    async function getCDogeBalance(provider, address){
      const contract = new ethers.Contract('0x5dE25281305992d3552a45A3D8ccA7BdfB4AcD3A', ['function balanceOf(address) view returns(uint256)'], provider);
      const bal = await contract.balanceOf(address);
      return parseFloat(ethers.utils.formatUnits(bal, 18));
    }
    async function getPhantomBalance(pubKey){
      const connection = new solanaWeb3.Connection(solanaWeb3.clusterApiUrl('mainnet-beta'));
      const balance = await connection.getBalance(pubKey);
      return balance / solanaWeb3.LAMPORTS_PER_SOL;
    }
    function loadRealTokenBalance(){ updateBalances(); }

    // Iniciar precarga
    loadAssets();
  </script>
</body>
</html>
