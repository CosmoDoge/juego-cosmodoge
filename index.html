<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CosmoDoge Flotante üöÄ</title>

  <!-- Firebase & Firestore -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import {
      getFirestore, collection, query, orderBy, limit, getDocs, addDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDaM9HtMtTlJXc-V4HfsZ7bbC__ZPe9zIk",
      authDomain: "cosmodogelive.firebaseapp.com",
      projectId: "cosmodogelive",
      storageBucket: "cosmodogelive.appspot.com",
      messagingSenderId: "648227069914",
      appId: "1:648227069914:web:3ef7ac8da4ab52c30deae3"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    window.guardarJugadorAutomatic = async (nombre, puntaje, monedas) => {
      try {
        await addDoc(collection(db, "jugadores"), {
          nombre, puntaje, monedas, fecha: serverTimestamp()
        });
      } catch (e) { console.error("Error guardando en Firestore:", e); }
    };

    window.mostrarTopRanking = async () => {
      const lista = document.getElementById("topRanking");
      try {
        const snap = await getDocs(
          query(collection(db, "jugadores"), orderBy("puntaje","desc"), limit(5))
        );
        let html = "<h2>üèÜ Top 5 CosmoDoge</h2><ul style='list-style:none;padding:0;'>";
        snap.forEach((doc,i) => {
          const d = doc.data();
          html += `<li>#${i+1} <strong>${d.nombre}</strong> ‚Äì ${d.puntaje} pts ‚Äì ${d.monedas} ü™ô</li>`;
        });
        lista.innerHTML = html+"</ul>";
      } catch(e) {
        console.error("Error cargando ranking:", e);
        lista.innerHTML = "<p style='color:red;'>No se pudo cargar el ranking.</p>";
      }
    };
  </script>

  <!-- On-chain libraries -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.41.0/lib/index.iife.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@solana/spl-token@0.3.5/lib/index.iife.min.js"></script>

  <style>
    *{margin:0;padding:0;box-sizing:border-box;}
    html,body{width:100%;height:100%;overflow:hidden;background:black;font-family:Arial,sans-serif;}
    canvas{display:block;margin:auto;max-width:100vw;max-height:100vh;}

    .hud{position:absolute;color:white;text-shadow:2px 2px 5px #000;z-index:1000;}
    #scoreDisplay{top:10px;left:10px;font-size:18px;}
    #coinDisplay{top:40px;left:10px;font-size:18px;}
    #highScoreDisplay{top:70px;left:10px;font-size:18px;}
    #contadorCDOGE{top:100px;left:10px;font:18px Orbitron;color:#0ff;}
    #contadorBCOSMO{top:130px;left:10px;font:18px Orbitron;color:#faa;}
    #shieldDisplay{top:160px;left:10px;font:18px Orbitron;color:#f90;display:none;}
    #nombreJugador{top:10px;left:50%;transform:translateX(-50%);font:18px Orbitron;color:#0ff;}
    #imanContador{position:absolute;top:190px;right:20px;background:rgba(0,0,0,0.75);padding:8px;border-radius:10px;font:16px Orbitron;color:#0ff;display:none;z-index:1000;}

    .fixed{position:fixed;z-index:10000;transition:opacity .3s;}
    .hiddenUI{opacity:0;}
    #conectarWalletBtn{top:20px;right:20px;background:#0ff;color:#000;border:none;border-radius:12px;padding:10px 20px;font:16px Orbitron;cursor:pointer;}
    #menuPrincipal{top:70px;right:20px;display:flex;flex-direction:column;gap:10px;}

    #tiendaCDOGE,#rankingPanel{position:fixed;background:rgba(0,0,0,0.85);padding:15px;border-radius:15px;box-shadow:0 0 15px #0ff;font:14px Orbitron;color:#fff;z-index:10001;display:none;}
    #tiendaCDOGE{bottom:20px;left:20px;width:320px;border:2px solid #0ff;}
    #rankingPanel{top:200px;left:50%;transform:translateX(-50%);}

    .btn{padding:1rem 2rem;background:#0ff;border:none;border-radius:10px;color:#000;font-size:1.2rem;font-weight:bold;cursor:pointer;transition:transform .2s,box-shadow .2s;}
    .btn:hover{transform:scale(1.05);box-shadow:0 0 10px #0ff;}

    #pantallaCarga,#startScreen,#newRecordMessage,#gameOverScreen{
      position:fixed;top:0;left:0;width:100vw;height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(0,0,0,0.85);color:white;font:Orbitron;z-index:9999;text-align:center;
    }
    #pantallaCarga .spinner{width:60px;height:60px;border:6px solid #ffffff22;border-top:6px solid #0ff;border-radius:50%;animation:spin 1s linear infinite;}
    @keyframes spin{to{transform:rotate(360deg);}}
    #gameOverScreen{display:none;opacity:0;transition:opacity 1s;}
    #gameOverScreen.show{display:flex;opacity:1;}
    #reiniciarBtn{margin-top:20px;padding:12px 24px;background:#0ff;color:#000;border:none;border-radius:12px;font-size:18px;cursor:pointer;display:none;}
    #playerNameForm{display:none;flex-direction:column;align-items:center;background:rgba(0,0,0,0.85);padding:20px;border-radius:10px;z-index:10000;}
  </style>
</head>
<body>
  <div id="pantallaCarga">
    <div class="spinner"></div>
    <p style="margin-top:20px;color:white;font-size:20px;">Iniciando viaje intergal√°ctico...</p>
  </div>

  <button id="conectarWalletBtn" class="fixed">üîó Conectar Wallet</button>
  <div id="balanceCDOGE"></div>
  <div id="balanceBCOSMO"></div>
  <div id="scoreDisplay" class="hud">üöÄ x 0</div>
  <div id="coinDisplay" class="hud">üí∞ x 0</div>
  <div id="highScoreDisplay" class="hud">üîù M√°x: 0</div>
  <div id="contadorCDOGE" class="hud">üí∞ CDOGE: 0</div>
  <div id="contadorBCOSMO" class="hud">üêï BCOSMO: 0</div>
  <div id="shieldDisplay" class="hud"></div>
  <div id="nombreJugador" class="hud"></div>
  <div id="imanContador"></div>

  <div id="menuPrincipal" class="fixed">
    <button id="btnTienda" class="btn">üõí Tienda</button>
    <button id="btnRanking" class="btn">üèÜ Ranking</button>
  </div>

  <div id="tiendaCDOGE">
    <h3 style="color:#0ff;">üõí Tienda CosmoDoge</h3>
    <div style="margin-bottom:15px;padding:10px;background:#111;border:1px solid #0ff;border-radius:10px;">
      <p style="color:#0ff;">üß≤ Im√°n Espacial (CDOGE)</p>
      <p style="color:#bbb;">Atrae monedas 1h</p>
      <button id="comprarImanCDOGE" class="btn">Comprar 1 500 $CDOGE</button>
    </div>
    <div style="margin-bottom:15px;padding:10px;background:#111;border:1px solid #0ff;border-radius:10px;">
      <p style="color:#0ff;">üß≤ Im√°n Espacial (BCOSMO)</p>
      <p style="color:#bbb;">Atrae monedas 1h</p>
      <button id="comprarImanBCOSMO" class="btn">Comprar 2 500 $BCOSMO</button>
    </div>
    <div style="padding:10px;background:#111;border:1px solid #faa;border-radius:10px;">
      <p style="color:#faa;">üõ°Ô∏è Escudo Protector</p>
      <p style="color:#bbb;">Inmune 13s</p>
      <button id="comprarEscudo" class="btn">Comprar 1 000 ü™ô</button>
    </div>
  </div>

  <canvas id="gameCanvas" width="480" height="640"></canvas>

  <div id="startScreen" style="display:none;">
    <h1>üöÄ CosmoDoge Flotante</h1>
    <button id="startButton" class="btn">¬°Comenzar!</button>
  </div>
  <div id="gameOverScreen">
    <h1>üö® GAME OVER üö®</h1>
    <p>Puntaje: <span id="finalScore">0</span></p>
    <button id="reiniciarBtn" class="btn">Reiniciar</button>
  </div>
  <div id="newRecordMessage" style="display:none;">
    <h1>üåü ¬°Nuevo r√©cord gal√°ctico!</h1>
    <p>üèÜ ¬°Has superado todos los l√≠mites!</p>
  </div>
  <div id="playerNameForm">
    <input type="text" id="playerName" placeholder="Tu nombre gal√°ctico"
           style="padding:10px;border:none;border-radius:8px;margin-bottom:10px;" />
    <button id="saveScoreButton" class="btn">Guardar Puntaje</button>
  </div>
  <div id="rankingPanel">
    <div id="topRanking"></div>
    <button id="closeRanking" class="btn">Cerrar</button>
  </div>

  <script>
    // Preload assets
    const assets = [
      "cosmodoge-cohete-juego.png","coin-cosmodoge.png","moneda-cosmodoge.png","moneda-bcosmo.png",
      "fondo-cosmodoge-v2.png","fondo-cosmodoge-v3.png","fondo-cosmodoge-v4.png",
      "obstaculo-estelar.png","obstaculo-explosion.png","obstaculo-explosion-aire.png",
      "jump.mp3","coin.mp3","boom.mp3","record.mp3","sonido-moneda-cdoge.mp3",
      "sonido-moneda-bcosmo.mp3","music-cosmodoge-theme.mp3"
    ];
    assets.forEach(u => {
      if (u.endsWith(".png")) new Image().src = u;
      else new Audio(u);
    });

    // UI & bootstrap
    window.addEventListener("DOMContentLoaded", () => {
      setTimeout(() => {
        document.getElementById("pantallaCarga").style.display = "none";
        document.getElementById("startScreen").style.display = "flex";
      }, 3000);

      // Buttons
      document.getElementById("btnTienda").onclick = () =>
        document.getElementById("tiendaCDOGE").classList.toggle("hiddenUI");
      document.getElementById("btnRanking").onclick = () => {
        const r = document.getElementById("rankingPanel");
        if (r.style.display === "block") r.style.display = "none";
        else { mostrarTopRanking(); r.style.display = "block"; }
      };
      document.getElementById("comprarImanCDOGE").onclick = comprarImanCDOGE;
      document.getElementById("comprarImanBCOSMO").onclick = comprarImanBCOSMO;
      document.getElementById("comprarEscudo").onclick    = buyShield;
      document.getElementById("closeRanking").onclick     = () =>
        document.getElementById("rankingPanel").style.display = "none";
      document.getElementById("conectarWalletBtn").onclick= mostrarSelectorWallet;
      document.getElementById("reiniciarBtn").onclick     = () => location.reload();
      document.getElementById("saveScoreButton").onclick  = () => {
        const n = document.getElementById("playerName").value.trim();
        if (!n) return alert("Ingresa tu nombre gal√°ctico");
        localStorage.setItem("cosmodogeliveUserName", n);
        document.getElementById("playerNameForm").style.display = "none";
        guardarJugadorAutomatic(n, score, coins).then(mostrarTopRanking);
      };

      document.getElementById("startButton").onclick = iniciarJuego;
      canvas.addEventListener("touchstart", e => {
        e.preventDefault();
        if (!gameStarted) iniciarJuego();
        else if (!isGameOver) { doge.v = jump; play(sndJump); }
      });
      document.addEventListener("keydown", e => {
        if (e.code === "Space" && gameStarted && !isGameOver) {
          doge.v = jump; play(sndJump);
        }
      });
    });

    // --- Game Logic Integration ---
    const canvas = document.getElementById("gameCanvas"), ctx = canvas.getContext("2d");
    let score=0, coins=parseInt(localStorage.getItem("cdogeCoins"))||0,
        highScore=parseInt(localStorage.getItem("cdogeFloatHighScore"))||0,
        totalCDOGE=parseInt(localStorage.getItem("cdogeTotalCoins"))||0,
        totalBCOSMO=parseInt(localStorage.getItem("bcosmoTotalCoins"))||0,
        gameStarted=false, isGameOver=false,
        timeElapsed=0, lastScoreTime=0, lastFondoChange=0, lastObs=Date.now(),
        gravityLevels=[0.5,0.6,0.8,1.0], gravity=gravityLevels[0], jump=-10;
    let coinsArr=[], obsArr=[], cdogeArr=[], bcosmoArr=[], turnoCoins=true;
    const ubicaciones=[{x:80,y:100},{x:400,y:80},{x:240,y:200},{x:360,y:520},{x:100,y:490}],
          fondos=["fondo-cosmodoge-v2.png","fondo-cosmodoge-v3.png","fondo-cosmodoge-v4.png"];
    let fi=0; const fondoImg=new Image(); fondoImg.src=fondos[0];
    const doge={x:80,y:200,w:50,h:50,v:0,img:new Image()}; doge.img.src="cosmodoge-cohete-juego.png";
    const coinImg=new Image(); coinImg.src="coin-cosmodoge.png";
    const obsImgs=["obstaculo-estelar.png","obstaculo-explosion.png","obstaculo-explosion-aire.png"];
    const cdogeImg=new Image(); cdogeImg.src="moneda-cosmodoge.png";
    const bcosmoImg=new Image(); bcosmoImg.src="moneda-bcosmo.png";
    const sndJump=new Audio("jump.mp3"), sndCoin=new Audio("coin.mp3"),
          sndBoom=new Audio("boom.mp3"), sndRecord=new Audio("record.mp3"),
          sndCdoge=new Audio("sonido-moneda-cdoge.mp3"),
          sndBcosmo=new Audio("sonido-moneda-bcosmo.mp3"),
          music=new Audio("music-cosmodoge-theme.mp3");
    music.loop=true; music.volume=0.3;
    const CDOGE_CON="0x5dE25281305992d3552a45A3D8ccA7BdfB4AcD3A",
          ERC20_ABI=["function balanceOf(address) view returns(uint256)","function decimals() view returns(uint8)","function transfer(address,uint256) returns(bool)"],
          CDOGE_REC="0x1980dCdDA07071970dEAa69c975F590976Ee667D3A".toLowerCase(),
          MINT="2etLM91LBaxbQ1y3jnzQw8EXKNHAKcXJsHMJJ69opump",
          RCV="A6dnVgGaS1scC2m6hmPdK15D5gs5vDsHS8PEq3xtJKNx";
    function play(s){ s.currentTime=0; s.play().catch(()=>{}); }
    function showMsg(txt,x,y){
      const d=document.createElement("div");
      Object.assign(d.style,{position:"absolute",left:`${x}px`,top:`${y}px`,color:"#0ff",font:"18px Orbitron",zIndex:10000,transition:"all 1.5s"});
      d.textContent=txt; document.body.appendChild(d);
      setTimeout(()=>{d.style.opacity=0;d.style.transform="translateY(-40px)";},100);
      setTimeout(()=>d.remove(),1600);
    }
    function updCDOGE(){ document.getElementById("contadorCDOGE").textContent=`üí∞ CDOGE: ${totalCDOGE}`; }
    function updBCOSMO(){ document.getElementById("contadorBCOSMO").textContent=`üêï BCOSMO: ${totalBCOSMO}`; }
    function updDiff(sec){ gravity = sec>=75?gravityLevels[3]:sec>=45?gravityLevels[2]:sec>=30?gravityLevels[1]:gravityLevels[0]; }
    function drawAura(o){
      const exp=+localStorage.getItem("imanExpiracion")||0;
      if(Date.now()<exp){
        ctx.beginPath();ctx.arc(o.x+o.w/2,o.y+o.h/2,o.w*0.8,0,Math.PI*2);
        ctx.strokeStyle='#00ffff88';ctx.lineWidth=4;ctx.stroke();
      }
    }
    function drawDoge(){ctx.drawImage(doge.img,doge.x,doge.y,doge.w,doge.h);drawAura(doge);}
    function actIman(){const exp=Date.now()+3600000;localStorage.setItem("imanExpiracion",exp);showMsg("üß≤ Im√°n activo 1h",canvas.width/2,100);checkIman();}
    function checkIman(){
      const id=setInterval(()=>{
        const exp=+localStorage.getItem("imanExpiracion")||0,now=Date.now(),d=document.getElementById("imanContador");
        if(now<exp){
          const ms=exp-now,m=Math.floor(ms/60000),s=Math.floor((ms%60000)/1000);
          d.textContent=`üß≤ Im√°n: ${m}:${s<10?"0":""}${s}`;d.style.display="block";
        } else {d.style.display="none";localStorage.removeItem("imanExpiracion");clearInterval(id);showMsg("‚è±Ô∏è Im√°n expirado",canvas.width/2,100);}
      },250);
    }
    function buyShield(){
      if(coins<1000) return alert("No tienes suficientes ü™ô");
      coins-=1000;localStorage.setItem("cdogeCoins",coins);
      document.getElementById("coinDisplay").textContent=`üí∞ x ${coins}`;
      const exp=Date.now()+13000;localStorage.setItem("shieldExpiration",exp);showMsg("üõ°Ô∏è Escudo activo 13s",canvas.width/2,140);checkShield();
    }
    function checkShield(){
      const id=setInterval(()=>{
        const exp=+localStorage.getItem("shieldExpiration")||0,now=Date.now(),d=document.getElementById("shieldDisplay");
        if(now<exp){const s=Math.ceil((exp-now)/1000);d.textContent=`üõ°Ô∏è Escudo: ${s}s`;d.style.display="block";}
        else{d.style.display="none";localStorage.removeItem("shieldExpiration");clearInterval(id);showMsg("üõ°Ô∏è Escudo expirado",canvas.width/2,140);}
      },250);
    }
    function handleCollision(){
      const exp=+localStorage.getItem("shieldExpiration")||0;
      if(Date.now()<exp){showMsg("üõ°Ô∏è Bloqueado!",canvas.width/2,160);return true;}
      return false;
    }
    function spawnCoinGroup(){for(let i=0;i<Math.floor(Math.random()*6)+5;i++)coinsArr.push({x:canvas.width+i*40,y:Math.random()*(canvas.height-100),w:30,h:30,s:2});}
    function drawCoins(){
      for(let i=coinsArr.length-1;i>=0;i--){
        const c=coinsArr[i],exp=+localStorage.getItem("imanExpiracion")||0;
        if(Date.now()<exp){
          const dx=(c.x+15)-(doge.x+doge.w/2),dy=(c.y+15)-(doge.y+doge.h/2),dist=Math.hypot(dx,dy);
          if(dist<200){const f=1-dist/200;c.x-=dx*0.05*f;c.y-=dy*0.05*f;}
        }
        c.x-=c.s;ctx.drawImage(coinImg,c.x,c.y,c.w,c.h);
        if(doge.x<c.x+c.w&&doge.x+doge.w>c.x&&doge.y<c.y+c.h&&doge.y+doge.h>c.y){
          coins++;localStorage.setItem("cdogeCoins",coins);
          document.getElementById("coinDisplay").textContent=`üí∞ x ${coins}`;play(sndCoin);coinsArr.splice(i,1);
        }
      }
    }
    function spawnObstacle(){
      const img=new Image();img.src=obsImgs[Math.floor(Math.random()*obsImgs.length)];
      obsArr.push({x:canvas.width,y:Math.random()*(canvas.height-50),w:50,h:50,sX:2+Math.random()*2,sY:0.5+Math.random()*1.5,img});
    }
    function drawObstacles(){
      obsArr.forEach((o,i)=>{o.x-=o.sX;o.y+=(o.y<doge.y?o.sY:-o.sY);ctx.drawImage(o.img,o.x,o.y,o.w,o.h);
        if(doge.x<o.x+o.w&&doge.x+doge.w>o.x&&doge.y<o.y+o.h&&doge.y+doge.h>o.y){if(!handleCollision())gameOver();}
      });obsArr=obsArr.filter(o=>o.x+o.w>0);
    }
    function spawnGroupCDOGE(){for(let i=0;i<3;i++){const p=ubicaciones[Math.floor(Math.random()*ubicaciones.length)];cdogeArr.push({x:p.x,y:p.y,w:32,h:32,got:false});}}
    function spawnGroupBCOSMO(){for(let i=0;i<3;i++){const p=ubicaciones[Math.floor(Math.random()*ubicaciones.length)];bcosmoArr.push({x:p.x,y:p.y,w:32,h:32,got:false});}}
    setInterval(()=>{if(turnoCoins)spawnGroupCDOGE();else spawnGroupBCOSMO();turnoCoins=!turnoCoins;},20000);
    function drawCDOGE(){cdogeArr.forEach(m=>!m.got&&ctx.drawImage(cdogeImg,m.x,m.y,m.w,m.h));}
    function collectCDOGE(){
      cdogeArr.forEach(m=>{if(!m.got){
        const dx=(m.x+16)-(doge.x+doge.w/2),dy=(m.y+16)-(doge.y+doge.h/2),dist=Math.hypot(dx,dy),exp=+localStorage.getItem("imanExpiracion")||0;
        if(Date.now()<exp&&dist<200){const f=1-dist/200;m.x-=dx*0.05*f;m.y-=dy*0.05*f;}
        if(dist<20){m.got=true;totalCDOGE+=50;localStorage.setItem("cdogeTotalCoins",totalCDOGE);play(sndCdoge);showMsg("+50 CDOGE",m.x,m.y);updCDOGE();}
      }});}

    function drawBCOSMO(){bcosmoArr.forEach(m=>!m.got&&ctx.drawImage(bcosmoImg,m.x,m.y,m.w,m.h));}
    function collectBCOSMO(){
      bcosmoArr.forEach(m=>{if(!m.got){
        const dx=(m.x+16)-(doge.x+doge.w/2),dy=(m.y+16)-(doge.y+doge.h/2),dist=Math.hypot(dx,dy),exp=+localStorage.getItem("imanExpiracion")||0;
        if(Date.now()<exp&&dist<200){const f=1-dist/200;m.x-=dx*0.05*f;m.y-=dy*0.05*f;}
        if(dist<20){m.got=true;totalBCOSMO+=50;localStorage.setItem("bcosmoTotalCoins",totalBCOSMO);play(sndBcosmo);showMsg("+50 BCOSMO",m.x,m.y);updBCOSMO();}
      }});}

    function drawBackground(){ctx.drawImage(fondoImg,0,0,canvas.width,canvas.height);}

    let lastTime=0;
    function loop(ts){
      if(isGameOver) return;
      if(!lastTime) lastTime=ts;
      const dt=ts-lastTime; lastTime=ts;
      ctx.clearRect(0,0,canvas.width,canvas.height);
      drawBackground();
      doge.v+=gravity*(dt/16); doge.y+=doge.v*(dt/16);
      if(doge.y+doge.h>=canvas.height||doge.y<=0){if(!handleCollision())return gameOver();doge.y=canvas.height/2;}
      drawDoge(); drawCoins(); drawObstacles(); drawCDOGE(); collectCDOGE(); drawBCOSMO(); collectBCOSMO();
      timeElapsed+=dt;const sec=timeElapsed/1000;
      if(sec-lastScoreTime>=5){score++;lastScoreTime=sec;document.getElementById("scoreDisplay").textContent=`üöÄ x ${score}`;}
      if(sec-lastFondoChange>=30){fi=(fi+1)%fondos.length;fondoImg.src=fondos[fi];lastFondoChange=sec;}
      if(Math.floor(timeElapsed/16)%150===0) spawnCoinGroup();
      const now=Date.now(),interval=timeElapsed/16>=3600?1000:timeElapsed/16>=1800?2000:3000;
      if(now-lastObs>=interval){spawnObstacle();lastObs=now;}
      updDiff(sec);
      requestAnimationFrame(loop);
    }

    function gameOver(){
      isGameOver=true;music.pause();music.currentTime=0;
      document.getElementById("finalScore").textContent=score;
      const go=document.getElementById("gameOverScreen");
      go.style.display="flex";setTimeout(() => go.classList.add("show"),10);
      setTimeout(() => document.getElementById("reiniciarBtn").style.display="block",1500);
      if(score>highScore){
        localStorage.setItem("cdogeFloatHighScore",score);highScore=score;
        document.getElementById("highScoreDisplay").textContent=`üîù M√°x: ${highScore}`;
        document.getElementById("newRecordMessage").style.display="flex";play(sndRecord);
        const u=localStorage.getItem("cosmodogeliveUserName");
        if(!u) document.getElementById("playerNameForm").style.display="flex";
        else guardarJugadorAutomatic(u,score,coins).then(mostrarTopRanking);
      } else play(sndBoom);
    }

    function mostrarSelectorWallet(){
      const opt=prompt("Selecciona tu wallet:\n1 - MetaMask\n2 - Phantom");
      if(opt==="1") conectarMetaMask(); else if(opt==="2") conectarPhantom(); else alert("Opci√≥n inv√°lida");
    }
    async function conectarMetaMask(){
      try{
        if(!window.ethereum) return alert("Instala MetaMask");
        const acc=await ethereum.request({method:'eth_requestAccounts'}),acct=acc[0];
        document.getElementById("conectarWalletBtn").textContent=`üîó ${acct.slice(0,6)}‚Ä¶${acct.slice(-4)}`;
        const prov=new ethers.providers.Web3Provider(window.ethereum),c=new ethers.Contract(CDOGE_CON,ERC20_ABI,prov);
        const b=await c.balanceOf(acct),d=await c.decimals(),fmt=Number(b/10**d).toLocaleString();
        document.getElementById("balanceCDOGE").innerHTML=`üöÄ ${fmt} CDOGE`;document.getElementById("balanceCDOGE").style.display="block";
      } catch(e){console.error(e);alert("Error MetaMask");}
    }
    async function conectarPhantom(){
      try{
        const p=window.solana; if(!p||!p.isPhantom) throw new Error("Instala Phantom");
        const resp=await p.connect(),pub=resp.publicKey;
        showMsg(`üåê Phantom: ${pub.toString().slice(0,6)}‚Ä¶${pub.toString().slice(-4)}`,canvas.width/2,80);
        const conn=new solanaWeb3.Connection("https://api.mainnet-beta.solana.com","confirmed"),
              toks=await conn.getParsedTokenAccountsByOwner(pub,{programId:solanaWeb3.TOKEN_PROGRAM_ID});
        let bal=0; toks.value.forEach(({account})=>{const info=account.data.parsed.info;if(info.mint===MINT) bal=info.tokenAmount.uiAmount;});
        document.getElementById("balanceBCOSMO").innerHTML=`üêï ${bal||0} BCOSMO`;document.getElementById("balanceBCOSMO").style.display="block";
      } catch(e){console.error(e);alert(e.message);}
    }
    async function comprarImanCDOGE(){
      try{
        if(!window.ethereum) return alert("Instala MetaMask");
        const acc=await ethereum.request({method:'eth_requestAccounts'}),prov=new ethers.providers.Web3Provider(window.ethereum),
              signer=prov.getSigner(),c=new ethers.Contract(CDOGE_CON,ERC20_ABI,signer),d=await c.decimals(),
              amt=ethers.utils.parseUnits("1500",d),tx=await c.transfer(CDOGE_REC,amt);
        await tx.wait(); actIman();
      } catch(e){console.error(e);alert("Error comprando im√°n CDOGE");}
    }
    async function comprarImanBCOSMO(){
      try{
        const p=window.solana; if(!p||!p.isPhantom) throw new Error("Instala Phantom");
        const resp=await p.connect(),pub=resp.publicKey,conn=new solanaWeb3.Connection("https://api.mainnet-beta.solana.com","confirmed"),
              mintP=new solanaWeb3.PublicKey(MINT),recP=new solanaWeb3.PublicKey(RCV),
              mi=await conn.getParsedAccountInfo(mintP),dec=mi.value.data.parsed.info.decimals,
              sAcc=await splToken.getOrCreateAssociatedTokenAccount(conn,pub,mintP,pub),
              rAcc=await splToken.getOrCreateAssociatedTokenAccount(conn,pub,mintP,recP),
              amount=2500*10**dec,ix=splToken.createTransferCheckedInstruction(sAcc.address,mintP,rAcc.address,pub,amount,dec);
        let tx=new solanaWeb3.Transaction().add(ix);
        tx.feePayer=pub;tx.recentBlockhash=(await conn.getRecentBlockhash()).blockhash;
        const signed=await p.signTransaction(tx),sig=await conn.sendRawTransaction(signed.serialize());
        await conn.confirmTransaction(sig); actIman();
      } catch(e){console.error(e);alert("Error comprando im√°n BCOSMO");}
    }

    function iniciarJuego(){
      document.getElementById("startScreen").style.display="none";
      document.getElementById("conectarWalletBtn").classList.add("hiddenUI");
      document.getElementById("menuPrincipal").classList.add("hiddenUI");
      gameStarted=true; music.play(); requestAnimationFrame(loop);
    }
  </script>
</body>
</html>
