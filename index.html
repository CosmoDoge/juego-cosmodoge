<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>CosmoDoge Flotante 🚀</title>
  <!-- Ethers.js + Solana + Firebase -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script type="module">
    import { Connection, PublicKey, Transaction } from "https://cdn.jsdelivr.net/npm/@solana/web3.js@1.67.0/lib/index.iife.min.js";
    import { TOKEN_PROGRAM_ID, getAssociatedTokenAddress, createTransferCheckedInstruction } from "https://cdn.jsdelivr.net/npm/@solana/spl-token@0.3.5/lib/index.iife.min.js";
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp, query, orderBy, limit, getDocs }
      from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

    // --- FIREBASE ---
    const firebaseConfig = {
      apiKey: "AIzaSyDaM9HtMtTlJXc-V4HfsZ7bbC__ZPe9zIk",
      authDomain: "cosmodogelive.firebaseapp.com",
      projectId: "cosmodogelive",
      storageBucket: "cosmodogelive.appspot.com",
      messagingSenderId: "648227069914",
      appId: "1:648227069914:web:3ef7ac8da4ab52c30deae3"
    };
    initializeApp(firebaseConfig);
    const db = getFirestore();
    window.guardarJugadorAutomatic = async(u,s,c) => {
      try {
        await addDoc(collection(db,'jugadores'),
          { nombre:u, puntaje:s, monedas:c, fecha:serverTimestamp() });
      } catch(e){ alert("❌ Error guardando"); }
    };
    window.mostrarTopRanking = async() => {
      const panel = document.getElementById('rankingPanel');
      const p = document.getElementById('topRanking');
      try {
        const q = query(collection(db,'jugadores'), orderBy('puntaje','desc'), limit(5));
        const snap = await getDocs(q);
        let html = '<h2>🏆 Top 5</h2><ul style="list-style:none;padding:0">';
        snap.forEach((d,i)=>{ const x=d.data();
          html += `<li>#${i+1} ${x.nombre} - ${x.puntaje} pts - ${x.monedas} 🪙</li>`; });
        p.innerHTML = html + '</ul>';
        panel.style.display = 'block';  // show panel
      } catch {
        p.innerHTML = '<p style="color:red">Error</p>';
        panel.style.display = 'block';
      }
    };
  </script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    html,body{width:100%;height:100%;overflow:hidden;background:#000;color:#fff;font-family:Arial,sans-serif}
    canvas{display:block;margin:auto}
    #scoreDisplay,#coinDisplay,#highScoreDisplay{position:absolute;font-size:18px;text-shadow:2px 2px 5px #000}
    #scoreDisplay{top:10px;left:10px}#coinDisplay{top:40px;left:10px}#highScoreDisplay{top:70px;left:10px}
    #contadorCDOGE{position:absolute;top:100px;left:10px;color:#0f0;font-family:Orbitron}
    #contadorBCOSMO{position:absolute;top:130px;left:10px;color:#0ff;font-family:Orbitron}
    #imanContador{position:absolute;top:160px;left:10px;color:#0ff;font-family:Orbitron}
    #nombreJugador{position:absolute;top:10px;left:50%;transform:translateX(-50%);font-family:Orbitron;font-size:18px;color:#0ff;text-shadow:1px 1px 3px #000}
    .btn{padding:10px 20px;background:#0ff;border:none;border-radius:8px;cursor:pointer;font-family:Orbitron}
    .btn:hover{background:#0cc}
    /* Overlay animations */
    #startScreen,#gameOverScreen,#newRecordMessage{
      position:fixed;top:0;left:0;width:100vw;height:100vh;
      background:rgba(0,0,0,0.85);display:flex;flex-direction:column;
      align-items:center;justify-content:center;text-align:center;z-index:10;
      opacity:1;transition:opacity .5s ease, transform .5s ease;
      transform: scale(1);
    }
    #gameOverScreen{opacity:0;pointer-events:none;transform: scale(0.9)}
    #gameOverScreen.show{opacity:1;pointer-events:auto;transform: scale(1)}
    #playerNameForm{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
      background:rgba(0,0,0,0.9);padding:20px;border-radius:10px;display:none;z-index:11
    }
    #reanudarBtn{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
      padding:10px 20px;background:#0ff;border:none;border-radius:8px;cursor:pointer;z-index:12
    }
    #rankingPanel{position:fixed;top:10%;right:10px;background:rgba(0,0,0,0.85);
      padding:15px;border-radius:10px;display:none;z-index:11
    }
    #rankingPanel button{margin-top:10px}
    #pantallaCarga{position:fixed;top:0;left:0;width:100vw;height:100vh;
      background:#000;display:flex;align-items:center;justify-content:center;z-index:20
    }
    .spinner{width:60px;height:60px;border:6px solid #333;border-top:6px solid #0ff;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div id="pantallaCarga"><div class="spinner"></div></div>
  <button id="conectarWalletBtn" class="btn" style="position:fixed;top:20px;right:20px">🔗 Wallet</button>
  <div id="balanceCDOGE" style="display:none;position:fixed;top:60px;right:20px"></div>
  <div id="balanceBCOSMO" style="display:none;position:fixed;top:100px;right:20px"></div>
  <div id="nombreJugador"></div>
  <div id="menuPrincipal" style="position:fixed;top:140px;right:20px">
    <button onclick="toggleTienda()" class="btn">🛒 Tienda</button>
  </div>
  <div id="tiendaCDOGE" style="display:none;position:fixed;bottom:20px;left:20px;
       background:rgba(0,0,0,0.85);padding:15px;border:2px solid #0ff;border-radius:10px;z-index:5">
    <h3>🛒 Tienda</h3>
    <button id="comprarIman" class="btn">Imán 1,500 CDOGE</button><br><br>
    <button id="comprarImanBCOSMO" class="btn">Imán 2,500 BCOSMO</button>
  </div>
  <canvas id="gameCanvas" width="480" height="640"></canvas>
  <div id="scoreDisplay">🚀 0</div>
  <div id="coinDisplay">💰 0</div>
  <div id="highScoreDisplay">🔝 0</div>
  <div id="contadorCDOGE">💰 CDOGE: 0</div>
  <div id="contadorBCOSMO">🪐 BCOSMO: 0</div>
  <div id="imanContador">🧲 —:—</div>
  <div id="startScreen">
    <h1>🚀 Mantén a CosmoDoge flotando</h1>
    <button id="startButton" class="btn">¡Comenzar!</button>
  </div>
  <div id="gameOverScreen">
    <h1>🚨 GAME OVER 🚨</h1>
    <p>Puntaje: <span id="finalScore">0</span></p>
    <button id="reiniciarBtn" class="btn">Reiniciar</button>
  </div>
  <div id="newRecordMessage" style="display:none"><h1>🌟 ¡Nuevo Récord!</h1></div>
  <div id="playerNameForm">
    <input id="playerName" placeholder="Nombre galáctico"><br><br>
    <button id="saveScoreButton" class="btn">Guardar Puntaje</button>
  </div>
  <div id="rankingPanel">
    <div id="topRanking"></div>
    <button id="closeRankingBtn" class="btn">Cerrar Ranking</button>
  </div>
  <button id="reanudarBtn" class="btn">Reanudar Juego</button>

<script>
  // Init counters & UI
  let coins = parseInt(localStorage.getItem('cdogeCoins'))||0,
      bcosmo = parseInt(localStorage.getItem('bcosmoCount'))||0;
  document.getElementById('coinDisplay').textContent = `💰 ${coins}`;
  document.getElementById('contadorCDOGE').textContent = `💰 CDOGE: ${coins}`;
  document.getElementById('contadorBCOSMO').textContent = `🪐 BCOSMO: ${bcosmo}`;
  let savedName = localStorage.getItem('cosmodogeliveUserName');
  if(savedName) document.getElementById('nombreJugador').textContent = `🐶 ${savedName}`;

  // Canvas mobile & hide preloader
  const canvas = document.getElementById('gameCanvas'), ctx = canvas.getContext('2d');
  window.addEventListener('DOMContentLoaded', ()=>{
    if(/Mobi|Android/i.test(navigator.userAgent)){
      canvas.width = innerWidth; canvas.height = innerHeight;
    }
    document.getElementById('highScoreDisplay').textContent = `🔝 ${localStorage.getItem('cdogeFloatHighScore')||0}`;
    setTimeout(()=>document.getElementById('pantallaCarga').style.display='none',2000);
  });

  // Globals
  let gameStarted=false, isGameOver=false;
  let time=0, lastTime=0, lastObs=0, lastBg=0;
  let grav=0.5, highScore=parseInt(localStorage.getItem('cdogeFloatHighScore'))||0;
  let imActive=false;
  const doge={x:80,y:200,w:50,h:50,vel:0,img:new Image()};
  doge.img.src='cosmodoge-cohete-juego.png';
  const fondos=['fondo1.png','fondo2.png','fondo3.png'], bg=new Image(); bg.src=fondos[0]; let fIdx=0;
  const coinsArr=[], coinsBCOSMOArr=[], obstacles=[];
  const coinImg=new Image(); coinImg.src='coin-cosmodoge.png';
  const bcosmoImg=new Image(); bcosmoImg.src='moneda-bcosmo.png';
  const obsImgs=['obs1.png','obs2.png','obs3.png'];
  const sndJump=new Audio('jump.mp3'), sndCoin=new Audio('coin.mp3'),
        sndBC=new Audio('sonido-moneda-bcosmo.mp3'), sndBoom=new Audio('boom.mp3'),
        sndRec=new Audio('record.mp3');
  const music=new Audio('music-cosmodoge-theme.mp3'); music.loop=true; music.volume=0.3;

  function playSound(a){try{a.currentTime=0;a.play();}catch{}}
  function updateDifficulty(s){grav=s>75?1:s>45?0.8:s>30?0.6:0.5;}
  function changeBg(s){
    if(s-lastBg>=30){fIdx=(fIdx+1)%fondos.length;bg.src=fondos[fIdx];lastBg=s;}
  }
  function dibujarAura(){
    const exp=parseInt(localStorage.getItem('imanExp'))||0;
    if(Date.now()>=exp){imActive=false;localStorage.removeItem('imanExp');}
    if(imActive){
      ctx.beginPath();
      ctx.arc(doge.x+doge.w/2,doge.y+doge.h/2,doge.w*0.8,0,2*Math.PI);
      ctx.strokeStyle='#0ff88';ctx.lineWidth=4;ctx.stroke();
    }
  }
  // Spawns
  setInterval(()=>coinsArr.push({x:canvas.width+20,y:Math.random()*(canvas.height-100),w:30,h:30,speed:2}),5000);
  let odd=false;
  setInterval(()=>{
    const pos=[{x:80,y:100},{x:canvas.width-120,y:80},{x:canvas.width/2,y:canvas.height/3}];
    (odd?coinsBCOSMOArr:coinsArr).push(...pos.map(p=>({x:p.x,y:p.y,w:30,h:30,speed:2})));
    odd=!odd;
  },15000);

  function drawAndCollectCoins(){
    for(let i=coinsArr.length-1;i>=0;i--){
      const o=coinsArr[i];
      if(imActive){
        const dx=doge.x+doge.w/2-(o.x+o.w/2),dy=doge.y+doge.h/2-(o.y+o.h/2),d=Math.hypot(dx,dy);
        if(d<200){const f=1-d/200;o.x+=dx*0.05*f;o.y+=dy*0.05*f;}
      }
      o.x-=o.speed;ctx.drawImage(coinImg,o.x,o.y,o.w,o.h);
      if(doge.x<o.x+o.w&&doge.x+doge.w>o.x&&doge.y<o.y+o.h&&doge.y+doge.h>o.y){
        coins++;localStorage.setItem('cdogeCoins',coins);
        document.getElementById('coinDisplay').textContent=`💰 ${coins}`;
        playSound(sndCoin);coinsArr.splice(i,1);
      }
    }
  }
  function drawAndCollectBCOSMO(){
    for(let i=coinsBCOSMOArr.length-1;i>=0;i--){
      const o=coinsBCOSMOArr[i];
      if(imActive){
        const dx=doge.x+doge.w/2-(o.x+o.w/2),dy=doge.y+doge.h/2-(o.y+o.h/2),d=Math.hypot(dx,dy);
        if(d<200){const f=1-d/200;o.x+=dx*0.05*f;o.y+=dy*0.05*f;}
      }
      o.x-=o.speed;ctx.drawImage(bcosmoImg,o.x,o.y,o.w,o.h);
      if(doge.x<o.x+o.w&&doge.x+doge.w>o.x&&doge.y<o.y+o.h&&doge.y+doge.h>o.y){
        bcosmo++;localStorage.setItem('bcosmoCount',bcosmo);
        document.getElementById('contadorBCOSMO').textContent=`🪐 ${bcosmo}`;
        playSound(sndBC);coinsBCOSMOArr.splice(i,1);
      }
    }
  }
  function spawnObs(){
    if(Date.now()-lastObs>3000){
      const img=new Image();img.src=obsImgs[Math.floor(Math.random()*obsImgs.length)];
      const vy=(Math.random()*2)*(Math.random()>0.5?1:-1);
      obstacles.push({x:canvas.width,y:Math.random()*canvas.height,w:50,h:50,speed:2+Math.random()*2,vy,img});
      lastObs=Date.now();
    }
  }
  function drawAndCheckObs(){
    obstacles.forEach((o,i)=>{
      o.x-=o.speed;o.y+=o.vy;
      if(o.y<=0||o.y+o.h>=canvas.height) o.vy*=-1;
      ctx.drawImage(o.img,o.x,o.y,o.w,o.h);
      if(doge.x<o.x+o.w&&doge.x+doge.w>o.x&&doge.y<o.y+o.h&&doge.y+doge.h>o.y) gameOver();
    });
    obstacles=obstacles.filter(o=>o.x+o.w>0);
  }

  function updateGame(ts){
    if(isGameOver) return;
    if(!lastTime) lastTime=ts;
    const dt=ts-lastTime; lastTime=ts;
    time+=dt/1000; updateDifficulty(time); changeBg(time);
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.drawImage(bg,0,0,canvas.width,canvas.height);
    doge.y+=doge.vel*(dt/16); doge.vel+=grav*(dt/16);
    if(doge.y<=0||doge.y+doge.h>=canvas.height) return gameOver();
    ctx.drawImage(doge.img,doge.x,doge.y,doge.w,doge.h);
    dibujarAura();
    drawAndCollectCoins(); drawAndCollectBCOSMO();
    spawnObs(); drawAndCheckObs();
    document.getElementById('scoreDisplay').textContent=`🚀 ${Math.floor(time/5)}`;
    document.getElementById('highScoreDisplay').textContent=`🔝 ${highScore}`;
    requestAnimationFrame(updateGame);
  }

  function startGame(){
    ['startScreen','pantallaCarga','menuPrincipal','tiendaCDOGE'].forEach(id=>
      document.getElementById(id).style.display='none'
    );
    gameStarted=true; music.play(); requestAnimationFrame(updateGame);
  }
  function gameOver(){
    isGameOver=true; music.pause();
    document.getElementById('gameOverScreen').classList.add('show');
    document.getElementById('finalScore').textContent=Math.floor(time/5);
    setTimeout(()=>document.getElementById('reiniciarBtn').style.display='block',1000);
    const sc=Math.floor(time/5);
    if(sc>highScore){
      highScore=sc; localStorage.setItem('cdogeFloatHighScore',highScore);
      document.getElementById('newRecordMessage').style.display='flex';
      playSound(sndRec); mostrarTopRanking();
      const u=localStorage.getItem('cosmodogeliveUserName');
      if(!u) document.getElementById('playerNameForm').style.display='block';
      else guardarJugadorAutomatic(u,sc,coins);
    } else playSound(sndBoom);
  }

  document.getElementById('startButton').onclick=startGame;
  document.getElementById('reiniciarBtn').onclick=()=>{
    [time,lastTime,lastObs,lastBg]=[0,0,0,0];
    [coins,bcosmo]=[0,0];
    doge.y=200; doge.vel=0; isGameOver=false;
    obstacles.length=coinsArr.length=coinsBCOSMOArr.length=0;
    ['gameOverScreen','newRecordMessage','playerNameForm'].forEach(id=>
      document.getElementById(id).style.display='none'
    );
    document.getElementById('reiniciarBtn').style.display='none';
    localStorage.setItem('cdogeCoins',0);
    localStorage.setItem('bcosmoCount',0);
    document.getElementById('coinDisplay').textContent='💰 0';
    document.getElementById('contadorCDOGE').textContent='💰 CDOGE: 0';
    document.getElementById('contadorBCOSMO').textContent='🪐 BCOSMO: 0';
    music.currentTime=0; music.play();
    requestAnimationFrame(updateGame);
  };

  document.getElementById('saveScoreButton').onclick=()=>{
    const u=document.getElementById('playerName').value.trim();
    if(u){
      localStorage.setItem('cosmodogeliveUserName',u);
      document.getElementById('nombreJugador').textContent=`🐶 ${u}`;
      guardarJugadorAutomatic(u,highScore,coins);
      document.getElementById('playerNameForm').style.display='none';
    } else alert('Ingresa nombre');
  };

  document.getElementById('closeRankingBtn').onclick=()=>{
    document.getElementById('rankingPanel').style.display='none';
  };

  document.addEventListener('keydown',e=>{ if(e.code==='Space'&&gameStarted&&!isGameOver){
    doge.vel=-10; playSound(sndJump);
  }});
  document.addEventListener('touchstart',()=>{ if(gameStarted&&!isGameOver){
    doge.vel=-10; playSound(sndJump);
  }});
  document.getElementById('reanudarBtn').onclick=()=>{
    if(gameStarted&&!isGameOver){
      music.play();
      requestAnimationFrame(updateGame);
      document.getElementById('reanudarBtn').style.display='none';
    }
  };
  document.addEventListener('visibilitychange',()=>{
    if(document.hidden&&gameStarted&&!isGameOver){
      music.pause(); document.getElementById('reanudarBtn').style.display='block';
    }
  });

  // Wallet & Imán
  const TOKEN_ADDRESS='0x5dE25281305992d3552a45A3D8ccA7BdfB4AcD3A';
  let tokenContract,tokenDecimals,tokenSigner;
  document.getElementById('conectarWalletBtn').onclick=()=>mostrarSelectorWallet();
  function toggleTienda(){
    const t=document.getElementById('tiendaCDOGE');
    t.style.display=t.style.display==='none'?'block':'none';
  }
  function mostrarSelectorWallet(){
    const o=prompt('1 MetaMask (CDOGE)\\n2 Phantom (BCOSMO)');
    if(o==='1') connectMetaMask();
    else if(o==='2') connectPhantom();
    else alert('Inválido');
  }
  async function connectMetaMask(){
    if(!window.ethereum){
      if(/Mobi|Android/i.test(navigator.userAgent)){
        const dappUrl=encodeURIComponent(location.href.replace(/^https?:\\///,'')); 
        location.href=`https://metamask.app.link/dapp/${dappUrl}`; return;
      }
      return alert('Instala MetaMask');
    }
    const prov=new ethers.providers.Web3Provider(window.ethereum);
    await prov.send('eth_requestAccounts',[]);
    tokenSigner=prov.getSigner();
    tokenContract=new ethers.Contract(
      TOKEN_ADDRESS,
      ['function balanceOf(address)view returns(uint256)','function decimals()view returns(uint8)','function transfer(address,uint256) returns(bool)'],
      tokenSigner
    );
    tokenDecimals=await tokenContract.decimals();
    const a=await tokenSigner.getAddress();
    document.getElementById('nombreJugador').textContent=`🐶 ${a.slice(0,6)}...${a.slice(-4)}`;
    document.getElementById('conectarWalletBtn').textContent=`🧑‍🚀 ${a.slice(0,6)}...${a.slice(-4)}`;
    const bal=await tokenContract.balanceOf(a);
    document.getElementById('balanceCDOGE').textContent=`🚀 ${ethers.utils.formatUnits(bal,tokenDecimals)}`;
    document.getElementById('balanceCDOGE').style.display='block';
  }
  async function comprarImanCDOGE(){
    if(!tokenContract)return alert('Conecta MetaMask');
    const COST=ethers.utils.parseUnits('1500',tokenDecimals);
    try{
      const tx=await tokenContract.transfer('0x1980dCdDA07071970dEAa69c975F590976Ee667D',COST);
      await tx.wait(); alert('✅ Imán comprado con CDOGE');
      imActive=true; localStorage.setItem('imanExp',Date.now()+3600000);
    } catch{ alert('❌ Compra CDOGE fallida'); }
  }
  document.getElementById('comprarIman').onclick=comprarImanCDOGE;

  async function connectPhantom(){
    if(!window.solana||!window.solana.isPhantom) return alert('Instala Phantom');
    const resp=await window.solana.connect();
    const addr=resp.publicKey.toString();
    document.getElementById('nombreJugador').textContent=`🐶 ${addr.slice(0,6)}...${addr.slice(-4)}`;
    document.getElementById('conectarWalletBtn').textContent=`🪐 ${addr.slice(0,6)}...${addr.slice(-4)}`;
    const data=await fetch(`https://public-api.solscan.io/account/tokens?account=${addr}`).then(r=>r.json());
    const tkn=data.find(t=>t.tokenAddress==='2etLM91LBaxbQ1y3jnzQw8EXKNHAKcXJsHMJJ69opump');
    document.getElementById('balanceBCOSMO').textContent=tkn?`🪐 ${tkn.tokenAmount.uiAmount}`:'No BCOSMO';
    document.getElementById('balanceBCOSMO').style.display='block';
  }
  async function comprarImanBCOSMO(){
    if(!window.solana.isConnected) return alert('Conecta Phantom');
    try{
      const conn=new Connection("https://api.mainnet-beta.solana.com");
      const from=window.solana.publicKey;
      const mint=new PublicKey("2etLM91LBaxbQ1y3jnzQw8EXKNHAKcXJsHMJJ69opump");
      const to=new PublicKey("A6dnVgGaS1scC2m6hmPdK15D5gs5vDsHS8PEq3xtJKNx");
      const fromToken=await getAssociatedTokenAddress(mint,from),
            toToken=await getAssociatedTokenAddress(mint,to);
      const inst=createTransferCheckedInstruction(fromToken,mint,toToken,from,2500,0,[],TOKEN_PROGRAM_ID);
      const tx=new Transaction().add(inst);
      tx.feePayer=from; tx.recentBlockhash=(await conn.getLatestBlockhash()).blockhash;
      const signed=await window.solana.signTransaction(tx);
      const sig=await conn.sendRawTransaction(signed.serialize());
      await conn.confirmTransaction(sig);
      alert('✅ Imán comprado con BCOSMO');
      imActive=true; localStorage.setItem('imanExp',Date.now()+3600000);
    } catch(e){ console.error(e); alert('❌ Compra BCOSMO fallida'); }
  }
  document.getElementById('comprarImanBCOSMO').onclick=comprarImanBCOSMO;
</script>
</body>
</html>
