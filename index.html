<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CosmoDoge Flotante üöÄ</title>

  <!-- Google Fonts: Orbitron -->
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet" />

  <!-- Bibliotecas on-chain -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.41.0/lib/index.iife.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@solana/spl-token@0.3.5/lib/index.iife.min.js"></script>

  <style>
    /* RESET & BASE */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { width: 100%; height: 100%; overflow: hidden; background: black; font-family: 'Orbitron', Arial, sans-serif; }
    canvas { display: block; margin: auto; max-width: 100vw; max-height: 100vh; }

    /* HUD & UI Styles */
    .hud { position: absolute; color: white; text-shadow: 2px 2px 5px #000; z-index: 1000; font: 18px 'Orbitron', sans-serif; }
    #scoreDisplay { top: 10px; left: 10px; }
    #coinDisplay { top: 40px; left: 10px; }
    #highScoreDisplay { top: 70px; left: 10px; }
    #contadorCDOGE { top: 100px; left: 10px; color: #0ff; }
    #contadorBCOSMO { top: 130px; left: 10px; color: #faa200; }
    #shieldDisplay { top: 160px; left: 10px; color: #faa; display: none; }
    #nombreJugador { top: 10px; left: 50%; transform: translateX(-50%); color: #0ff; }
    #balanceCDOGE, #balanceBCOSMO { position: absolute; right: 20px; padding: 10px; border-radius: 8px; background: rgba(0,0,0,0.7); font: 16px 'Orbitron', sans-serif; color: #0ff; display: none; z-index: 1000; }
    #balanceBCOSMO { top: 110px; }
    #imanContador { position: absolute; top: 190px; right: 20px; padding: 8px; border-radius: 10px; background: rgba(0,0,0,0.75); font: 16px 'Orbitron', sans-serif; color: #0ff; display: none; z-index: 1000; }

    /* Fixed Buttons */
    .fixed { position: fixed; z-index: 10000; transition: opacity .3s; }
    .hiddenUI { opacity: 0; }
    #conectarWalletBtn { top: 20px; right: 20px; background: #0ff; color: #000; border: none; border-radius: 12px; padding: 10px 20px; font: 16px 'Orbitron', sans-serif; cursor: pointer; }
    #menuPrincipal { top: 70px; right: 20px; display: flex; flex-direction: column; gap: 10px; }

    /* Panels */
    #tiendaCDOGE, #rankingPanel { position: fixed; background: rgba(0,0,0,0.85); padding: 15px; border-radius: 15px; box-shadow: 0 0 15px #0ff; font: 14px 'Orbitron', sans-serif; color: #fff; z-index: 10001; display: none; }
    #tiendaCDOGE { bottom: 20px; left: 20px; width: 320px; border: 2px solid #0ff; }
    #rankingPanel { top: 200px; left: 50%; transform: translateX(-50%); }

    /* Buttons */
    .btn { padding: 1rem 2rem; background: #0ff; border: none; border-radius: 10px; color: #000; font-size: 1.2rem; font-weight: bold; cursor: pointer; transition: transform .2s, box-shadow .2s; }
    .btn:hover { transform: scale(1.05); box-shadow: 0 0 10px #0ff; }

    /* Overlays */
    #pantallaCarga, #startScreen, #newRecordMessage, #gameOverScreen { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(0,0,0,0.85); color: white; z-index: 9999; text-align: center; }
    #pantallaCarga .spinner { width: 60px; height: 60px; border: 6px solid #ffffff22; border-top: 6px solid #0ff; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    #gameOverScreen { display: none; opacity: 0; transition: opacity 1s; }
    #gameOverScreen.show { display: flex; opacity: 1; }
    #reiniciarBtn { margin-top: 20px; display: none; }

    /* Name Form */
    #playerNameForm { display: none; position: fixed; top: 30%; left: 50%; transform: translateX(-50%); flex-direction: column; align-items: center; background: rgba(0,0,0,0.95); padding: 20px; border-radius: 10px; z-index: 10002; }
    #playerNameForm input { padding: 10px; border-radius: 8px; border: none; margin-bottom: 10px; width: 200px; text-align: center; font: 16px 'Orbitron'; }
  </style>
</head>
<body>
  <!-- Preloader -->
  <div id="pantallaCarga">
    <div class="spinner"></div>
    <p style="font-size:20px;margin-top:20px;">Cargando CosmoDoge...</p>
  </div>

  <!-- HUD & UI -->
  <button id="conectarWalletBtn" class="fixed">üîó Conectar Wallet</button>
  <div id="balanceCDOGE"></div>
  <div id="balanceBCOSMO"></div>
  <div id="scoreDisplay" class="hud">üöÄ x 0</div>
  <div id="coinDisplay" class="hud">üí∞ x 0</div>
  <div id="highScoreDisplay" class="hud">üîù M√°x: 0</div>
  <div id="contadorCDOGE" class="hud">üí∞ CDOGE: 0</div>
  <div id="contadorBCOSMO" class="hud">üêï BCOSMO: 0</div>
  <div id="shieldDisplay" class="hud"></div>
  <div id="nombreJugador" class="hud"></div>
  <div id="imanContador"></div>

  <div id="menuPrincipal" class="fixed">
    <button id="btnTienda" class="btn">üõí Tienda</button>
    <button id="btnRanking" class="btn">üèÜ Ranking</button>
  </div>

  <!-- Tienda -->
  <div id="tiendaCDOGE">
    <h3 style="color:#0ff;">üõí Tienda CosmoDoge</h3>
    <div style="margin-bottom:15px;padding:10px;background:#111;border:1px solid #0ff;border-radius:10px;">
      <p style="color:#0ff;">üß≤ Im√°n Espacial (CDOGE)</p>
      <p style="color:#bbb;">Atrae monedas 1h</p>
      <button id="comprarImanCDOGE" class="btn">Comprar 1,500 $CDOGE</button>
    </div>
    <div style="margin-bottom:15px;padding:10px;background:#111;border:1px solid #0ff;border-radius:10px;">
      <p style="color:#0ff;">üß≤ Im√°n Espacial (BCOSMO)</p>
      <p style="color:#bbb;">Atrae monedas 1h</p>
      <button id="comprarImanBCOSMO" class="btn">Comprar 2,500 $BCOSMO</button>
    </div>
    <div style="padding:10px;background:#111;border:1px solid #faa;border-radius:10px;">
      <p style="color:#faa;">üõ°Ô∏è Escudo Protector</p>
      <p style="color:#bbb;">Inmune 13s</p>
      <button id="comprarEscudo" class="btn">Comprar 1,000 ü™ô</button>
    </div>
  </div>

  <!-- Canvas -->
  <canvas id="gameCanvas"></canvas>

  <!-- Overlays -->
  <div id="startScreen" style="display:none;">
    <h1>üöÄ CosmoDoge Flotante</h1>
    <button id="startButton" class="btn">¬°Comenzar!</button>
  </div>
  <div id="gameOverScreen">
    <h1>üö® GAME OVER üö®</h1>
    <p>Puntaje: <span id="finalScore">0</span></p>
    <button id="reiniciarBtn" class="btn">Reiniciar</button>
  </div>
  <div id="newRecordMessage" style="display:none;">
    <h1>üåü ¬°Nuevo r√©cord gal√°ctico!</h1>
    <p>Ingresa tu nombre para guardarlo.</p>
  </div>
  <!-- Formulario registro -->
  <div id="playerNameForm">
    <input type="text" id="playerName" placeholder="Tu nombre gal√°ctico" maxlength="12" />
    <button id="saveScoreButton" class="btn">Guardar Puntaje</button>
  </div>
  <div id="rankingPanel">
    <div id="topRanking"></div>
    <button id="closeRanking" class="btn">Cerrar</button>
  </div>

  <!-- Firebase & On-Chain -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getFirestore, collection, query, where, orderBy, limit, getDocs, addDoc, serverTimestamp }
      from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDaM9HtMtTlJXc-V4HfsZ7bbC__ZPe9zIk",
      authDomain: "cosmodogelive.firebaseapp.com",
      projectId: "cosmodogelive",
      storageBucket: "cosmodogelive.appspot.com",
      messagingSenderId: "648227069914",
      appId: "1:648227069914:web:3ef7ac8da4ab52c30deae3"
    };
    initializeApp(firebaseConfig);
    window.db = getFirestore();

    window.guardarJugadorAutomatic = async (u, pts, mns) => {
      await addDoc(collection(db, "jugadores"), { nombre: u, puntaje: pts, monedas: mns, fecha: serverTimestamp() });
    };

    window.mostrarTopRanking = async () => {
      const lista = document.getElementById("topRanking");
      const snap = await getDocs(query(collection(db, "jugadores"), orderBy("puntaje","desc"), limit(5)));
      let html = "<h2>üèÜ Top 5 CosmoDoge</h2><ul style='list-style:none;padding:0;'>";
      snap.forEach((doc,i) => { const d = doc.data(); html += `<li>#${i+1} <strong>${d.nombre}</strong> ‚Äì ${d.puntaje} pts ‚Äì ${d.monedas} ü™ô</li>`; });
      lista.innerHTML = html + "</ul>";
    };
  </script>

  <!-- Game Logic -->
  <script>
    // Canvas setup
    const canvas=document.getElementById('gameCanvas'), ctx=canvas.getContext('2d');
    function resize(){ canvas.width=window.innerWidth; canvas.height=window.innerHeight; }
    window.addEventListener('resize',resize); resize();

    // State
    let score=0, coins=parseInt(localStorage.getItem('cdogeCoins'))||0;
    let highScore=parseInt(localStorage.getItem('cdogeFloatHighScore'))||0;
    let totalCDOGE=parseInt(localStorage.getItem('cdogeTotalCoins'))||0;
    let totalBCOSMO=parseInt(localStorage.getItem('bcosmoTotalCoins'))||0;
    let gameStarted=false, isGameOver=false;
    let timeElapsed=0, lastScoreTime=0, lastFondoChange=0, lastObs=Date.now();
    const gravityLevels=[0.5,0.6,0.8,1.0]; let gravity=0.5, jump=-10;

    let coinsArr=[], obsArr=[], cdogeArr=[], bcosmoArr=[];
    const valorPorMoneda=50, valorBCOSMO=50; let turnoCoins=true;
    const fondos=['fondo-v1.png','fondo-v2.png','fondo-v3.png']; let fi=0; const fondoImg=new Image(); fondoImg.src=fondos[0];
    const doge={x:80,y:200,w:50,h:50,v:0,img:new Image()}; doge.img.src='cosmodoge.png';
    const coinImg=new Image(); coinImg.src='coin.png'; const cdogeImg=new Image(); cdogeImg.src='cdoge.png'; const bcosmoImg=new Image(); bcosmoImg.src='bcosmo.png';
    const obsImgs=['obs1.png','obs2.png','obs3.png'];
    const sndJump=new Audio('jump.mp3'), sndCoin=new Audio('coin.mp3'), sndBoom=new Audio('boom.mp3'), sndRecord=new Audio('record.mp3'), sndC=new Audio('cdoge.mp3'), sndB=new Audio('bcosmo.mp3'), music=new Audio('music.mp3');
    music.loop=true; music.volume=0.3;
    const CDOGE_CON='0x...'; const ERC20_ABI=['function balanceOf(address) view returns(uint256)','function decimals() view returns(uint8)','function transfer(address,uint256)'];
    const CDOGE_REC='0x...'; const MINT='...'; const RCV='...';

    function play(s){s.currentTime=0;s.play().catch(()=>{});}    
    function showMsg(txt,x,y){const d=document.createElement('div');Object.assign(d.style,{position:'absolute',left:`${x}px`,top:`${y}px`,color:'#0ff',font:'18px Orbitron',zIndex:10000,transition:'all 1.5s'});d.textContent=txt;document.body.appendChild(d);setTimeout(()=>{d.style.opacity=0;d.style.transform='translateY(-40px)';},100);setTimeout(()=>d.remove(),1600);}    
    function updCD(){document.getElementById('contadorCDOGE').textContent=`üí∞ CDOGE: ${totalCDOGE}`;}    
    function updBC(){document.getElementById('contadorBCOSMO').textContent=`üêï BCOSMO: ${totalBCOSMO}`;}    
    function updDiff(sec){gravity=sec>=75?gravityLevels[3]:sec>=45?gravityLevels[2]:sec>=30?gravityLevels[1]:gravityLevels[0];}

    function drawAura(p){const exp=+localStorage.getItem('imanExpiracion')||0; if(Date.now()<exp){ctx.beginPath();ctx.arc(p.x+p.w/2,p.y+p.h/2,p.w*0.8,0,Math.PI*2);ctx.strokeStyle='#0ffff088';ctx.lineWidth=4;ctx.stroke();}}
    function drawD(){ctx.drawImage(doge.img,doge.x,doge.y,doge.w,doge.h);drawAura(doge);}

    function actIman(){const exp=Date.now()+3600000;localStorage.setItem('imanExpiracion',exp);showMsg('üß≤ Im√°n activo 1h',canvas.width/2,100);checkIman();}
    function checkIman(){const id=setInterval(()=>{const exp=+localStorage.getItem('imanExpiracion')||0,now=Date.now(),d=document.getElementById('imanContador');if(now<exp){const ms=exp-now,m=Math.floor(ms/60000),s=Math.floor((ms%60000)/1000);d.textContent=`üß≤ ${m}:${s<10?'0':''}${s}`;d.style.display='block';}else{d.style.display='none';localStorage.removeItem('imanExpiracion');clearInterval(id);showMsg('‚è±Ô∏è Expirado',canvas.width/2,100);}},250);}
    function buyShield(){if(coins<1000)return alert('No tienes ü™ô');coins-=1000;localStorage.setItem('cdogeCoins',coins);document.getElementById('coinDisplay').textContent=`üí∞ x ${coins}`;const exp=Date.now()+13000;localStorage.setItem('shieldExpiration',exp);showMsg('üõ°Ô∏è 13s',canvas.width/2,140);checkShield();}
    function checkShield(){const id=setInterval(()=>{const exp=+localStorage.getItem('shieldExpiration')||0,now=Date.now(),d=document.getElementById('shieldDisplay');if(now<exp){const s=Math.ceil((exp-now)/1000);d.textContent=`üõ°Ô∏è ${s}s`;d.style.display='block';}else{d.style.display='none';localStorage.removeItem('shieldExpiration');clearInterval(id);showMsg('üõ°Ô∏è Fin',canvas.width/2,140);}},250);}
    function handleCol(){const exp=+localStorage.getItem('shieldExpiration')||0; if(Date.now()<exp){showMsg('üõ°Ô∏è Bloqueo',canvas.width/2,160);return true;}return false;}

    function spawnCoins(){for(let i=0;i<Math.floor(Math.random()*6)+5;i++)coinsArr.push({x:canvas.width+i*40,y:Math.random()*(canvas.height-100),w:30,h:30,s:2});}
    function drawCoins(){for(let i=coinsArr.length-1;i>=0;i--){const c=coinsArr[i],exp=+localStorage.getItem('imanExpiracion')||0;if(Date.now()<exp){const dx=c.x+15-(doge.x+doge.w/2),dy=c.y+15-(doge.y+doge.h/2),dist=Math.hypot(dx,dy);if(dist<200){c.x-=dx*0.05;c.y-=dy*0.05;}}c.x-=c.s;ctx.drawImage(coinImg,c.x,c.y,c.w,c.h);if(doge.x<c.x+c.w&&doge.x+doge.w>c.x&&doge.y<c.y+c.h&&doge.y+doge.h>c.y){coins++;localStorage.setItem('cdogeCoins',coins);document.getElementById('coinDisplay').textContent=`üí∞ x ${coins}`;play(sndCoin);coinsArr.splice(i,1);}}}

    function spawnObs(){const img=new Image();img.src=obsImgs[Math.floor(Math.random()*obsImgs.length)];obsArr.push({x:canvas.width,y:Math.random()*(canvas.height-50),w:50,h:50,sX:2+Math.random()*2,sY:0.5+Math.random()*1.5,img});}
    function drawObs(){obsArr.forEach((o,i)=>{o.x-=o.sX;o.y+=(o.y<doge.y?o.sY:-o.sY);ctx.drawImage(o.img,o.x,o.y,o.w,o.h);if(doge.x<o.x+o.w&&doge.x+doge.w>o.x&&doge.y<o.y+o.h&&doge.y+doge.h>o.y){if(!handleCol())gameOver();}});obsArr=obsArr.filter(o=>o.x+o.w>0);}

    const locs=[{x:80,y:100},{x:canvas.width-120,y:80},{x:canvas.width/2,y:canvas.height/3},{x:canvas.width-80,y:canvas.height-120},{x:100,y:canvas.height-150}];
    function spawnCD(){locs.forEach(p=>cdogeArr.push({x:p.x,y:p.y,w:32,h:32,got:false}));}
    function spawnBC(){locs.forEach(p=>bcosmoArr.push({x:p.x,y:p.y,w:32,h:32,got:false}));}
    setInterval(()=>{turnoCoins?spawnCD():spawnBC();turnoCoins=!turnoCoins;},20000);

    function drawCD(){for(let i=cdogeArr.length-1;i>=0;i--){const m=cdogeArr[i];m.x-=4;if(m.x+m.w<0){cdogeArr.splice(i,1);continue;}if(!m.got)ctx.drawImage(cdogeImg,m.x,m.y,m.w,m.h);}collectCD();}
    function collectCD(){for(const m of cdogeArr){if(!m.got){const dx=m.x+16-(doge.x+doge.w/2),dy=m.y+16-(doge.y+doge.h/2),dist=Math.hypot(dx,dy),exp=+localStorage.getItem('imanExpiracion')||0;if(Date.now()<exp&&dist<200){m.x-=dx*0.05;m.y-=dy*0.05;}if(dist<20){m.got=true;totalCDOGE+=valorPorMoneda;localStorage.setItem('cdogeTotalCoins',totalCDOGE);play(sndC);showMsg(`+${valorPorMoneda} CDOGE`,m.x,m.y);updCD();}}}}

    function drawBC(){for(let i=bcosmoArr.length-1;i>=0;i--){const m=bcosmoArr[i];m.x-=4;if(m.x+m.w<0){bcosmoArr.splice(i,1);continue;}if(!m.got)ctx.drawImage(bcosmoImg,m.x,m.y,m.w,m.h);}collectBC();}
    function collectBC(){for(const m of bcosmoArr){if(!m.got){const dx=m.x+16-(doge.x+doge.w/2),dy=m.y+16-(doge.y+doge.h/2),dist=Math.hypot(dx,dy),exp=+localStorage.getItem('imanExpiracion')||0;if(Date.now()<exp&&dist<200){m.x-=dx*0.05;m.y-=dy*0.05;}if(dist<20){m.got=true;totalBCOSMO+=valorBCOSMO;localStorage.setItem('bcosmoTotalCoins',totalBCOSMO);play(sndB);showMsg(`+${valorBCOSMO} BCOSMO`,m.x,m.y);updBC();}}}}

    function drawBG(){ctx.drawImage(fondoImg,0,0,canvas.width,canvas.height);}

    let lastTime=0;
    function loop(ts){if(!gameStarted||isGameOver) return; if(!lastTime) lastTime=ts; const dt=ts-lastTime; lastTime=ts; ctx.clearRect(0,0,canvas.width,canvas.height); drawBG(); doge.v+=gravity*(dt/16); doge.y+=doge.v*(dt/16); if(doge.y+doge.h>=canvas.height||doge.y<=0){if(!handleCol()) return gameOver(); doge.y=canvas.height/2;} drawD(); drawCoins(); drawObs(); drawCD(); drawBC(); timeElapsed+=dt; const sec=timeElapsed/1000; if(sec-lastScoreTime>=5){score++; lastScoreTime=sec; document.getElementById('scoreDisplay').textContent=`üöÄ x ${score}`;} if(sec-lastFondoChange>=30){fi=(fi+1)%fondos.length; fondoImg.src=fondos[fi]; lastFondoChange=sec;} if(Math.floor(timeElapsed/16)%150===0) spawnCoins(); const now=Date.now(); const interval=sec>=3600?1000:sec>=1800?2000:3000; if(now-lastObs>=interval){spawnObs(); lastObs=now;} updDiff(sec); requestAnimationFrame(loop); }

    // Nuevo registro
    function handleNewRecord(){document.getElementById('newRecordMessage').style.display='flex'; const f=document.getElementById('playerNameForm'); f.style.display='flex'; document.getElementById('playerName').value=''; document.getElementById('playerName').focus();}
    async function setupSaveListener(){ const btn=document.getElementById('saveScoreButton'); btn.addEventListener('click', async()=>{ const name=document.getElementById('playerName').value.trim(); if(!name) return alert('Ingresa tu nombre'); const q=query(collection(db,'jugadores'),where('nombre','==',name),limit(1)); const snap=await getDocs(q); if(!snap.empty) return alert('Ese nombre ya existe.'); await guardarJugadorAutomatic(name,score,coins); mostrarTopRanking(); document.getElementById('playerNameForm').style.display='none'; btn.style.display='none'; document.getElementById('reiniciarBtn').style.display='block'; }); }

    function gameOver(){ isGameOver=true; music.pause(); music.currentTime=0; document.getElementById('finalScore').textContent=score; const go=document.getElementById('gameOverScreen'); go.style.display='flex'; setTimeout(()=>go.classList.add('show'),10); document.getElementById('reiniciarBtn').style.display='none'; if(score>highScore){ localStorage.setItem('cdogeFloatHighScore',score); highScore=score; document.getElementById('highScoreDisplay').textContent=`üîù M√°x: ${highScore}`; play(sndRecord); handleNewRecord(); } else { document.getElementById('reiniciarBtn').style.display='block'; play(sndBoom); } }

    // UI events
    window.addEventListener('DOMContentLoaded',()=>{ setupSaveListener(); document.getElementById('conectarWalletBtn').addEventListener('click',mostrarSelectorWallet); document.getElementById('btnTienda').addEventListener('click',toggleTienda); document.getElementById('btnRanking').addEventListener('click',toggleRanking); document.getElementById('comprarImanCDOGE').addEventListener('click',comprarImanCDOGE); document.getElementById('comprarImanBCOSMO').addEventListener('click',comprarImanBCOSMO); document.getElementById('comprarEscudo').addEventListener('click',buyShield); document.getElementById('closeRanking').addEventListener('click',toggleRanking); document.getElementById('startButton').addEventListener('click',()=>{ document.getElementById('startScreen').style.display='none'; document.getElementById('conectarWalletBtn').classList.add('hiddenUI'); document.getElementById('menuPrincipal').classList.add('hiddenUI'); gameStarted=true; music.play(); requestAnimationFrame(loop); }); document.getElementById('reiniciarBtn').addEventListener('click',()=>location.reload()); document.addEventListener('keydown',e=>{ if(e.code==='Space'&&gameStarted&&!isGameOver){ doge.v=jump; play(sndJump);} }); });
  </script>
</body>
</html>
