<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CosmoDoge Flotante üöÄ</title>

  <!-- On-chain libraries -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.41.0/lib/index.iife.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@solana/spl-token@0.3.5/lib/index.iife.min.js"></script>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    html, body { width:100%; height:100%; overflow:hidden; background:black; font-family:Arial,sans-serif; }
    canvas { display:block; margin:auto; max-width:100vw; max-height:100vh; }

    .hud { position:absolute; color:white; text-shadow:2px 2px 5px #000; z-index:1000; }
    #scoreDisplay { top:10px; left:10px; font-size:18px; }
    #coinDisplay  { top:40px; left:10px; font-size:18px; }
    #highScoreDisplay { top:70px; left:10px; font-size:18px; }
    #contadorCDOGE { top:100px; left:10px; font:18px Orbitron; color:#0ff; }
    #contadorBCOSMO { top:130px; left:10px; font:18px Orbitron; color:#ffaa00; }
    #shieldDisplay  { top:160px; left:10px; font:18px Orbitron; color:#faa; }
    #nombreJugador  { top:10px; left:50%; transform:translateX(-50%); font:18px Orbitron; color:#0ff; }

    #balanceCDOGE, #balanceBCOSMO {
      position:absolute; right:20px; padding:10px; border-radius:8px;
      background:rgba(0,0,0,0.7); font:16px Orbitron; color:#0ff; display:none; z-index:1000;
    }
    #balanceBCOSMO { top:110px; }

    #imanContador {
      position:absolute; top:190px; right:20px; background:rgba(0,0,0,0.75);
      padding:8px; border-radius:10px; font:16px Orbitron; color:#0ff; display:none; z-index:1000;
    }

    .fixed { position:fixed; z-index:10000; transition:opacity .3s; }
    .hiddenUI { opacity:0; }

    #conectarWalletBtn {
      top:20px; right:20px; background:#0ff; color:#000; border:none;
      border-radius:12px; padding:10px 20px; font:16px Orbitron; cursor:pointer;
    }

    #menuPrincipal {
      top:70px; right:20px; display:flex; flex-direction:column; gap:10px;
    }

    #tiendaCDOGE, #rankingPanel {
      position:fixed; background:rgba(0,0,0,0.85); padding:15px;
      border-radius:15px; box-shadow:0 0 15px #0ff; font:14px Orbitron; color:#fff;
      z-index:10001; display:none;
    }
    #tiendaCDOGE { bottom:20px; left:20px; width:320px; border:2px solid #0ff; }
    #rankingPanel { top:200px; left:50%; transform:translateX(-50%); }

    .btn {
      padding:1rem 2rem; background:#0ff; border:none; border-radius:10px;
      color:#000; font-size:1.2rem; font-weight:bold; cursor:pointer;
      transition:transform .2s, box-shadow .2s;
    }
    .btn:hover {
      transform:scale(1.05); box-shadow:0 0 10px #0ff;
    }

    #pantallaCarga, #startScreen, #newRecordMessage, #gameOverScreen {
      position:fixed; top:0; left:0; width:100vw; height:100vh;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      background:rgba(0,0,0,0.85); color:white; font:Orbitron; z-index:9999; text-align:center;
    }
    #pantallaCarga .spinner {
      width:60px; height:60px; border:6px solid #ffffff22;
      border-top:6px solid #0ff; border-radius:50%; animation:spin 1s linear infinite;
    }
    @keyframes spin { to { transform:rotate(360deg); } }

    #gameOverScreen { display:none; opacity:0; transition:opacity 1s; }
    #gameOverScreen.show { display:flex; opacity:1; }
    #reiniciarBtn {
      margin-top:20px; padding:12px 24px; background:#0ff; color:#000; border:none;
      border-radius:12px; font-size:18px; cursor:pointer; display:none;
    }
    #playerNameForm {
      display:none; flex-direction:column; align-items:center;
      background:rgba(0,0,0,0.85); padding:20px; border-radius:10px; z-index:10000;
    }
  </style>
</head>
<body>
  <!-- Preloader -->
  <div id="pantallaCarga">
    <div class="spinner"></div>
    <p style="font-size:20px; margin-top:20px;">Cargando CosmoDoge...</p>
  </div>

  <!-- HUD & UI -->
  <button id="conectarWalletBtn" class="fixed">üîó Conectar Wallet</button>
  <div id="balanceCDOGE"></div>
  <div id="balanceBCOSMO"></div>
  <div id="scoreDisplay"      class="hud">üöÄ x 0</div>
  <div id="coinDisplay"       class="hud">üí∞ x 0</div>
  <div id="highScoreDisplay"  class="hud">üîù M√°x: 0</div>
  <div id="contadorCDOGE"     class="hud">üí∞ CDOGE: 0</div>
  <div id="contadorBCOSMO"    class="hud">üêï BCOSMO: 0</div>
  <div id="shieldDisplay"     class="hud">üõ°Ô∏è Escudo: 0</div>
  <div id="nombreJugador"     class="hud"></div>
  <div id="imanContador"></div>

  <div id="menuPrincipal" class="fixed">
    <button id="btnTienda" class="btn">üõí Tienda</button>
    <button id="btnRanking" class="btn">üèÜ Ranking</button>
  </div>

  <!-- Tienda -->
  <div id="tiendaCDOGE">
    <h3 style="color:#0ff;">üõí Tienda CosmoDoge</h3>
    <div style="margin-bottom:15px; padding:10px; background:#111; border:1px solid #0ff; border-radius:10px;">
      <p style="color:#0ff;">üß≤ Im√°n Espacial (CDOGE)</p>
      <p style="color:#bbb;">Atrae monedas 1h</p>
      <button id="comprarImanCDOGE" class="btn">Comprar 1 500 $CDOGE</button>
    </div>
    <div style="margin-bottom:15px; padding:10px; background:#111; border:1px solid #0ff; border-radius:10px;">
      <p style="color:#0ff;">üß≤ Im√°n Espacial (BCOSMO)</p>
      <p style="color:#bbb;">Atrae monedas 1h</p>
      <button id="comprarImanBCOSMO" class="btn">Comprar 2 500 $BCOSMO</button>
    </div>
    <div style="padding:10px; background:#111; border:1px solid #faa; border-radius:10px;">
      <p style="color:#faa;">üõ°Ô∏è Escudo Protector</p>
      <p style="color:#bbb;">Protege 3 colisiones</p>
      <button id="comprarEscudo" class="btn">Comprar 1 000 ü™ô</button>
    </div>
  </div>

  <!-- Canvas -->
  <canvas id="gameCanvas" width="480" height="640"></canvas>

  <!-- Screens -->
  <div id="startScreen" style="display:none;">
    <h1>üöÄ CosmoDoge Flotante</h1>
    <button id="startButton" class="btn">¬°Comenzar!</button>
  </div>

  <div id="gameOverScreen">
    <h1>üö® GAME OVER üö®</h1>
    <p>Puntaje: <span id="finalScore">0</span></p>
    <button id="reiniciarBtn" class="btn">Reiniciar</button>
  </div>

  <div id="newRecordMessage" style="display:none;">
    <h1>üåü ¬°Nuevo r√©cord gal√°ctico!</h1>
    <p>Ingresa tu nombre para guardarlo.</p>
  </div>

  <!-- Formulario de nombre -->
  <div id="playerNameForm">
    <input type="text" id="playerName" placeholder="Tu nombre gal√°ctico"
           style="padding:10px; border:none; border-radius:8px; margin-bottom:10px;">
    <button id="saveScoreButton" class="btn">Guardar Puntaje</button>
  </div>

  <!-- Ranking -->
  <div id="rankingPanel">
    <div id="topRanking"></div>
    <button id="closeRanking" class="btn">Cerrar</button>
  </div>

  <!-- Firebase y l√≥gica on-chain -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getFirestore, collection, query, orderBy, limit, getDocs, addDoc, serverTimestamp }
      from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDaM9HtMtTlJXc-V4HfsZ7bbC__ZPe9zIk",
      authDomain: "cosmodogelive.firebaseapp.com",
      projectId: "cosmodogelive",
      storageBucket: "cosmodogelive.appspot.com",
      messagingSenderId: "648227069914",
      appId: "1:648227069914:web:3ef7ac8da4ab52c30deae3"
    };
    initializeApp(firebaseConfig);
    const db = getFirestore();

    window.guardarJugadorAutomatic = async (u, pts, mns) => {
      try {
        await addDoc(collection(db, "jugadores"), {
          nombre: String(u),
          puntaje: Number(pts),
          monedas: Number(mns),
          fecha: serverTimestamp()
        });
      } catch (e) {
        console.error(e);
      }
    };

    window.mostrarTopRanking = async () => {
      const lista = document.getElementById("topRanking");
      try {
        const snap = await getDocs(
          query(collection(db, "jugadores"), orderBy("puntaje", "desc"), limit(5))
        );
        let html = "<h2>üèÜ Top 5 CosmoDoge</h2><ul style='list-style:none;padding:0;'>";
        snap.forEach((doc, i) => {
          const d = doc.data();
          html += `<li>#${i+1} <strong>${d.nombre}</strong> ‚Äì ${d.puntaje} pts ‚Äì ${d.monedas} ü™ô</li>`;
        });
        lista.innerHTML = html + "</ul>";
      } catch {
        lista.innerHTML = "<p style='color:red;'>Error cargando ranking.</p>";
      }
    };
  </script>

  <!-- Juego y l√≥gica -->
  <script>
    // Canvas responsive
    const canvas = document.getElementById("gameCanvas"),
          ctx    = canvas.getContext("2d"),
          esMovil= /Mobi|Android/i.test(navigator.userAgent);

    if (esMovil) {
      function resize() {
        canvas.width  = window.innerWidth;
        canvas.height = window.innerHeight;
      }
      window.addEventListener("resize", resize);
      resize();
    }

    // Variables
    let score = 0,
        coins = parseInt(localStorage.getItem("cdogeCoins"))    || 0,
        highScore = parseInt(localStorage.getItem("cdogeFloatHighScore")) || 0,
        totalCDOGE = parseInt(localStorage.getItem("cdogeTotalCoins"))  || 0,
        totalBCOSMO = parseInt(localStorage.getItem("bcosmoTotalCoins")) || 0,
        shieldCount = parseInt(localStorage.getItem("shieldCount"))     || 0,
        gameStarted = false,
        isGameOver = false,
        timeElapsed = 0,
        lastScoreTime=0,
        lastFondoChange=0,
        lastObs = Date.now(),
        gravityLevels=[0.5,0.6,0.8,1.0],
        gravity=0.5,
        jump=-10;

    let coinsArr=[], obsArr=[], cdogeArr=[], bcosmoArr=[];

    const valorPorMoneda=50,
          valorBCOSMO=50,
          ubicaciones=[
            {x:80,y:100},{x:canvas.width-120,y:80},
            {x:canvas.width/2,y:canvas.height/3},
            {x:canvas.width-80,y:canvas.height-120},
            {x:100,y:canvas.height-150}
          ],
          fondos=["fondo-cosmodoge-v2.png","fondo-cosmodoge-v3.png","fondo-cosmodoge-v4.png"];

    let fi=0;
    const fondo=new Image(); fondo.src=fondos[0];

    const doge={x:80,y:200,w:50,h:50,v:0,img:new Image()};
    doge.img.src="cosmodoge-cohete-juego.png";

    const coinImg=new Image(); coinImg.src="coin-cosmodoge.png";
    const obsImgs=["obstaculo-estelar.png","obstaculo-explosion.png","obstaculo-explosion-aire.png"];
    const cdogeImg=new Image(); cdogeImg.src="moneda-cosmodoge.png";
    const bcosmoImg=new Image(); bcosmoImg.src="moneda-bcosmo.png";

    const sndJump=new Audio("jump.mp3"),
          sndCoin=new Audio("coin.mp3"),
          sndBoom=new Audio("boom.mp3"),
          sndRecord=new Audio("record.mp3"),
          sndCdoge=new Audio("sonido-moneda-cdoge.mp3"),
          sndBcosmo=new Audio("sonido-moneda-bcosmo.mp3"),
          music=new Audio("music-cosmodoge-theme.mp3");
    music.loop=true; music.volume=0.3;

    // On-chain
    const CDOGE_CON="0x5dE25281305992d3552a45A3D8ccA7BdfB4AcD3A",
          ERC20_ABI=[
            "function balanceOf(address) view returns(uint256)",
            "function decimals()    view returns(uint8)",
            "function transfer(address,uint256) returns(bool)"
          ],
          CDOGE_REC="0x1980dCdDA07071970dEAa69c975F590976Ee667D3A".toLowerCase(),
          MINT="2etLM91LBaxbQ1y3jnzQw8EXKNHAKcXJsHMJJ69opump",
          RCV="A6dnVgGaS1scC2m6hmPdK15D5gs5vDsHS8PEq3xtJKNx";

    // Utils
    function play(s){ s.currentTime=0; s.play().catch(()=>{}); }
    function showMsg(txt,x,y){
      const d=document.createElement("div");
      Object.assign(d.style,{
        position:"absolute", left:`${x}px`, top:`${y}px`,
        color:"#0ff", font:"18px Orbitron", zIndex:10000,
        transition:"all 1.5s"
      });
      d.textContent=txt; document.body.appendChild(d);
      setTimeout(()=>{ d.style.opacity=0; d.style.transform="translateY(-40px)"; },100);
      setTimeout(()=>d.remove(),1600);
    }
    function updCDOGE(){ document.getElementById("contadorCDOGE").textContent=`üí∞ CDOGE: ${totalCDOGE}`; }
    function updBCOSMO(){ document.getElementById("contadorBCOSMO").textContent=`üêï BCOSMO: ${totalBCOSMO}`; }
    function updShield(){ document.getElementById("shieldDisplay").textContent=`üõ°Ô∏è Escudo: ${shieldCount}`; }
    function updDiff(sec){
      gravity = sec>=75?gravityLevels[3]: sec>=45?gravityLevels[2]: sec>=30?gravityLevels[1]: gravityLevels[0];
    }

    // Im√°n
    let imanA=false, aura=false;
    function actIman(){
      localStorage.setItem("imanExpiracion", Date.now()+3600000);
      imanA=aura=true; showMsg("üß≤ Im√°n activo 1h", canvas.width/2, 100);
      chkIman(); setInterval(updIman,1000);
    }
    function chkIman(){
      const id=setInterval(()=>{
        const exp=parseInt(localStorage.getItem("imanExpiracion"))||0;
        if(Date.now()>=exp){
          imanA=aura=false; localStorage.removeItem("imanExpiracion");
          clearInterval(id); showMsg("‚è±Ô∏è Im√°n expirado", canvas.width/2, 100);
        }
      },1000);
    }
    function updIman(){
      const d=document.getElementById("imanContador"),
            exp=parseInt(localStorage.getItem("imanExpiracion"))||0,
            r=exp-Date.now();
      if(r>0){
        const m=Math.floor(r/60000), s=Math.floor((r%60000)/1000);
        d.textContent=`üß≤ Im√°n: ${m}:${s<10?'0':''}${s}`; d.style.display="block";
      } else d.style.display="none";
    }
    function drawAura(o){
      if(aura){
        ctx.beginPath();
        ctx.arc(o.x+o.w/2, o.y+o.h/2, o.w*0.8, 0, Math.PI*2);
        ctx.strokeStyle="#00ffff88"; ctx.lineWidth=4; ctx.stroke();
      }
    }

    // Escudo
    function buyShield(){
      if(coins<1000) return alert("No tienes suficientes ü™ô");
      coins-=1000; localStorage.setItem("cdogeCoins", coins);
      document.getElementById("coinDisplay").textContent=`üí∞ x ${coins}`;
      shieldCount=3; localStorage.setItem("shieldCount", shieldCount);
      updShield(); showMsg("üõ°Ô∏è Escudo adquirido (3)", canvas.width/2, 140);
    }
    function handleCollision(){
      if(shieldCount>0){
        shieldCount--; localStorage.setItem("shieldCount", shieldCount);
        updShield(); showMsg(`üõ°Ô∏è Escudo usado, quedan ${shieldCount}`, canvas.width/2, 160);
        return true;
      }
      return false;
    }

    // Monedas normales
    function spawnCoinGroup(){
      const amt=Math.floor(Math.random()*6)+5;
      for(let i=0;i<amt;i++){
        coinsArr.push({ x:canvas.width+i*40, y:Math.random()*(canvas.height-100), w:30, h:30, s:2 });
      }
    }
    function drawCoins(){
      for(let i=coinsArr.length-1;i>=0;i--){
        const c=coinsArr[i];
        if(imanA){
          const dx=c.x+15-(doge.x+doge.w/2),
                dy=c.y+15-(doge.y+doge.h/2),
                dist=Math.hypot(dx,dy);
          if(dist<200){
            const f=1-dist/200; c.x-=dx*0.05*f; c.y-=dy*0.05*f;
          }
        }
        c.x-=c.s; ctx.drawImage(coinImg,c.x,c.y,c.w,c.h);
        if(doge.x<c.x+c.w&&doge.x+doge.w>c.x&&doge.y<c.y+c.h&&doge.y+doge.h>c.y){
          coins++; localStorage.setItem("cdogeCoins", coins);
          document.getElementById("coinDisplay").textContent=`üí∞ x ${coins}`;
          play(sndCoin); coinsArr.splice(i,1);
        }
      }
    }

    // Obst√°culos
    function spawnObstacle(){
      const img=new Image(); img.src=obsImgs[Math.floor(Math.random()*obsImgs.length)];
      obsArr.push({ x:canvas.width, y:Math.random()*(canvas.height-50), w:50, h:50, sX:2+Math.random()*2, sY:0.5+Math.random()*1.5, img });
    }
    function drawObstacles(){
      obsArr.forEach((o,i)=>{
        o.x-=o.sX; o.y+=(o.y<doge.y?o.sY:-o.sY);
        ctx.drawImage(o.img,o.x,o.y,o.w,o.h);
        if(doge.x<o.x+o.w&&doge.x+doge.w>o.x&&doge.y<o.y+o.h&&doge.y+doge.h>o.y){
          if(!handleCollision()) gameOver();
        }
      });
      obsArr=obsArr.filter(o=>o.x+o.w>0);
    }

    // Monedas CDOGE
    function generateCDOGE(){
      if(cdogeArr.length<1){
        const p=ubicaciones[Math.floor(Math.random()*ubicaciones.length)];
        cdogeArr.push({ x:p.x, y:p.y, w:32, h:32, got:false });
      }
    }
    setInterval(generateCDOGE,20000);
    function drawCDOGE(){ cdogeArr.forEach(m=>{ if(!m.got) ctx.drawImage(cdogeImg,m.x,m.y,m.w,m.h); }); }
    function collectCDOGE(){
      cdogeArr.forEach(m=>{
        if(!m.got){
          const dx=m.x+16-(doge.x+doge.w/2),
                dy=m.y+16-(doge.y+doge.h/2),
                dist=Math.hypot(dx,dy);
          if(imanA&&dist<200){
            const f=1-dist/200; m.x-=dx*0.05*f; m.y-=dy*0.05*f;
          }
          if(dist<20){
            m.got=true; totalCDOGE+=valorPorMoneda;
            localStorage.setItem("cdogeTotalCoins", totalCDOGE);
            play(sndCdoge); showMsg(`+${valorPorMoneda} CDOGE`, m.x, m.y);
            updCDOGE();
          }
        }
      });
    }

    // Monedas BCOSMO
    function generateBCOSMO(){
      if(bcosmoArr.length<1){
        const p=ubicaciones[Math.floor(Math.random()*ubicaciones.length)];
        bcosmoArr.push({ x:p.x, y:p.y, w:32, h:32, got:false });
      }
    }
    setInterval(generateBCOSMO,30000);
    function drawBCOSMO(){ bcosmoArr.forEach(m=>{ if(!m.got) ctx.drawImage(bcosmoImg,m.x,m.y,m.w,m.h); }); }
    function collectBCOSMO(){
      bcosmoArr.forEach(m=>{
        if(!m.got){
          const dx=m.x+16-(doge.x+doge.w/2),
                dy=m.y+16-(doge.y+doge.h/2),
                dist=Math.hypot(dx,dy);
          if(imanA&&dist<200){
            const f=1-dist/200; m.x-=dx*0.05*f; m.y-=dy*0.05*f;
          }
          if(dist<20){
            m.got=true; totalBCOSMO+=valorBCOSMO;
            localStorage.setItem("bcosmoTotalCoins", totalBCOSMO);
            play(sndBcosmo); showMsg(`+${valorBCOSMO} BCOSMO`, m.x, m.y);
            updBCOSMO();
          }
        }
      });
    }

    function drawBackground(){ ctx.drawImage(fondo,0,0,canvas.width,canvas.height); }
    function drawDoge(){ ctx.drawImage(doge.img,doge.x,doge.y,doge.w,doge.h); drawAura(doge); }

    let lastTime=0;
    function loop(ts){
      if(isGameOver) return;
      if(!lastTime) lastTime=ts;
      const dt = ts - lastTime; lastTime=ts;

      ctx.clearRect(0,0,canvas.width,canvas.height);
      drawBackground();

      doge.v += gravity * dt/16;
      doge.y += doge.v * dt/16;
      if(doge.y+doge.h>=canvas.height||doge.y<=0){
        if(!handleCollision()) return gameOver();
        doge.y = canvas.height/2;
      }

      drawDoge();
      drawCoins();
      drawObstacles();
      drawCDOGE(); collectCDOGE();
      drawBCOSMO(); collectBCOSMO();

      timeElapsed += dt;
      const sec = timeElapsed/1000;
      if(sec - lastScoreTime >=5){
        score++; lastScoreTime=sec;
        document.getElementById("scoreDisplay").textContent=`üöÄ x ${score}`;
      }
      if(sec - lastFondoChange >=30){
        fi = (fi+1)%fondos.length;
        fondo.src = fondos[fi];
        lastFondoChange=sec;
      }
      if(Math.floor(timeElapsed/16)%150===0) spawnCoinGroup();

      const now=Date.now(),
            interval = timeElapsed/16>=3600?1000: timeElapsed/16>=1800?2000:3000;
      if(now - lastObs >= interval){
        spawnObstacle(); lastObs=now;
      }
      updDiff(sec);
      requestAnimationFrame(loop);
    }

    function gameOver(){
      isGameOver=true;
      music.pause(); music.currentTime=0;
      document.getElementById("finalScore").textContent = score;
      const go = document.getElementById("gameOverScreen");
      go.style.display="flex"; setTimeout(()=>go.classList.add("show"),10);
      setTimeout(()=>document.getElementById("reiniciarBtn").style.display="block",1500);

      if(score > highScore){
        localStorage.setItem("cdogeFloatHighScore", score);
        highScore = score;
        document.getElementById("highScoreDisplay").textContent=`üîù M√°x: ${highScore}`;
        document.getElementById("newRecordMessage").style.display="flex";
        play(sndRecord);
        const u = localStorage.getItem("cosmodogeliveUserName");
        if(!u) document.getElementById("playerNameForm").style.display="flex";
        else guardarJugadorAutomatic(u,score,coins).then(mostrarTopRanking);
      } else {
        play(sndBoom);
      }
    }

    // UI controls
    function toggleTienda(){
      const t = document.getElementById("tiendaCDOGE");
      t.style.display = t.style.display==="block" ? "none" : "block";
    }
    function toggleRanking(){
      const r = document.getElementById("rankingPanel");
      if(r.style.display==="block") r.style.display="none";
      else { mostrarTopRanking(); r.style.display="block"; }
    }
    function mostrarSelectorWallet(){
      const opt = prompt("Selecciona tu wallet:\n1 - MetaMask\n2 - Phantom");
      if(opt==="1") conectarMetaMask();
      else if(opt==="2") conectarPhantom();
      else alert("Opci√≥n inv√°lida");
    }

    async function conectarMetaMask(){
      if(!window.ethereum){
        if(esMovil) location.href = `https://metamask.app.link/dapp/${encodeURIComponent(location.href)}`;
        else return alert("Instala MetaMask");
      }
      try{
        const acc = await ethereum.request({method:'eth_requestAccounts'}), acct = acc[0];
        document.getElementById("conectarWalletBtn").textContent=`üîó ${acct.slice(0,6)}‚Ä¶${acct.slice(-4)}`;
        const prov = new ethers.providers.Web3Provider(window.ethereum),
              c    = new ethers.Contract(CDOGE_CON, ERC20_ABI, prov),
              b    = await c.balanceOf(acct),
              d    = await c.decimals(),
              fmt  = Number(b/10**d).toLocaleString();
        document.getElementById("balanceCDOGE").innerHTML=`üöÄ ${fmt} CDOGE`;
        document.getElementById("balanceCDOGE").style.display="block";
      } catch(e){
        console.error(e); alert("Error MetaMask");
      }
    }

    async function conectarPhantom(){
      try{
        const p = window.solana;
        if(!p||!p.isPhantom) throw new Error("Instala Phantom Wallet");
        const resp = await p.connect(), pub = resp.publicKey;
        showMsg(`üåê Phantom: ${pub.toString().slice(0,6)}‚Ä¶${pub.toString().slice(-4)}`, canvas.width/2, 80);
        const conn = new solanaWeb3.Connection("https://api.mainnet-beta.solana.com","confirmed"),
              toks = await conn.getParsedTokenAccountsByOwner(pub, {programId:solanaWeb3.TOKEN_PROGRAM_ID});
        let bal = 0;
        toks.value.forEach(({account})=>{
          const info = account.data.parsed.info;
          if(info.mint===MINT) bal = info.tokenAmount.uiAmount;
        });
        document.getElementById("balanceBCOSMO").innerHTML=`üêï ${bal||0} BCOSMO`;
        document.getElementById("balanceBCOSMO").style.display="block";
      } catch(e){
        console.error(e); alert(e.message);
      }
    }

    async function comprarImanCDOGE(){
      try{
        if(!window.ethereum) return alert("Instala MetaMask");
        const acc = await ethereum.request({method:'eth_requestAccounts'});
        const prov = new ethers.providers.Web3Provider(window.ethereum),
              signer = prov.getSigner(),
              c = new ethers.Contract(CDOGE_CON, ERC20_ABI, signer),
              d = await c.decimals(),
              amt = ethers.utils.parseUnits("1500", d),
              tx = await c.transfer(CDOGE_REC, amt);
        await tx.wait();
        actIman(); chkIman();
        showMsg("üß≤ Im√°n comprado con CDOGE", canvas.width/2, 100);
      } catch(e){
        console.error(e); alert("Error comprando im√°n CDOGE");
      }
    }

    async function comprarImanBCOSMO(){
      try{
        const p = window.solana;
        if(!p||!p.isPhantom) throw new Error("Instala Phantom Wallet");
        const resp = await p.connect(), pub = resp.publicKey;
        const conn = new solanaWeb3.Connection("https://api.mainnet-beta.solana.com","confirmed"),
              mintPub = new solanaWeb3.PublicKey(MINT),
              recPub  = new solanaWeb3.PublicKey(RCV),
              mi = await conn.getParsedAccountInfo(mintPub),
              dec = mi.value.data.parsed.info.decimals,
              sAcc = await splToken.getOrCreateAssociatedTokenAccount(conn, pub, mintPub, pub),
              rAcc = await splToken.getOrCreateAssociatedTokenAccount(conn, pub, mintPub, recPub),
              amount = 2500 * 10**dec,
              ix = splToken.createTransferCheckedInstruction(sAcc.address, mintPub, rAcc.address, pub, amount, dec),
              tx = new solanaWeb3.Transaction().add(ix);
        tx.feePayer = pub;
        tx.recentBlockhash = (await conn.getRecentBlockhash()).blockhash;
        const signed = await p.signTransaction(tx),
              sig    = await conn.sendRawTransaction(signed.serialize());
        await conn.confirmTransaction(sig);
        actIman(); chkIman();
        showMsg("üß≤ Im√°n comprado con BCOSMO", canvas.width/2, 120);
      } catch(e){
        console.error(e); alert("Error comprando im√°n BCOSMO");
      }
    }

    // DOMContentLoaded
    window.addEventListener("DOMContentLoaded", () => {
      setTimeout(()=>{
        document.getElementById("pantallaCarga").style.display="none";
        document.getElementById("startScreen").style.display="flex";
      }, 3000);

      document.getElementById("coinDisplay").textContent      = `üí∞ x ${coins}`;
      document.getElementById("highScoreDisplay").textContent = `üîù M√°x: ${highScore}`;
      updCDOGE(); updBCOSMO(); updShield(); chkIman();

      document.getElementById("conectarWalletBtn").addEventListener("click", mostrarSelectorWallet);
      document.getElementById("btnTienda").addEventListener("click", toggleTienda);
      document.getElementById("btnRanking").addEventListener("click", toggleRanking);
      document.getElementById("comprarImanCDOGE").addEventListener("click", comprarImanCDOGE);
      document.getElementById("comprarImanBCOSMO").addEventListener("click", comprarImanBCOSMO);
      document.getElementById("comprarEscudo").addEventListener("click", buyShield);
      document.getElementById("closeRanking").addEventListener("click", toggleRanking);

      document.getElementById("startButton").addEventListener("click", () => {
        document.getElementById("startScreen").style.display = "none";
        document.getElementById("conectarWalletBtn").classList.add("hiddenUI");
        document.getElementById("menuPrincipal").classList.add("hiddenUI");
        gameStarted = true;
        music.play();
        requestAnimationFrame(loop);
      });

      document.getElementById("reiniciarBtn").addEventListener("click", () => location.reload());

      document.getElementById("saveScoreButton").addEventListener("click", () => {
        const n = document.getElementById("playerName").value.trim();
        if (!n) return alert("Ingresa tu nombre");
        localStorage.setItem("cosmodogeliveUserName", n);
        document.getElementById("playerNameForm").style.display = "none";
        guardarJugadorAutomatic(n, score, coins).then(mostrarTopRanking);
      });

      document.addEventListener("keydown", e => {
        if (e.code === "Space" && gameStarted && !isGameOver) {
          doge.v = jump;
          play(sndJump);
        }
      });

      document.addEventListener("visibilitychange", () => {
        if (document.hidden && gameStarted && !isGameOver) {
          cancelAnimationFrame(loop);
        }
      });
    });
  </script>
</body>
</html>
