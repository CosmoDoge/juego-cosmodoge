<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CosmoDoge Flotante 🚀</title>

  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.41.0/lib/index.iife.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@solana/spl-token@0.3.5/lib/index.iife.min.js"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { width: 100%; height: 100%; overflow: hidden; background: black; font-family: 'Orbitron', Arial, sans-serif; }
    canvas { display: block; margin: auto; max-width: 100vw; max-height: 100vh; }
    #pantallaCarga { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: black; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; color: white; font-size: 20px; }
    .spinner { width: 60px; height: 60px; border: 6px solid #ffffff22; border-top: 6px solid #0ff; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    #startScreen { display: none; flex-direction: column; align-items: center; justify-content: center; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 9998; }
    #startBackground { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: url('fondo-cosmodoge-inicio.png') repeat; background-size: cover; animation: scrollBg 60s linear infinite; }
    @keyframes scrollBg { 0% { background-position: 0 0; } 100% { background-position: 0 1000px; } }
    #tituloInicio { z-index: 2; color: #0ff; font-size: 48px; text-shadow: 0 0 20px #0ff; animation: aparecer 2s ease forwards; }
    @keyframes aparecer { from { opacity: 0; transform: translateY(-50px); } to { opacity: 1; transform: translateY(0); } }
    #dogeInicio { z-index: 2; width: 100px; margin-top: 30px; animation: flotar 3s ease-in-out infinite; }
    @keyframes flotar { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
    #startButton { z-index: 2; margin-top: 40px; padding: 12px 24px; background: #0ff; color: black; border: none; border-radius: 12px; font-weight: bold; font-size: 18px; cursor: pointer; }
    /* HUD */
    .hud { position: absolute; color: white; text-shadow: 2px 2px 5px #000; z-index: 1000; font: 18px 'Orbitron', sans-serif; }
    #scoreDisplay { top: 10px; left: 10px; }
    #coinDisplay { top: 40px; left: 10px; }
    #highScoreDisplay { top: 70px; left: 10px; }
    #contadorCDOGE { top: 100px; left: 10px; color: #0ff; }
    #contadorBCOSMO { top: 130px; left: 10px; color: #faa200; }
    #shieldDisplay { top: 160px; left: 10px; color: #faa; display: none; }
    #balanceCDOGE, #balanceBCOSMO {
      position: absolute; right: 20px; padding: 10px; border-radius: 8px;
      background: rgba(0,0,0,0.7); font: 16px 'Orbitron', sans-serif; color: #0ff; display: none; z-index: 1000;
    }
    #balanceBCOSMO { top: 110px; }
    .fixed { position: fixed; z-index: 10000; transition: opacity .3s; }
    .hiddenUI { opacity: 0; }
    #conectarWalletBtn {
      top: 20px; right: 20px; background: #0ff; color: #000; border: none;
      border-radius: 12px; padding: 10px 20px; font: 16px 'Orbitron', sans-serif; cursor: pointer;
    }
    #menuPrincipal { top: 70px; right: 20px; display: flex; flex-direction: column; gap: 10px; }
    .btn {
      padding: 1rem 2rem; background: #0ff; border: none; border-radius: 10px;
      color: #000; font-size: 1.2rem; font-weight: bold; cursor: pointer;
      transition: transform .2s, box-shadow .2s;
    }
    .btn:hover { transform: scale(1.05); box-shadow: 0 0 10px #0ff; }
    #tiendaCDOGE, #rankingPanel {
      position: fixed; background: rgba(0,0,0,0.85); padding: 15px;
      border-radius: 15px; box-shadow: 0 0 15px #0ff; font: 14px 'Orbitron', sans-serif; color: #fff;
      z-index: 10001; display: none;
    }
    #tiendaCDOGE { bottom: 20px; left: 20px; width: 320px; border: 2px solid #0ff; }
    #rankingPanel { top: 200px; left: 50%; transform: translateX(-50%); }
  </style>
</head>

<body>
<div id="pantallaCarga">
  <div class="spinner"></div>
  <p>Cargando CosmoDoge...</p>
</div>

<div id="startScreen">
  <div id="startBackground"></div>
  <h1 id="tituloInicio">🚀 CosmoDoge Flotante 🚀</h1>
  <img id="dogeInicio" src="cosmodoge-cohete-juego.png" alt="CosmoDoge" />
  <button id="startButton">¡Comenzar!</button>
</div>

<canvas id="gameCanvas"></canvas>

<button id="conectarWalletBtn" class="fixed">🔗 Conectar Wallet</button>
<div id="balanceCDOGE"></div>
<div id="balanceBCOSMO"></div>
<div id="scoreDisplay" class="hud">🚀 x 0</div>
<div id="coinDisplay" class="hud">💰 x 0</div>
<div id="highScoreDisplay" class="hud">🔝 Máx: 0</div>
<div id="contadorCDOGE" class="hud">💰 CDOGE: 0</div>
<div id="contadorBCOSMO" class="hud">🐕 BCOSMO: 0</div>
<div id="shieldDisplay" class="hud"></div>

<div id="menuPrincipal" class="fixed">
  <button id="btnTienda" class="btn">🛒 Tienda</button>
  <button id="btnRanking" class="btn">🏆 Ranking</button>
</div>

<div id="tiendaCDOGE">
  <h3 style="color:#0ff;">🛒 Tienda CosmoDoge</h3>
  <div style="margin-bottom:15px;padding:10px;background:#111;border:1px solid #0ff;border-radius:10px;">
    <p style="color:#0ff;">🧲 Imán Espacial (CDOGE)</p>
    <p style="color:#bbb;">Atrae monedas 1h</p>
    <button id="comprarImanCDOGE" class="btn">Comprar 1500 $CDOGE</button>
  </div>
  <div style="margin-bottom:15px;padding:10px;background:#111;border:1px solid #0ff;border-radius:10px;">
    <p style="color:#0ff;">🧲 Imán Espacial (BCOSMO)</p>
    <p style="color:#bbb;">Atrae monedas 1h</p>
    <button id="comprarImanBCOSMO" class="btn">Comprar 2500 $BCOSMO</button>
  </div>
  <div style="padding:10px;background:#111;border:1px solid #faa;border-radius:10px;">
    <p style="color:#faa;">🛡️ Escudo Protector</p>
    <p style="color:#bbb;">Inmune 3 colisiones</p>
    <button id="comprarEscudo" class="btn">Comprar 1000 🪙</button>
  </div>
</div>

<div id="rankingPanel">
  <div id="topRanking"></div>
  <button id="closeRanking" class="btn">Cerrar</button>
</div>
<script type="module">
  // Importaciones Firebase
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
  import { getFirestore, collection, query, orderBy, limit, getDocs, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";
  
  // Configuración Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyDaM9HtMtTlJXc-V4HfsZ7bbC__ZPe9zIk",
    authDomain: "cosmodogelive.firebaseapp.com",
    projectId: "cosmodogelive",
    storageBucket: "cosmodogelive.appspot.com",
    messagingSenderId: "648227069914",
    appId: "1:648227069914:web:3ef7ac8da4ab52c30deae3"
  };
  initializeApp(firebaseConfig);
  const db = getFirestore();
  
  // Funciones de Ranking
  window.guardarJugadorAutomatic = async (u, pts, mns) => {
    await addDoc(collection(db, "jugadores"), {
      nombre: u,
      puntaje: pts,
      monedas: mns,
      fecha: serverTimestamp()
    });
  };
  window.mostrarTopRanking = async () => {
    const lista = document.getElementById("topRanking");
    const snap = await getDocs(query(collection(db, "jugadores"), orderBy("puntaje", "desc"), limit(5)));
    let html = "<h2>🏆 Top 5 CosmoDoge</h2><ul style='list-style:none;padding:0;'>";
    snap.forEach((doc, i) => {
      const d = doc.data();
      html += `<li>#${i+1} <strong>${d.nombre}</strong> – ${d.puntaje} pts – ${d.monedas} 🪙</li>`;
    });
    lista.innerHTML = html + "</ul>";
  };
  
  // Juego (Aquí empieza el motor)
  const canvas = document.getElementById('gameCanvas');
  const ctx = canvas.getContext('2d');
  resizeCanvas();
  window.addEventListener('resize', resizeCanvas);
  
  function resizeCanvas() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
  }
  
  let score = 0, coins = 0, highScore = 0;
  let fondos = ["fondo-cosmodoge-v2.png", "fondo-cosmodoge-v3.png", "fondo-cosmodoge-v4.png"];
  let fondoImg = new Image(); fondoImg.src = fondos[0];
  let doge = { x: 80, y: window.innerHeight/2, w: 50, h: 50, v: 0, img: new Image() };
  doge.img.src = 'cosmodoge-cohete-juego.png';
  let coinsArr = [], obsArr = [], cofresArr = [], agujeroArr = [];
  let gravity = 0.5, jumpPower = -10, isGameOver = false, gameStarted = false;
  let timeElapsed = 0, lastFondoChange = 0, lastScoreTime = 0;
  
  // Preload Recursos
  const recursos = [
    'coin-cosmodoge.png','cofre-espacial.png','obstaculo-estelar.png','obstaculo-explosion.png',
    'obstaculo-explosion-aire.png','obstaculo-agujero-negro.png','fondo-cosmodoge-inicio.png',
    'jump.mp3','coin.mp3','boom.mp3','record.mp3'
  ];
  for (const path of recursos) {
    if (path.endsWith('.mp3')) new Audio(path);
    else { const img = new Image(); img.src = path; }
  }
  
  // Inicio
  document.getElementById('startButton').addEventListener('click', () => {
    document.getElementById('startScreen').style.display = 'none';
    gameStarted = true;
    isGameOver = false;
    score = 0; coins = 0;
    fondoImg.src = fondos[0];
    doge.y = canvas.height / 2;
    requestAnimationFrame(loop);
  });
  
  // HUD
  function actualizarHUD() {
    document.getElementById('scoreDisplay').textContent = `🚀 x ${score}`;
    document.getElementById('coinDisplay').textContent = `💰 x ${coins}`;
  }
  
  // Loop
  function loop(ts) {
    if (!gameStarted || isGameOver) return;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(fondoImg, 0, 0, canvas.width, canvas.height);
    doge.v += gravity;
    doge.y += doge.v;
    ctx.drawImage(doge.img, doge.x, doge.y, doge.w, doge.h);
    if (doge.y+doge.h >= canvas.height || doge.y <= 0) { isGameOver = true; return alert("🚨 Game Over"); }
    actualizarHUD();
    requestAnimationFrame(loop);
  }
  
  // Botones adicionales
  document.getElementById('btnTienda').addEventListener('click', () => {
    const tienda = document.getElementById('tiendaCDOGE');
    tienda.style.display = tienda.style.display === 'block' ? 'none' : 'block';
  });
  document.getElementById('btnRanking').addEventListener('click', () => {
    const ranking = document.getElementById('rankingPanel');
    ranking.style.display = ranking.style.display === 'block' ? 'none' : 'block';
    if (ranking.style.display === 'block') window.mostrarTopRanking();
  });
  document.getElementById('closeRanking').addEventListener('click', () => {
    document.getElementById('rankingPanel').style.display = 'none';
  });
  
  // Wallets
  document.getElementById('conectarWalletBtn').addEventListener('click', () => {
    const opt = prompt('Selecciona tu wallet:\n1 - MetaMask\n2 - Phantom');
    if (opt==='1') conectarMetaMask();
    else if (opt==='2') conectarPhantom();
    else alert('Opción inválida');
  });
  
  async function conectarMetaMask() {
    if (!window.ethereum) return alert('Instala MetaMask');
    const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
    const acct = accounts[0];
    document.getElementById('conectarWalletBtn').textContent = `🔗 ${acct.slice(0,6)}…${acct.slice(-4)}`;
  }
  async function conectarPhantom() {
    if (!window.solana || !window.solana.isPhantom) return alert('Instala Phantom');
    const resp = await window.solana.connect();
    const pub = resp.publicKey.toString();
    document.getElementById('conectarWalletBtn').textContent = `🔗 ${pub.slice(0,6)}…${pub.slice(-4)}`;
  }
  
  // Tienda
  document.getElementById('comprarImanCDOGE').addEventListener('click', () => alert('Compra de Imán con $CDOGE simulada.'));
  document.getElementById('comprarImanBCOSMO').addEventListener('click', () => alert('Compra de Imán con $BCOSMO simulada.'));
  document.getElementById('comprarEscudo').addEventListener('click', () => alert('Compra de Escudo con monedas internas.'));
  
  // Final del Script
  </script>
  </body>
  </html>
