<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <!-- Vista adaptable para m√≥viles -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CosmoDoge Flotante üöÄ</title>
  
  <!-- Librer√≠as externas -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.41.0/lib/index.iife.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@solana/spl-token@0.3.5/lib/index.iife.min.js"></script>
  
  <style>
    /* ======================= */
    /* Estilos generales */
    /* ======================= */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { overflow: hidden; width:100%; height:100%; touch-action:none; background:black; font-family:Arial; }
    canvas { display:block; margin:auto; max-width:100vw; max-height:100vh; }
    .absolute { position:absolute; color:white; text-shadow:2px 2px 5px #000; z-index:1000; }
    #scoreDisplay { top:10px; left:10px; font-size:18px; }
    #coinDisplay  { top:40px; left:10px; font-size:18px; }
    #highScoreDisplay { top:70px; left:10px; font-size:18px; }
    #contadorCDOGE { top:100px; left:10px; font:18px 'Orbitron',sans-serif; color:#0ff; }
    #nombreJugador { top:10px; left:50%; transform:translateX(-50%); font:18px 'Orbitron'; color:#0ff; }
    #balanceCDOGE, #balanceBCOSMO { right:20px; background:rgba(0,0,0,0.7); padding:10px; border-radius:10px; display:none; font:16px 'Orbitron'; color:#0ff; top:70px; }
    #balanceBCOSMO { top:110px; }
    #imanContador { top:130px; right:20px; background:rgba(0,0,0,0.75); padding:8px; border-radius:10px; display:none; font:16px 'Orbitron'; color:#0ff; }

    /* Botones */
    .fixed { position:fixed; z-index:10000; }
    #conectarWalletBtn { top:20px; right:20px; background:#0ff; color:#000; border:none; border-radius:12px; padding:10px 20px; font:16px 'Orbitron'; cursor:pointer; }
    #menuPrincipal { top:70px; right:20px; display:flex; flex-direction:column; gap:10px; }
    #tiendaCDOGE { bottom:20px; left:20px; width:320px; background:rgba(0,0,0,0.85); border:2px solid #0ff; border-radius:15px; padding:15px; display:none; box-shadow:0 0 15px #0ff; font:'Orbitron'; color:#fff; }
    .btn { padding:1rem 2rem; background:#0ff; border:none; border-radius:10px; color:#000; font-size:1.2rem; font-weight:bold; cursor:pointer; transition:background 0.3s; }
    .btn:hover { background:#0dde; }

    /* Pantallas */
    #pantallaCarga, #startScreen, #newRecordMessage, #gameOverScreen {
      position:fixed; top:0; left:0; width:100vw; height:100vh;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      background:rgba(0,0,0,0.85); color:white; font:'Orbitron'; z-index:9999;
    }
    #pantallaCarga .spinner { width:60px; height:60px; border:6px solid #ffffff22; border-top:6px solid #0ff; border-radius:50%; animation:spin 1s linear infinite; }
    @keyframes spin { to { transform:rotate(360deg); } }
    #gameOverScreen { opacity:0; transition:opacity 1s ease-in-out; }
    #gameOverScreen.show { opacity:1; }
    #reiniciarBtn { margin-top:20px; padding:12px 24px; background:#0ff; color:#000; border:none; border-radius:12px; font-size:18px; display:none; cursor:pointer; }
    #reiniciarBtn:hover { background:#0dde; }

    #playerNameForm { position:relative; z-index:20; display:none; flex-direction:column; align-items:center; background:rgba(0,0,0,0.85); padding:20px; border-radius:10px; }
    #rankingPanel { position:fixed; top:200px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.85); padding:20px; border-radius:10px; display:none; font:'Orbitron'; color:#fff; z-index:1000; }
  </style>
</head>

<body>
  <!-- Preloader -->
  <div id="pantallaCarga">
    <div class="spinner"></div>
    <p style="font-size:20px; margin-top:20px; text-align:center;">Iniciando viaje intergal√°ctico...</p>
  </div>

  <!-- HUD & UI -->
  <button id="conectarWalletBtn" class="fixed">üîó Conectar Wallet</button>
  <div id="balanceCDOGE" class="absolute"></div>
  <div id="balanceBCOSMO" class="absolute"></div>
  <div id="imanContador" class="absolute">üß≤ Im√°n activo: 60:00</div>

  <div id="menuPrincipal" class="fixed">
    <button onclick="toggleTienda()">üõí Tienda</button>
  </div>
  <div id="tiendaCDOGE">
    <h3 style="color:#0ff;">üõí Tienda CosmoDoge</h3>
    <div style="background:#111; padding:10px; border:1px solid #0ff; border-radius:10px;">
      <p style="color:#0ff;">üß≤ Im√°n Espacial</p>
      <p style="color:#bbb;">Atrae monedas por 1 hora.</p>
      <button id="comprarIman" style="background:#0ff; width:100%;">Comprar por 1,500 $CDOGE</button>
      <button id="comprarImanBCOSMO" style="background:#fa0; width:100%; margin-top:8px;">Comprar por 2,500 $BCOSMO</button>
    </div>
  </div>

  <canvas id="gameCanvas" width="480" height="640"></canvas>
  <div id="scoreDisplay"     class="absolute">üöÄ x 0</div>
  <div id="coinDisplay"      class="absolute">üí∞ x 0</div>
  <div id="highScoreDisplay" class="absolute">üîù M√°x: 0</div>
  <div id="contadorCDOGE"    class="absolute">üí∞ CDOGE: 0</div>
  <div id="nombreJugador"    class="absolute"></div>

  <!-- Pantallas de control -->
  <div id="startScreen" style="display:none;">
    <h1>üöÄ Mant√©n a CosmoDoge flotando</h1>
    <button class="btn" id="startButton">¬°Comenzar!</button>
  </div>
  <div id="gameOverScreen" style="display:flex; flex-direction:column; align-items:center; justify-content:center;">
    <h1>üö® GAME OVER üö®</h1>
    <p>Puntaje: <span id="finalScore">0</span></p>
    <button id="reiniciarBtn" class="btn">Reiniciar</button>
  </div>
  <div id="newRecordMessage" style="display:none;">
    <h1>üåü ¬°Nuevo r√©cord gal√°ctico!</h1>
    <p>üèÜ ¬°Has superado todos los l√≠mites!</p>
  </div>

  <div id="playerNameForm">
    <input type="text" id="playerName" placeholder="Tu nombre gal√°ctico" style="padding:10px; border:none; border-radius:8px; margin-bottom:10px;">
    <button class="btn" id="saveScoreButton">Guardar Puntaje</button>
  </div>
  <div id="rankingPanel">
    <div id="topRanking"></div>
    <button class="btn" onclick="document.getElementById('rankingPanel').style.display='none'">Cerrar</button>
  </div>

  <button id="reanudarBtn" class="fixed btn" style="
    top:50%; left:50%; transform:translate(-50%,-50%);
    display:none;
  ">Reanudar Juego</button>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getFirestore, collection, query, orderBy, limit, getDocs, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";
    const firebaseConfig = {
      apiKey: "AIzaSyDaM9HtMtTlJXc-V4HfsZ7bbC__ZPe9zIk",
      authDomain: "cosmodogelive.firebaseapp.com",
      projectId: "cosmodogelive",
      storageBucket: "cosmodogelive.appspot.com",
      messagingSenderId: "648227069914",
      appId: "1:648227069914:web:3ef7ac8da4ab52c30deae3"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    window.guardarJugadorAutomatic = async (username, puntaje, monedas) => {
      const data = { nombre:String(username), puntaje:Number(puntaje), monedas:Number(monedas), fecha: serverTimestamp() };
      try { await addDoc(collection(db, "jugadores"), data); }
      catch(e){ console.error("Error guardando jugador:",e); }
    };

    window.mostrarTopRanking = async () => {
      const lista = document.getElementById("topRanking");
      try {
        const q = query(collection(db, "jugadores"), orderBy("puntaje","desc"), limit(5));
        const snap = await getDocs(q);
        let html = "<h2>üèÜ Top 5 CosmoDoge</h2><ul style='list-style:none;padding:0;'>";
        snap.forEach((doc,i)=> {
          const d = doc.data();
          html += `<li>#${i+1} <strong>${d.nombre}</strong> - ${d.puntaje} pts - ${d.monedas} ü™ô</li>`;
        });
        lista.innerHTML = html+"</ul>";
      } catch(e){
        lista.innerHTML="<p style='color:red;'>No se pudo cargar ranking.</p>";
      }
    };
  </script>

  <script>
    // ---------- CONFIG & ASSETS ----------
    const canvas = document.getElementById("gameCanvas"), ctx = canvas.getContext("2d");
    const esMovil = /Mobi|Android/i.test(navigator.userAgent);
    let score=0, coins= parseInt(localStorage.getItem("cdogeCoins"))||0;
    let highScore=parseInt(localStorage.getItem("cdogeFloatHighScore"))||0;
    let totalCDOGERecolectado=parseInt(localStorage.getItem("cdogeTotalCoins"))||0;
    let gameStarted=false, isGameOver=false, timeElapsed=0, lastScoreTime=0, lastFondoChange=0, lastObstacleSpawn=Date.now();
    let gravityLevels=[0.5,0.6,0.8,1.0], gravity=gravityLevels[0], jump=-10;
    let coinsArray=[], specialObstacles=[], monedasCDOGE=[], monedasBCOSMO=[];
    const valorPorMoneda=50, valorBCOSMO=50;
    const ubicacionesDificiles=[{x:80,y:100},{x:canvas.width-120,y:80},{x:canvas.width/2,y:canvas.height/3},{x:canvas.width-80,y:canvas.height-120},{x:100,y:canvas.height-150}];
    const fondos=["fondo-cosmodoge-v2.png","fondo-cosmodoge-v3.png","fondo-cosmodoge-v4.png"];
    let fondoIndex=0;
    const fondo=new Image(); fondo.src=fondos[0];
    const doge={x:80,y:200,width:50,height:50,velocity:0,img:new Image()};
    doge.img.src="cosmodoge-cohete-juego.png";
    const coinImg=new Image(); coinImg.src="coin-cosmodoge.png";
    const obstacleImgs=["obstaculo-estelar.png","obstaculo-explosion.png","obstaculo-explosion-aire.png"];
    const imagenMoneda=new Image(); imagenMoneda.src="moneda-cosmodoge.png";
    const imagenBCOSMO=new Image(); imagenBCOSMO.src="moneda-bcosmo.png";
    const sndJump=new Audio("jump.mp3"), sndCoin=new Audio("coin.mp3"), sndBoom=new Audio("boom.mp3"), sndRecord=new Audio("record.mp3");
    const sonidoMoneda=new Audio("sonido-moneda-cdoge.mp3"), sonidoBCOSMO=new Audio("sonido-moneda-bcosmo.mp3");
    const music=new Audio("music-cosmodoge-theme.mp3"); music.loop=true; music.volume=0.3;

    // IDs & configuraci√≥n on-chain
    const CDOGE_CONTRACT="0x5dE25281305992d3552a45A3D8ccA7BdfB4AcD3A";
    const ERC20_ABI=[ "function balanceOf(address) view returns(uint256)", "function decimals() view returns(uint8)", "function transfer(address,uint256) returns(bool)" ];
    const CDOGE_RECIPIENT="0x1980dCdDA07071970dEAa69c975F590976Ee667D3A".toLowerCase();
    const BCOSMO_MINT="2etLM91LBaxbQ1y3jnzQw8EXKNHAKcXJsHMJJ69opump";
    const BCOSMO_WALLET_RECEIVE="A6dnVgGaS1scC2m6hmPdK15D5gs5vDsHS8PEq3xtJKNx";

    // ---------- UTILIDADES ----------
    function playSound(s){ s.currentTime=0; s.play().catch(()=>{}); }
    function mostrarMensajeTemporal(texto,x,y){
      const d=document.createElement("div");
      Object.assign(d.style,{position:"absolute",left:`${x}px`,top:`${y}px`,color:"#0ff",font:"18px Orbitron",zIndex:1000,transition:"all 1.5s"});
      d.textContent=texto; document.body.appendChild(d);
      setTimeout(()=>{ d.style.opacity="0"; d.style.transform="translateY(-40px)"; },100);
      setTimeout(()=>d.remove(),1600);
    }
    function actualizarContadorCDOGE(){
      document.getElementById("contadorCDOGE").textContent=`üí∞ CDOGE: ${totalCDOGERecolectado}`;
    }
    function updateDifficulty(sec){
      if(sec>=75) gravity=gravityLevels[3];
      else if(sec>=45) gravity=gravityLevels[2];
      else if(sec>=30) gravity=gravityLevels[1];
      else gravity=gravityLevels[0];
    }

    // ---------- IM√ÅN L√ìGICA ----------
    let imanActivo=false, auraAzul=false;
    function activarIman(){
      const exp=Date.now()+3600000;
      localStorage.setItem("imanExpiracion",exp);
      imanActivo=true; auraAzul=true;
      mostrarMensajeTemporal("üß≤ Im√°n activado 1h",canvas.width/2,100);
      verificarExpiracionIman();
      setInterval(actualizarContadorIman,1000);
    }
    function verificarExpiracionIman(){
      const id=setInterval(()=>{
        const exp=parseInt(localStorage.getItem("imanExpiracion"))||0;
        if(Date.now()>=exp){
          imanActivo=false; auraAzul=false; localStorage.removeItem("imanExpiracion"); clearInterval(id);
          mostrarMensajeTemporal("‚è±Ô∏è Im√°n expir√≥",canvas.width/2,100);
        }
      },1000);
    }
    function dibujarAura(d){
      if(auraAzul){
        ctx.beginPath();
        ctx.arc(d.x+d.width/2,d.y+d.height/2,d.width*0.8,0,Math.PI*2);
        ctx.strokeStyle='#00ffff88'; ctx.lineWidth=4; ctx.stroke();
      }
    }
    function actualizarContadorIman(){
      const div=document.getElementById("imanContador");
      const exp=parseInt(localStorage.getItem("imanExpiracion"))||0;
      const resto=exp-Date.now();
      if(resto>0){
        const m=Math.floor(resto/60000), s=Math.floor((resto%60000)/1000);
        div.textContent=`üß≤ Im√°n: ${m}:${s<10?'0':''}${s}`; div.style.display="block";
      } else div.style.display="none";
    }

    // ---------- MONEDAS & OBST√ÅCULOS ----------
    function spawnCoinGroup(){
      const n=Math.floor(Math.random()*6)+5;
      for(let i=0;i<n;i++){
        coinsArray.push({ x:canvas.width+i*40, y:Math.random()*(canvas.height-100), width:30, height:30, speed:2 });
      }
    }
    function drawCoins(){
      for(let i=coinsArray.length-1;i>=0;i--){
        const c=coinsArray[i];
        if(imanActivo){
          const dx=doge.x+doge.width/2-(c.x+c.width/2),
                dy=doge.y+doge.height/2-(c.y+c.height/2),
                dist=Math.hypot(dx,dy);
          if(dist<200){ const f=1-dist/200; c.x+=dx*0.05*f; c.y+=dy*0.05*f; }
        }
        c.x-=c.speed;
        ctx.drawImage(coinImg,c.x,c.y,c.width,c.height);
        if(doge.x<c.x+c.width && doge.x+doge.width>c.x && doge.y<c.y+c.height && doge.y+doge.height>c.y){
          coins++; localStorage.setItem("cdogeCoins",coins);
          document.getElementById("coinDisplay").textContent="üí∞ x "+coins;
          playSound(sndCoin); coinsArray.splice(i,1);
        }
      }
    }
    function spawnObstacle(){
      const img=new Image(); img.src=obstacleImgs[Math.floor(Math.random()*obstacleImgs.length)];
      specialObstacles.push({ x:canvas.width, y:Math.random()*canvas.height, width:50, height:50, speedX:2+Math.random()*2, speedY:0.5+Math.random()*1.5, img });
    }
    function drawObstacles(){
      specialObstacles.forEach(o=>{
        o.x-=o.speedX; o.y+= (o.y<doge.y? o.speedY:-o.speedY);
        ctx.drawImage(o.img,o.x,o.y,o.width,o.height);
        if(doge.x<o.x+o.width && doge.x+doge.width>o.x && doge.y<o.y+o.height && doge.y+doge.height>o.y){
          gameOver();
        }
      });
      specialObstacles = specialObstacles.filter(o=>o.x+o.width>0);
    }

    // ---------- CDOGE ESPECIAL ----------
    function generarMonedaCDOGE(){
      if(monedasCDOGE.length<1){
        const pos=ubicacionesDificiles[Math.floor(Math.random()*ubicacionesDificiles.length)];
        monedasCDOGE.push({ x:pos.x, y:pos.y, width:32, height:32, recolectada:false });
      }
    }
    setInterval(generarMonedaCDOGE,20000);
    function dibujarMonedasCDOGE(){
      monedasCDOGE.forEach(m=>{
        if(!m.recolectada) ctx.drawImage(imagenMoneda,m.x,m.y,m.width,m.height);
      });
    }
    function detectarColisionMonedas(d){
      monedasCDOGE.forEach(m=>{
        if(!m.recolectada){
          const dx=d.x+d.width/2-(m.x+m.width/2),
                dy=d.y+d.height/2-(m.y+m.height/2),
                dist=Math.hypot(dx,dy);
          if(imanActivo && dist<200){ const f=1-dist/200; m.x+=dx*0.05*f; m.y+=dy*0.05*f; }
          if(dist<20){
            m.recolectada=true;
            totalCDOGERecolectado+=valorPorMoneda;
            localStorage.setItem("cdogeTotalCoins", totalCDOGERecolectado);
            playSound(sonidoMoneda);
            mostrarMensajeTemporal(`+${valorPorMoneda} $CDOGE`, m.x, m.y);
            actualizarContadorCDOGE();
          }
        }
      });
    }

    // ---------- BCOSMO ESPECIAL ----------
    let turnoBCOSMO=false;
    setInterval(()=>{
      if(turnoBCOSMO){
        monedasBCOSMO = [];
        [
          {x:80,y:100},
          {x:canvas.width/2,y:canvas.height/2},
          {x:canvas.width-120,y:canvas.height-100}
        ].forEach(p=> monedasBCOSMO.push({ ...p, width:32, height:32, recolectada:false }));
      } else generarMonedaCDOGE();
      turnoBCOSMO = !turnoBCOSMO;
    },15000);
    function dibujarMonedasBCOSMO(){
      monedasBCOSMO.forEach(m=>{ if(!m.recolectada) ctx.drawImage(imagenBCOSMO,m.x,m.y,m.width,m.height); });
    }
    function detectarColisionBCOSMO(d){
      monedasBCOSMO.forEach(m=>{
        if(!m.recolectada){
          const dx=d.x+d.width/2-(m.x+m.width/2),
                dy=d.y+d.height/2-(m.y+m.height/2),
                dist=Math.hypot(dx,dy);
          if(imanActivo && dist<200){ const f=1-dist/200; m.x+=dx*0.05*f; m.y+=dy*0.05*f; }
          if(dist<20){
            m.recolectada=true;
            coins+=valorBCOSMO;
            localStorage.setItem("cdogeCoins",coins);
            document.getElementById("coinDisplay").textContent="üí∞ x "+coins;
            playSound(sonidoBCOSMO);
            mostrarMensajeTemporal(`+${valorBCOSMO} $BCOSMO`, m.x, m.y);
          }
        }
      });
    }

    // ---------- DIBUJO ----------
    function drawBackground(){ ctx.drawImage(fondo,0,0,canvas.width,canvas.height); }
    function drawDoge(){ ctx.drawImage(doge.img,doge.x,doge.y,doge.width,doge.height); dibujarAura(doge); }

    // ---------- BUCLE DE JUEGO ----------
    let lastTime=0;
    function updateGame(ts){
      if(isGameOver) return;
      if(!lastTime) lastTime=ts;
      const dt=ts-lastTime; lastTime=ts;
      ctx.clearRect(0,0,canvas.width,canvas.height);
      drawBackground();
      doge.velocity += gravity*(dt/16);
      doge.y += doge.velocity*(dt/16);
      if(doge.y+doge.height>=canvas.height||doge.y<=0) return gameOver();
      drawDoge(); drawCoins(); drawObstacles();
      dibujarMonedasCDOGE(); detectarColisionMonedas(doge);
      dibujarMonedasBCOSMO(); detectarColisionBCOSMO(doge);

      timeElapsed += dt;
      const sec=timeElapsed/1000;
      if(sec - lastScoreTime >= 5){
        score++; lastScoreTime=sec;
        document.getElementById("scoreDisplay").textContent="üöÄ x "+score;
      }
      if(sec - lastFondoChange >= 30){
        fondoIndex=(fondoIndex+1)%fondos.length;
        fondo.src=fondos[fondoIndex];
        lastFondoChange=sec;
      }
      if(Math.floor(timeElapsed/16)%150===0) spawnCoinGroup();
      const now=Date.now();
      const spawnInterval=(timeElapsed/16)>=3600?1000:(timeElapsed/16)>=1800?2000:3000;
      if(now - lastObstacleSpawn >= spawnInterval){
        spawnObstacle();
        lastObstacleSpawn=now;
      }
      updateDifficulty(sec);
      gameLoop=requestAnimationFrame(updateGame);
    }

    // ---------- GAME OVER ----------
    function gameOver(){
      isGameOver=true;
      document.getElementById("finalScore").textContent=score;
      music.pause(); music.currentTime=0;
      const goScreen=document.getElementById("gameOverScreen");
      goScreen.classList.add("show");
      setTimeout(()=>document.getElementById("reiniciarBtn").style.display="block",1500);

      if(score>highScore){
        localStorage.setItem("cdogeFloatHighScore",score);
        highScore=score;
        document.getElementById("highScoreDisplay").textContent="üîù M√°x: "+highScore;
        document.getElementById("newRecordMessage").style.display="flex";
        playSound(sndRecord);
        const user=localStorage.getItem("cosmodogeliveUserName");
        if(user){
          guardarJugadorAutomatic(user,score,coins);
          document.getElementById("playerNameForm").style.display="none";
          mostrarTopRanking();
          document.getElementById("rankingPanel").style.display="block";
          document.getElementById("nombreJugador").textContent=`üê∂ CosmoPlayer: ${user}`;
        } else {
          document.getElementById("playerNameForm").style.display="flex";
        }
      } else {
        playSound(sndBoom);
      }
    }

    // ---------- CONTROLES ----------
    document.addEventListener("keydown", e=>{
      if(e.code==="Space" && gameStarted && !isGameOver){
        doge.velocity=jump; playSound(sndJump);
      }
    });
    if(esMovil){
      document.addEventListener("touchstart", ()=>{ if(gameStarted && !isGameOver){ doge.velocity=jump; playSound(sndJump); } });
    }

    // ---------- INICIO & REANUDAR ----------
    function iniciarJuegoLimpio(){
      document.getElementById("menuPrincipal").style.display="none";
      document.getElementById("tiendaCDOGE").style.display="none";
      startGame();
    }
    function startGame(){
      document.getElementById("startScreen").style.display="none";
      document.getElementById("pantallaCarga").style.display="none";
      gameStarted=true; music.play();
      requestAnimationFrame(updateGame);
    }
    document.getElementById("startButton").onclick=iniciarJuegoLimpio;
    document.getElementById("reiniciarBtn").onclick=()=>location.reload();

    // ---------- GUARDAR PUNTUACI√ìN ----------
    document.getElementById("saveScoreButton").addEventListener("click", ()=>{
      const name=document.getElementById("playerName").value.trim();
      if(!name) return alert("Ingresa tu nombre gal√°ctico.");
      localStorage.setItem("cosmodogeliveUserName",name);
      guardarJugadorAutomatic(name,score,coins).then(()=>{
        document.getElementById("playerNameForm").style.display="none";
        mostrarTopRanking();
        document.getElementById("rankingPanel").style.display="block";
        document.getElementById("nombreJugador").textContent=`üê∂ CosmoPlayer: ${name}`;
      });
    });

    // ---------- PAUSA VISIBILITY & REANUDAR ----------
    document.addEventListener("visibilitychange", ()=>{
      if(document.hidden && gameLoop){
        cancelAnimationFrame(gameLoop);
        document.getElementById("reanudarBtn").style.display="block";
      }
    });
    document.getElementById("reanudarBtn").addEventListener("click", ()=>{
      document.getElementById("reanudarBtn").style.display="none";
      if(!isGameOver) requestAnimationFrame(updateGame);
    });

    // ---------- MetaMask (CDOGE) ----------
    const botonWallet=document.getElementById("conectarWalletBtn");
    botonWallet.addEventListener("click", mostrarSelectorWallet);

    async function comprarImanConCDOGE(){
      try {
        // Conectar Ethereum
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        const account = accounts[0];
        const provider = new ethers.providers.Web3Provider(window.ethereum);
        const signer = provider.getSigner();
        const contract = new ethers.Contract(CDOGE_CONTRACT, ERC20_ABI, signer);
        const decimals = await contract.decimals();
        const amount = ethers.utils.parseUnits("1500", decimals);
        // Transferir
        const tx = await contract.transfer(CDOGE_RECIPIENT, amount);
        await tx.wait();
        activarIman();
        mostrarMensajeTemporal("üß≤ Im√°n comprado con $CDOGE", canvas.width/2, 100);
      } catch(err){
        console.error("Error CDOGE transfer:", err);
        alert("‚ùå Error al comprar im√°n con CDOGE.");
      }
    }
    document.getElementById("comprarIman").addEventListener("click", comprarImanConCDOGE);

    // ---------- Phantom (BCOSMO) ----------
    async function comprarImanConBCOSMO(){
      try {
        const provider = window.solana;
        if(!provider || !provider.isPhantom) throw new Error("Phantom no detectado");
        const resp = await provider.connect();
        const walletPub = resp.publicKey;
        const connection = new solanaWeb3.Connection("https://api.mainnet-beta.solana.com", "confirmed");
        const mintPub = new solanaWeb3.PublicKey(BCOSMO_MINT);
        const recipientPub = new solanaWeb3.PublicKey(BCOSMO_WALLET_RECEIVE);

        // Obtener decimals del mint
        const mintInfo = await connection.getParsedAccountInfo(mintPub);
        const decimals = mintInfo.value.data.parsed.info.decimals;

        // Cuentas asociadas
        const senderTokenAcc = await splToken.getOrCreateAssociatedTokenAccount(connection, walletPub, mintPub, walletPub);
        const recipientTokenAcc = await splToken.getOrCreateAssociatedTokenAccount(connection, walletPub, mintPub, recipientPub);

        // Crear instrucci√≥n de transferencia
        const amount = 2500 * (10 ** decimals);
        const ix = splToken.createTransferCheckedInstruction(
          senderTokenAcc.address,
          mintPub,
          recipientTokenAcc.address,
          walletPub,
          amount,
          decimals
        );
        const tx = new solanaWeb3.Transaction().add(ix);
        tx.feePayer = walletPub;
        tx.recentBlockhash = (await connection.getRecentBlockhash()).blockhash;

        // Firmar y enviar
        const signed = await provider.signTransaction(tx);
        const sig = await connection.sendRawTransaction(signed.serialize());
        await connection.confirmTransaction(sig);

        activarIman();
        mostrarMensajeTemporal("üß≤ Im√°n comprado con $BCOSMO", canvas.width/2, 120);
      } catch(err){
        console.error("Error BCOSMO transfer:", err);
        alert("‚ùå Error al comprar im√°n con BCOSMO.");
      }
    }
    document.getElementById("comprarImanBCOSMO").addEventListener("click", comprarImanConBCOSMO);

    // ---------- Selector Wallet ----------
    function mostrarSelectorWallet(){
      const opt = prompt("Selecciona tu wallet:\n1 - MetaMask (CDOGE)\n2 - Phantom (BCOSMO)");
      if(opt==="1") comprarImanConCDOGE();
      else if(opt==="2") comprarImanConBCOSMO();
      else alert("Opci√≥n inv√°lida.");
    }

    // ---------- Inicio inicial ----------
    window.addEventListener("DOMContentLoaded", ()=>{
      setTimeout(()=> document.getElementById("pantallaCarga").style.display="none",3000);
      document.getElementById("startScreen").style.display="flex";
      document.getElementById("coinDisplay").textContent="üí∞ x "+coins;
      document.getElementById("highScoreDisplay").textContent="üîù M√°x: "+highScore;
      const user = localStorage.getItem("cosmodogeliveUserName");
      if(user){
        document.getElementById("nombreJugador").textContent=`üê∂ CosmoPlayer: ${user}`;
        mostrarTopRanking();
        document.getElementById("rankingPanel").style.display="block";
      }
    });
  </script>
</body>
</html>
