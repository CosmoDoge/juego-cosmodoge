<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CosmoDoge Flotante üöÄ</title>

  <!-- Librer√≠as on-chain -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.41.0/lib/index.iife.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@solana/spl-token@0.3.5/lib/index.iife.min.js"></script>

  <style>
    /* Reset y fondo */
    * { margin:0; padding:0; box-sizing:border-box }
    html,body { width:100%; height:100%; overflow:hidden; background:black; font-family:Arial,sans-serif }

    /* Canvas */
    canvas { display:block; margin:auto; max-width:100vw; max-height:100vh }

    /* HUD com√∫n */
    .hud { position:absolute; color:white; text-shadow:2px 2px 5px #000; z-index:1000 }
    #scoreDisplay    { top:10px;   left:10px; font-size:18px }
    #coinDisplay     { top:40px;   left:10px; font-size:18px }
    #highScoreDisplay{ top:70px;   left:10px; font-size:18px }
    #contadorCDOGE   { top:100px;  left:10px; font:18px Orbitron,sans-serif; color:#0ff }
    #shieldDisplay   { top:130px;  left:10px; font:18px Orbitron,sans-serif; color:#faa }
    #nombreJugador   { top:10px;   left:50%; transform:translateX(-50%); font:18px Orbitron,sans-serif; color:#0ff }

    /* Balance wallets */
    #balanceCDOGE, #balanceBCOSMO {
      position:absolute; right:20px; background:rgba(0,0,0,0.7); padding:10px; border-radius:8px;
      font:16px Orbitron,sans-serif; color:#0ff; display:none; z-index:1000
    }
    #balanceBCOSMO { top:110px }
    #imanContador  { position:absolute; top:150px; right:20px;
                     background:rgba(0,0,0,0.75); padding:8px; border-radius:10px;
                     font:16px Orbitron,sans-serif; color:#0ff; display:none; z-index:1000 }

    /* Botones y men√∫s */
    .fixed { position:fixed; z-index:10000 }
    #conectarWalletBtn {
      top:20px; right:20px; background:#0ff; color:#000; border:none; border-radius:12px;
      padding:10px 20px; font:16px Orbitron,sans-serif; cursor:pointer
    }
    #menuPrincipal {
      top:70px; right:20px; display:flex; flex-direction:column; gap:10px
    }
    #tiendaCDOGE {
      position:fixed; bottom:20px; left:20px; width:320px;
      background:rgba(0,0,0,0.85); border:2px solid #0ff; border-radius:15px;
      padding:15px; display:none; box-shadow:0 0 15px #0ff; font:14px Orbitron,sans-serif; color:#fff
    }
    .btn {
      padding:1rem 2rem; background:#0ff; border:none; border-radius:10px;
      color:#000; font-size:1.2rem; font-weight:bold; cursor:pointer; transition:background .3s
    }
    .btn:hover { background:#0dde }

    /* Pantallas superpuestas */
    #pantallaCarga, #startScreen, #newRecordMessage, #gameOverScreen {
      position:fixed; top:0; left:0; width:100vw; height:100vh;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      background:rgba(0,0,0,0.85); color:white; font:Orbitron,sans-serif; z-index:9999; text-align:center
    }
    #pantallaCarga .spinner {
      width:60px; height:60px; border:6px solid #ffffff22; border-top:6px solid #0ff; border-radius:50%;
      animation:spin 1s linear infinite
    }
    @keyframes spin{ to{ transform:rotate(360deg) } }
    #gameOverScreen { display:none; opacity:0; transition:opacity 1s }
    #gameOverScreen.show { display:flex; opacity:1 }
    #reiniciarBtn { margin-top:20px; padding:12px 24px; background:#0ff; color:#000; border:none; border-radius:12px; font-size:18px; cursor:pointer; display:none }
    #playerNameForm {
      display:none; flex-direction:column; align-items:center;
      background:rgba(0,0,0,0.85); padding:20px; border-radius:10px; z-index:10000
    }
    #rankingPanel {
      position:fixed; top:200px; left:50%; transform:translateX(-50%);
      background:rgba(0,0,0,0.85); padding:20px; border-radius:10px;
      display:none; font:14px Orbitron,sans-serif; color:#fff; z-index:10000
    }
    #reanudarBtn {
      position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
      padding:15px 30px; background:#0ff; color:#000; border:none; border-radius:12px;
      font:20px Orbitron,sans-serif; cursor:pointer; display:none; z-index:10000
    }
  </style>
</head>
<body>
  <!-- Preloader -->
  <div id="pantallaCarga">
    <div class="spinner"></div>
    <p style="font-size:20px; margin-top:20px;">Cargando CosmoDoge...</p>
  </div>

  <!-- HUD -->
  <button id="conectarWalletBtn" class="fixed">üîó Conectar Wallet</button>
  <div id="balanceCDOGE"></div>
  <div id="balanceBCOSMO"></div>
  <div id="scoreDisplay" class="hud">üöÄ x 0</div>
  <div id="coinDisplay"  class="hud">üí∞ x 0</div>
  <div id="highScoreDisplay" class="hud">üîù M√°x: 0</div>
  <div id="contadorCDOGE" class="hud">üí∞ CDOGE: 0</div>
  <div id="shieldDisplay" class="hud">üõ°Ô∏è Escudo: 0</div>
  <div id="nombreJugador" class="hud"></div>
  <div id="imanContador"></div>

  <!-- Men√∫ Principal -->
  <div id="menuPrincipal" class="fixed">
    <button onclick="toggleTienda()">üõí Tienda</button>
    <button onclick="toggleRanking()">üèÜ Ranking</button>
  </div>

  <!-- Tienda -->
  <div id="tiendaCDOGE">
    <h3 style="color:#0ff;">üõí Tienda CosmoDoge</h3>
    <div style="margin-bottom:15px; padding:10px; background:#111; border:1px solid #0ff; border-radius:10px;">
      <p style="color:#0ff;">üß≤ Im√°n Espacial</p>
      <p style="color:#bbb;">Atrae monedas durante 1 hora</p>
      <button id="comprarIman" style="width:100%;">Comprar por 1,500 $CDOGE</button>
    </div>
    <div style="padding:10px; background:#111; border:1px solid #faa; border-radius:10px;">
      <p style="color:#faa;">üõ°Ô∏è Escudo Protector</p>
      <p style="color:#bbb;">Protege 3 colisiones</p>
      <button id="comprarEscudo" style="width:100%;">Comprar por 1,000 ü™ô</button>
    </div>
  </div>

  <!-- Canvas de juego -->
  <canvas id="gameCanvas" width="480" height="640"></canvas>

  <!-- Pantallas de control -->
  <div id="startScreen" style="display:none;">
    <h1>üöÄ CosmoDoge Flotante</h1>
    <button class="btn" id="startButton">¬°Comenzar!</button>
  </div>
  <div id="gameOverScreen">
    <h1>üö® GAME OVER üö®</h1>
    <p>Puntaje: <span id="finalScore">0</span></p>
    <button id="reiniciarBtn" class="btn">Reiniciar</button>
  </div>
  <div id="newRecordMessage" style="display:none;">
    <h1>üåü ¬°Nuevo r√©cord gal√°ctico!</h1>
    <p>Ingresa tu nombre para guardarlo.</p>
  </div>

  <!-- Formulario de registro -->
  <div id="playerNameForm">
    <input type="text" id="playerName" placeholder="Tu nombre gal√°ctico" style="padding:10px; border:none; border-radius:8px; margin-bottom:10px;">
    <button class="btn" id="saveScoreButton">Guardar Puntaje</button>
  </div>

  <!-- Panel de ranking -->
  <div id="rankingPanel">
    <div id="topRanking"></div>
    <button class="btn" onclick="toggleRanking()">Cerrar</button>
  </div>

  <!-- Bot√≥n reanudar -->
  <button id="reanudarBtn" class="btn">Reanudar Juego</button>

  <!-- Firebase + l√≥gica on-chain -->
  <script type="module">
    // Captura global de errores
    window.addEventListener('error', e => console.error('‚ùå Error:', e.message));
    window.addEventListener('unhandledrejection', e => console.error('‚ùå Rechazo:', e.reason));

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getFirestore, collection, query, orderBy, limit, getDocs, addDoc, serverTimestamp }
      from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDaM9HtMtTlJXc-V4HfsZ7bbC__ZPe9zIk",
      authDomain: "cosmodogelive.firebaseapp.com",
      projectId: "cosmodogelive",
      storageBucket: "cosmodogelive.appspot.com",
      messagingSenderId: "648227069914",
      appId: "1:648227069914:web:3ef7ac8da4ab52c30deae3"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    window.guardarJugadorAutomatic = async (user, pts, mns) => {
      try {
        await addDoc(collection(db, "jugadores"), {
          nombre: String(user),
          puntaje: Number(pts),
          monedas: Number(mns),
          fecha: serverTimestamp()
        });
      } catch (e) {
        console.error("Firestore error:", e);
      }
    };

    window.mostrarTopRanking = async () => {
      const lista = document.getElementById("topRanking");
      try {
        const q = query(collection(db, "jugadores"), orderBy("puntaje", "desc"), limit(5));
        const snap = await getDocs(q);
        let html = "<h2>üèÜ Top 5 CosmoDoge</h2><ul style='list-style:none;padding:0;'>";
        snap.forEach((doc, i) => {
          const d = doc.data();
          html += `<li>#${i+1} <strong>${d.nombre}</strong> - ${d.puntaje} pts - ${d.monedas} ü™ô</li>`;
        });
        lista.innerHTML = html + "</ul>";
      } catch (e) {
        lista.innerHTML = "<p style='color:red;'>Error al cargar ranking.</p>";
      }
    };
  </script>

  <script>
    // Variables y assets
    const canvas = document.getElementById("gameCanvas"),
          ctx    = canvas.getContext("2d"),
          esMovil= /Mobi|Android/i.test(navigator.userAgent);

    let score      = 0,
        coins      = parseInt(localStorage.getItem("cdogeCoins")) || 0,
        highScore  = parseInt(localStorage.getItem("cdogeFloatHighScore")) || 0,
        totalCDOGE = parseInt(localStorage.getItem("cdogeTotalCoins")) || 0,
        shieldCount= parseInt(localStorage.getItem("shieldCount")) || 0,
        gameStarted=false, isGameOver=false,
        timeElapsed=0, lastScoreTime=0, lastFondoChange=0, lastObs=Date.now(),
        gravityLevels=[0.5,0.6,0.8,1.0], gravity=0.5, jump=-10;

    let coinsArr=[], obsArr=[], cdogeArr=[], bcosmoArr=[];

    const valorPorMoneda=50, valorBCOSMO=50,
          ubicaciones=[{x:80,y:100},{x:canvas.width-120,y:80},{x:canvas.width/2,y:canvas.height/3},{x:canvas.width-80,y:canvas.height-120},{x:100,y:canvas.height-150}];

    const fondos=["fondo1.png","fondo2.png","fondo3.png"], fi=0;
    const fondo=new Image(); fondo.src=fondos[0];

    const doge={x:80,y:200,w:50,h:50,v:0,img:new Image()}; doge.img.src="cosmo.png";
    const coinImg=new Image(); coinImg.src="coin.png";
    const obsImgs=["obs1.png","obs2.png","obs3.png"];
    const cdogeImg=new Image(); cdogeImg.src="monedaC.png";
    const bcosmoImg=new Image(); bcosmoImg.src="monedaB.png";

    const sndJump=new Audio("jump.mp3"),
          sndCoin=new Audio("coin.mp3"),
          sndBoom=new Audio("boom.mp3"),
          sndRecord=new Audio("record.mp3"),
          sndMonedaC=new Audio("monedaC.mp3"),
          sndMonedaB=new Audio("monedaB.mp3"),
          music=new Audio("theme.mp3");
    music.loop=true; music.volume=0.3;

    // On-chain
    const CDOGE_CON="0x5dE25281305992d3552a45A3D8ccA7BdfB4AcD3A",
          ERC20_ABI=[
            "function balanceOf(address) view returns(uint256)",
            "function decimals() view returns(uint8)",
            "function transfer(address,uint256) returns(bool)"
          ],
          CDOGE_REC="0x1980dCdDA07071970dEAa69c975F590976Ee667D3A".toLowerCase();

    const MINT="2etLM91LBaxbQ1y3jnzQw8EXKNHAKcXJsHMJJ69opump",
          RCV="A6dnVgGaS1scC2m6hmPdK15D5gs5vDsHS8PEq3xtJKNx";

    // Utils
    function play(s){ s.currentTime=0; s.play().catch(()=>{}); }
    function showMsg(txt,x,y){
      const d=document.createElement("div");
      Object.assign(d.style,{position:"absolute",left:`${x}px`,top:`${y}px`,color:"#0ff",font:"18px Orbitron",zIndex:10000,transition:"all 1.5s"})
      d.textContent=txt;document.body.appendChild(d);
      setTimeout(()=>{d.style.opacity=0;d.style.transform="translateY(-40px)";},100);
      setTimeout(()=>d.remove(),1600);
    }
    function updCDOGE(){document.getElementById("contadorCDOGE").textContent=`üí∞ CDOGE: ${totalCDOGE}`;}
    function updShield(){document.getElementById("shieldDisplay").textContent=`üõ°Ô∏è Escudo: ${shieldCount}`;}
    function updDiff(sec){
      gravity= sec>=75?gravityLevels[3]: sec>=45?gravityLevels[2]: sec>=30?gravityLevels[1]: gravityLevels[0];
    }

    // Im√°n
    let imanA=false, aura=false;
    function actIman(){
      const exp=Date.now()+3600000;
      localStorage.setItem("imanExpiracion",exp);
      imanA=true; aura=true; showMsg("üß≤ Im√°n activo 1h",canvas.width/2,100);
      chkIman(); setInterval(updIman,1000);
    }
    function chkIman(){
      const id=setInterval(()=>{
        const exp=parseInt(localStorage.getItem("imanExpiracion"))||0;
        if(Date.now()>=exp){
          imanA=false; aura=false; localStorage.removeItem("imanExpiracion"); clearInterval(id);
          showMsg("‚è±Ô∏è Im√°n expirado",canvas.width/2,100);
        }
      },1000);
    }
    function updIman(){
      const d=document.getElementById("imanContador");
      const exp=parseInt(localStorage.getItem("imanExpiracion"))||0;
      const r=exp-Date.now();
      if(r>0){ const m=Math.floor(r/60000), s=Math.floor((r%60000)/1000);
        d.textContent=`üß≤ Im√°n: ${m}:${s<10?'0':''}${s}`; d.style.display="block";
      } else d.style.display="none";
    }
    function drawAura(dog){
      if(aura){
        ctx.beginPath();
        ctx.arc(dog.x+dog.w/2, dog.y+dog.h/2, dog.w*0.8, 0, Math.PI*2);
        ctx.strokeStyle="#00ffff88"; ctx.lineWidth=4; ctx.stroke();
      }
    }

    // Escudo
    function buyShield(){
      if(coins<1000) return alert("No tienes suficientes ü™ô");
      coins -= 1000; localStorage.setItem("cdogeCoins", coins);
      document.getElementById("coinDisplay").textContent=`üí∞ x ${coins}`;
      shieldCount = 3; localStorage.setItem("shieldCount", shieldCount);
      updShield(); showMsg("üõ°Ô∏è Escudo adquirido (3)", canvas.width/2,140);
    }

    // Conexi√≥n Wallets
    async function conectarMetaMask(){
      const isM=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
      if(!window.ethereum){
        if(isM) window.location.href=`https://metamask.app.link/dapp/${encodeURIComponent(location.href)}`;
        else return alert("Instala MetaMask");
      }
      try{
        const acc=await ethereum.request({method:'eth_requestAccounts'});
        const acct=acc[0];
        document.getElementById("conectarWalletBtn").textContent=`üîó ${acct.slice(0,6)}‚Ä¶${acct.slice(-4)}`;
        const prov=new ethers.providers.Web3Provider(window.ethereum);
        const c=new ethers.Contract(CDOGE_CON,ERC20_ABI,prov);
        const b=await c.balanceOf(acct), d=await c.decimals();
        const fmt=Number(b/10**d).toLocaleString();
        document.getElementById("balanceCDOGE").innerHTML=`üöÄ ${fmt} CDOGE`;
        document.getElementById("balanceCDOGE").style.display="block";
      }catch(e){ console.error(e); alert("Error MetaMask"); }
    }
    async function conectarPhantom(){
      try{
        const p=window.solana;
        if(!p||!p.isPhantom) throw new Error("Instala Phantom Wallet");
        const resp=await p.connect();
        const pub=resp.publicKey;
        showMsg(`üåê Phantom: ${pub.toString().slice(0,6)}‚Ä¶${pub.toString().slice(-4)}`,canvas.width/2,80);
        const conn=new solanaWeb3.Connection("https://api.mainnet-beta.solana.com","confirmed");
        const tokens=await conn.getParsedTokenAccountsByOwner(pub,{programId:solanaWeb3.TOKEN_PROGRAM_ID});
        let bal=0;
        tokens.value.forEach(({account})=>{
          const info=account.data.parsed.info;
          if(info.mint===MINT) bal=info.tokenAmount.uiAmount;
        });
        document.getElementById("balanceBCOSMO").innerHTML=`üêï ${bal||0} BCOSMO`;
        document.getElementById("balanceBCOSMO").style.display="block";
      }catch(e){ console.error(e); alert(e.message); }
    }
    function mostrarSelectorWallet(){
      const opt=prompt("Selecciona tu wallet:\n1-MetaMask\n2-Phantom");
      if(opt==="1") conectarMetaMask();
      else if(opt==="2") conectarPhantom();
      else alert("Opci√≥n inv√°lida");
    }

    // Compras on-chain Im√°n
    async function comprarImanCDOGE(){
      try{
        if(!window.ethereum) return alert("Instala MetaMask");
        const acc=await ethereum.request({method:'eth_requestAccounts'});
        const prov=new ethers.providers.Web3Provider(window.ethereum);
        const s=prov.getSigner();
        const c=new ethers.Contract(CDOGE_CON,ERC20_ABI,s);
        const d=await c.decimals();
        const amt=ethers.utils.parseUnits("1500",d);
        const tx=await c.transfer(CDOGE_REC,amt);
        await tx.wait();
        actIman(); chkIman(); showMsg("üß≤ Im√°n comprado con CDOGE",canvas.width/2,100);
      }catch(e){ console.error(e); alert("Error comprando Im√°n"); }
    }
    async function comprarImanBCOSMO(){
      try{
        const p=window.solana;
        if(!p||!p.isPhantom) throw new Error("Instala Phantom");
        const resp=await p.connect(), pub=resp.publicKey;
        const conn=new solanaWeb3.Connection("https://api.mainnet-beta.solana.com","confirmed");
        const mintPub=new solanaWeb3.PublicKey(MINT), recPub=new solanaWeb3.PublicKey(RCV);
        const mi=await conn.getParsedAccountInfo(mintPub);
        const dec=mi.value.data.parsed.info.decimals;
        const sAcc=await splToken.getOrCreateAssociatedTokenAccount(conn,pub,mintPub,pub);
        const rAcc=await splToken.getOrCreateAssociatedTokenAccount(conn,pub,mintPub,recPub);
        const amount=2500*(10**dec);
        const ix=splToken.createTransferCheckedInstruction(sAcc.address,mintPub,rAcc.address,pub,amount,dec);
        const tx=new solanaWeb3.Transaction().add(ix);
        tx.feePayer=pub; tx.recentBlockhash=(await conn.getRecentBlockhash()).blockhash;
        const signed=await p.signTransaction(tx);
        const sig=await conn.sendRawTransaction(signed.serialize());
        await conn.confirmTransaction(sig);
        actIman(); chkIman(); showMsg("üß≤ Im√°n comprado con BCOSMO",canvas.width/2,120);
      }catch(e){ console.error(e); alert("Error comprando Im√°n"); }
    }

    // Collision handling with shield
    function handleCollision(){
      if(shieldCount>0){
        shieldCount--; localStorage.setItem("shieldCount",shieldCount); updShield();
        showMsg(`üõ°Ô∏è Escudo usado, quedan ${shieldCount}`,canvas.width/2,160);
        return true;
      }
      return false;
    }

    // Spawns y dibujo b√°sicos
    function spawnCoinGroup(){
      const n=Math.floor(Math.random()*6)+5;
      for(let i=0;i<n;i++){
        coinsArr.push({ x:canvas.width+i*40, y:Math.random()*(canvas.height-100), w:30, h:30, s:2 });
      }
    }
    function drawCoins(){
      for(let i=coinsArr.length-1;i>=0;i--){
        const c=coinsArr[i];
        if(imanA){
          const dx=doge.x+doge.w/2-(c.x+c.w/2), dy=doge.y+doge.h/2-(c.y+c.h/2);
          const dist=Math.hypot(dx,dy);
          if(dist<200){ const f=1-dist/200; c.x+=dx*0.05*f; c.y+=dy*0.05*f; }
        }
        c.x-=c.s; ctx.drawImage(coinImg,c.x,c.y,c.w,c.h);
        if(doge.x<c.x+c.w&&doge.x+doge.w>c.x&&doge.y<c.y+c.h&&doge.y+doge.h>c.y){
          coins++; localStorage.setItem("cdogeCoins",coins);
          document.getElementById("coinDisplay").textContent=`üí∞ x ${coins}`;
          play(sndCoin); coinsArr.splice(i,1);
        }
      }
    }

    function spawnObstacle(){
      const img=new Image(), rnd=Math.floor(Math.random()*obsImgs.length);
      img.src=obsImgs[rnd];
      obsArr.push({ x:canvas.width, y:Math.random()*canvas.height, w:50, h:50, sX:2+Math.random()*2, sY:0.5+Math.random()*1.5, img });
    }
    function drawObstacles(){
      obsArr.forEach((o,idx)=>{
        o.x-=o.sX; o.y+=(o.y<doge.y?o.sY:-o.sY);
        ctx.drawImage(o.img,o.x,o.y,o.w,o.h);
        if(doge.x<o.x+o.w&&doge.x+doge.w>o.x&&doge.y<o.y+o.h&&doge.y+doge.h>o.y){
          if(!handleCollision()) gameOver();
        }
      });
      obsArr=obsArr.filter(o=>o.x+o.w>0);
    }

    // CDOGE especiales
    function genCDOGE(){
      if(cdogeArr.length<1){
        const p=ubicaciones[Math.floor(Math.random()*ubicaciones.length)];
        cdogeArr.push({ x:p.x, y:p.y, w:32, h:32, got:false });
      }
    }
    setInterval(genCDOGE,20000);
    function drawCDOGE(){
      cdogeArr.forEach(m=>{
        if(!m.got) ctx.drawImage(cdogeImg,m.x,m.y,m.w,m.h);
      });
    }
    function colCDOGE(){
      cdogeArr.forEach(m=>{
        if(!m.got){
          const dx=doge.x+doge.w/2-(m.x+m.w/2), dy=doge.y+doge.h/2-(m.y+m.h/2);
          const dist=Math.hypot(dx,dy);
          if(imanA&&dist<200){ const f=1-dist/200; m.x+=dx*0.05*f; m.y+=dy*0.05*f; }
          if(dist<20){
            m.got=true; totalCDOGE+=valorPorMoneda;
            localStorage.setItem("cdogeTotalCoins",totalCDOGE); play(sndMonedaC);
            showMsg(`+${valorPorMoneda} CDOGE`,m.x,m.y); updCDOGE();
          }
        }
      });
    }

    // BCOSMO especiales
    let turnoB=false;
    setInterval(()=>{
      if(turnoB){
        bcosmoArr=[];
        [{x:80,y:100},{x:canvas.width/2,y:canvas.height/2},{x:canvas.width-120,y:canvas.height-100}]
          .forEach(p=>bcosmoArr.push({x:p.x,y:p.y,w:32,h:32,got:false}));
      } else genCDOGE();
      turnoB=!turnoB;
    },15000);
    function drawBCOSMO(){
      bcosmoArr.forEach(m=>{ if(!m.got) ctx.drawImage(bcosmoImg,m.x,m.y,m.w,m.h); });
    }
    function colBCOSMO(){
      bcosmoArr.forEach(m=>{
        if(!m.got){
          const dx=doge.x+doge.w/2-(m.x+m.w/2), dy=doge.y+doge.h/2-(m.y+m.h/2);
          const dist=Math.hypot(dx,dy);
          if(imanA&&dist<200){ const f=1-dist/200; m.x+=dx*0.05*f; m.y+=dy*0.05*f; }
          if(dist<20){
            m.got=true; coins+=valorBCOSMO; localStorage.setItem("cdogeCoins",coins);
            document.getElementById("coinDisplay").textContent=`üí∞ x ${coins}`; play(sndMonedaB);
            showMsg(`+${valorBCOSMO} BCOSMO`,m.x,m.y);
          }
        }
      });
    }

    function drawBackground(){ ctx.drawImage(fondo,0,0,canvas.width,canvas.height); }
    function drawDoge(){ ctx.drawImage(doge.img,doge.x,doge.y,doge.w,doge.h); drawAura(doge); }

    let lastTime=0;
    function loop(ts){
      if(isGameOver) return;
      if(!lastTime) lastTime=ts;
      const dt=ts-lastTime; lastTime=ts;

      ctx.clearRect(0,0,canvas.width,canvas.height);
      drawBackground();
      doge.v+=gravity*(dt/16); doge.y+=doge.v*(dt/16);
      if(doge.y+doge.h>=canvas.height||doge.y<=0){
        if(!handleCollision()) return gameOver(); else doge.y=canvas.height/2;
      }

      drawDoge(); drawCoins(); drawObstacles();
      drawCDOGE(); colCDOGE();
      drawBCOSMO(); colBCOSMO();

      timeElapsed+=dt; const sec=timeElapsed/1000;
      if(sec-lastScoreTime>=5){ score++; lastScoreTime=sec; document.getElementById("scoreDisplay").textContent=`üöÄ x ${score}`; }
      if(sec-lastFondoChange>=30){ const idx=(fi+1)%fondos.length; fondo.src=fondos[idx]; lastFondoChange=sec; }
      if(Math.floor(timeElapsed/16)%150===0) spawnCoinGroup();
      const now=Date.now(), interval=(timeElapsed/16)>=3600?1000:(timeElapsed/16)>=1800?2000:3000;
      if(now-lastObs>=interval){ spawnObstacle(); lastObs=now; }
      updDiff(sec);

      requestAnimationFrame(loop);
    }

    function gameOver(){
      isGameOver=true;
      music.pause(); music.currentTime=0;
      document.getElementById("finalScore").textContent=score;
      const go=document.getElementById("gameOverScreen");
      go.style.display="flex"; setTimeout(()=>go.classList.add("show"),10);
      setTimeout(()=>document.getElementById("reiniciarBtn").style.display="block",1500);

      if(score>highScore){
        localStorage.setItem("cdogeFloatHighScore",score);
        highScore=score; document.getElementById("highScoreDisplay").textContent=`üîù M√°x: ${highScore}`;
        document.getElementById("newRecordMessage").style.display="flex";
        play(sndRecord);
        const usr=localStorage.getItem("cosmodogeliveUserName");
        if(!usr) document.getElementById("playerNameForm").style.display="flex";
        else guardarJugadorAutomatic(usr,score,coins).then(mostrarTopRanking);
      } else {
        play(sndBoom);
      }
    }

    // Controles e inicializaci√≥n
    document.getElementById("startButton").onclick=()=>{
      document.getElementById("pantallaCarga").style.display="none";
      document.getElementById("startScreen").style.display="none";
      document.getElementById("menuPrincipal").style.display="none";
      gameStarted=true; music.play(); requestAnimationFrame(loop);
    };
    document.getElementById("reiniciarBtn").onclick=()=>location.reload();
    document.getElementById("saveScoreButton").onclick=()=>{
      const n=document.getElementById("playerName").value.trim();
      if(!n) return alert("Ingresa tu nombre");
      localStorage.setItem("cosmodogeliveUserName",n);
      document.getElementById("playerNameForm").style.display="none";
      guardarJugadorAutomatic(n,score,coins).then(mostrarTopRanking);
    };
    document.getElementById("comprarEscudo").onclick=buyShield;
    document.getElementById("comprarIman").onclick=comprarImanCDOGE;
    document.getElementById("comprarImanBCOSMO").onclick=comprarImanBCOSMO;
    document.getElementById("conectarWalletBtn").onclick=mostrarSelectorWallet;

    document.addEventListener("keydown",e=>{
      if(e.code==="Space"&&gameStarted&&!isGameOver){ doge.v=jump; play(sndJump); }
    });
    document.addEventListener("visibilitychange",()=>{
      if(document.hidden&&gameStarted&&!isGameOver){
        cancelAnimationFrame(loop);
        document.getElementById("reanudarBtn").style.display="block";
      }
    });
    document.getElementById("reanudarBtn").onclick=()=>{
      document.getElementById("reanudarBtn").style.display="none";
      if(!isGameOver) requestAnimationFrame(loop);
    };

    window.addEventListener("DOMContentLoaded",()=>{
      setTimeout(()=>document.getElementById("pantallaCarga").style.display="none",3000);
      document.getElementById("startScreen").style.display="flex";
      document.getElementById("coinDisplay").textContent=`üí∞ x ${coins}`;
      document.getElementById("highScoreDisplay").textContent=`üîù M√°x: ${highScore}`;
      updCDOGE(); updShield();
      const usr=localStorage.getItem("cosmodogeliveUserName");
      if(usr){ document.getElementById("nombreJugador").textContent=`üê∂ ${usr}`; mostrarTopRanking(); }
      chkIman();
    });

    function toggleTienda(){ const t=document.getElementById("tiendaCDOGE"); t.style.display=(t.style.display==="block"?"none":"block"); }
    function toggleRanking(){
      const r=document.getElementById("rankingPanel");
      if(r.style.display==="block") r.style.display="none";
      else { mostrarTopRanking(); r.style.display="block"; }
    }
  </script>
</body>
</html>
