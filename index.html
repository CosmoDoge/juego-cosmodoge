<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CosmoDoge Flotante üöÄ</title>

  <!-- Google Fonts: Orbitron -->
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet" />

  <!-- Bibliotecas on-chain -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.41.0/lib/index.iife.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@solana/spl-token@0.3.5/lib/index.iife.min.js"></script>

  <style>
    /* RESET & BASE */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { width: 100%; height: 100%; overflow: hidden; background: black; font-family: 'Orbitron', Arial, sans-serif; }
    canvas { display: block; margin: auto; max-width: 100vw; max-height: 100vh; }
    /* Pantallas superpuestas */
    #pantallaCarga, #startScreen, #gameOverScreen, #newRecordMessage, #playerNameForm {
      position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      background: rgba(0,0,0,0.85); color: white; z-index: 9999; text-align: center;
    }
    #pantallaCarga .spinner {
      width: 60px; height: 60px; border: 6px solid #ffffff22; border-top: 6px solid #0ff;
      border-radius: 50%; animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    #gameOverScreen, #newRecordMessage, #playerNameForm { display: none; }
    #gameOverScreen.show { display: flex; opacity: 1; transition: opacity 1s; }
    #reiniciarBtn { margin-top: 20px; display: none; }

    /* HUD */
    .hud { position: absolute; color: white; text-shadow: 2px 2px 5px #000; z-index: 1000; font: 18px 'Orbitron', sans-serif; }
    #scoreDisplay, #coinDisplay, #highScoreDisplay, #contadorCDOGE, #contadorBCOSMO, #shieldDisplay, #imanContador, #nombreJugador {
      left: 10px; position: absolute;
    }
    #scoreDisplay { top: 10px; }
    #coinDisplay { top: 40px; }
    #highScoreDisplay { top: 70px; }
    #contadorCDOGE { top: 100px; color: #0ff; }
    #contadorBCOSMO { top: 130px; color: #faa200; }
    #shieldDisplay { top: 160px; color: #faa; display: none; }
    #imanContador { top: 190px; right: 20px; background: rgba(0,0,0,0.75); padding: 8px; border-radius: 10px; font-size: 16px; display: none; }
    #nombreJugador { top: 10px; left: 50%; transform: translateX(-50%); color: #0ff; }

    /* Botones */
    .fixed { position: fixed; z-index: 10000; transition: opacity .3s; }
    .hiddenUI { opacity: 0; }
    .btn {
      padding: 1rem 2rem; background: #0ff; border: none; border-radius: 10px;
      color: #000; font-size: 1.2rem; font-weight: bold; cursor: pointer;
      transition: transform .2s, box-shadow .2s;
    }
    .btn:hover { transform: scale(1.05); box-shadow: 0 0 10px #0ff; }
    #conectarWalletBtn {
      top: 20px; right: 20px; background: #0ff; color: #000; border: none;
      border-radius: 12px; padding: 10px 20px; font: 16px 'Orbitron', sans-serif; cursor: pointer;
    }
    #menuPrincipal {
      top: 70px; right: 20px; display: flex; flex-direction: column; gap: 10px;
    }
    /* Paneles flotantes */
    #tiendaCDOGE, #rankingPanel {
      position: fixed; background: rgba(0,0,0,0.85); padding: 15px;
      border-radius: 15px; box-shadow: 0 0 15px #0ff; font: 14px 'Orbitron', sans-serif; color: #fff;
      z-index: 10001; display: none;
    }
    #tiendaCDOGE { bottom: 20px; left: 20px; width: 320px; border: 2px solid #0ff; }
    #rankingPanel { top: 200px; left: 50%; transform: translateX(-50%); }
  </style>
</head>

<body>
<!-- Pantalla de carga -->
<div id="pantallaCarga">
  <div class="spinner"></div>
  <p style="font-size:20px;margin-top:20px;">Cargando CosmoDoge...</p>
</div>

<!-- HUD y botones -->
<button id="conectarWalletBtn" class="fixed">üîó Conectar Wallet</button>
<div id="scoreDisplay" class="hud">üöÄ x 0</div>
<div id="coinDisplay" class="hud">üí∞ x 0</div>
<div id="highScoreDisplay" class="hud">üîù M√°x: 0</div>
<div id="contadorCDOGE" class="hud">üí∞ CDOGE: 0</div>
<div id="contadorBCOSMO" class="hud">üêï BCOSMO: 0</div>
<div id="shieldDisplay" class="hud"></div>
<div id="imanContador"></div>
<div id="nombreJugador" class="hud"></div>

<div id="menuPrincipal" class="fixed">
  <button id="btnTienda" class="btn">üõí Tienda</button>
  <button id="btnRanking" class="btn">üèÜ Ranking</button>
</div>

<!-- Tienda -->
<div id="tiendaCDOGE">
  <h3 style="color:#0ff;">üõí Tienda CosmoDoge</h3>
  <div style="margin-bottom:15px;padding:10px;background:#111;border:1px solid #0ff;border-radius:10px;">
    <p style="color:#0ff;">üß≤ Im√°n Espacial (CDOGE)</p>
    <p style="color:#bbb;">Atrae monedas 1h</p>
    <button id="comprarImanCDOGE" class="btn">Comprar 1,500 $CDOGE</button>
  </div>
  <div style="margin-bottom:15px;padding:10px;background:#111;border:1px solid #0ff;border-radius:10px;">
    <p style="color:#0ff;">üß≤ Im√°n Espacial (BCOSMO)</p>
    <p style="color:#bbb;">Atrae monedas 1h</p>
    <button id="comprarImanBCOSMO" class="btn">Comprar 2,500 $BCOSMO</button>
  </div>
  <div style="padding:10px;background:#111;border:1px solid #faa;border-radius:10px;">
    <p style="color:#faa;">üõ°Ô∏è Escudo Protector</p>
    <p style="color:#bbb;">Inmune 13s</p>
    <button id="comprarEscudo" class="btn">Comprar 1,000 ü™ô</button>
    <div style="padding:10px;background:#111;border:1px solid #0ff;border-radius:10px;margin-top:10px;">
  <p style="color:#bbb;">üë®‚ÄçüöÄ Skin Astronauta</p>
  <p style="color:#888;font-size:12px;">Desbloqu√©alo por 3,500 monedas</p>
  <button id="comprarSkinAstronauta" class="btn">Comprar Skin Astronauta</button>
</div>

  </div>
</div>

<!-- Ranking -->
<div id="rankingPanel">
  <div id="topRanking"></div>
  <button id="closeRanking" class="btn">Cerrar</button>
</div>
<!-- Canvas de juego -->
<canvas id="gameCanvas"></canvas>

<!-- Pantallas superpuestas -->
<div id="startScreen" style="display:none;">
  <h1>üöÄ CosmoDoge Flotante</h1>
  <button id="startButton" class="btn">¬°Comenzar!</button>
</div>
<div id="gameOverScreen">
  <h1>üö® GAME OVER üö®</h1>
  <p>Puntaje: <span id="finalScore">0</span></p>
  <button id="reiniciarBtn" class="btn">Reiniciar</button>
</div>
<div id="newRecordMessage" style="display:none;">
  <h1>üåü ¬°Nuevo r√©cord gal√°ctico!</h1>
  <p>Ingresa tu nombre para guardarlo.</p>
</div>
<div id="playerNameForm">
  <input type="text" id="playerName" placeholder="Tu nombre gal√°ctico" style="padding:10px;border:none;border-radius:8px;margin-bottom:10px;" />
  <button id="saveScoreButton" class="btn">Guardar Puntaje</button>
</div>

<!-- Firebase Configuraci√≥n -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
import { getFirestore, collection, query, orderBy, limit, getDocs, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDaM9HtMtTlJXc-V4HfsZ7bbC__ZPe9zIk",
  authDomain: "cosmodogelive.firebaseapp.com",
  projectId: "cosmodogelive",
  storageBucket: "cosmodogelive.appspot.com",
  messagingSenderId: "648227069914",
  appId: "1:648227069914:web:3ef7ac8da4ab52c30deae3"
};
initializeApp(firebaseConfig);
const db = getFirestore();

window.guardarJugadorAutomatic = async (nombre, puntaje, monedas) => {
  await addDoc(collection(db, "jugadores"), {
    nombre: nombre,
    puntaje: puntaje,
    monedas: monedas,
    fecha: serverTimestamp()
  });
};

window.mostrarTopRanking = async () => {
  const lista = document.getElementById("topRanking");
  const snap = await getDocs(query(collection(db, "jugadores"), orderBy("puntaje", "desc"), limit(5)));
  let html = "<h2>üèÜ Top 5 CosmoDoge</h2><ul style='list-style:none;padding:0;'>";
  snap.forEach((doc, i) => {
    const d = doc.data();
    html += `<li>#${i + 1} <strong>${d.nombre}</strong> ‚Äì ${d.puntaje} pts ‚Äì ${d.monedas} ü™ô</li>`;
  });
  lista.innerHTML = html + "</ul>";
};
</script>

<!-- Scripts de Juego -->
<script>
  const canvas = document.getElementById('gameCanvas'), ctx = canvas.getContext('2d');
  function resizeCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
  window.addEventListener('resize', resizeCanvas); resizeCanvas();
  
  // Estado inicial
  let score = 0, coins = parseInt(localStorage.getItem('cdogeCoins')) || 0;
  let highScore = parseInt(localStorage.getItem('cdogeFloatHighScore')) || 0;
  let totalCDOGE = parseInt(localStorage.getItem('cdogeTotalCoins')) || 0;
  let totalBCOSMO = parseInt(localStorage.getItem('bcosmoTotalCoins')) || 0;
  let gameStarted = false, isGameOver = false;
  let timeElapsed = 0, lastScoreTime = 0, lastFondoChange = 0, lastObs = Date.now();
  const gravityLevels = [0.5, 0.6, 0.8, 1.0];
  let gravity = 0.5, jumpPower = -10;
 
  
  // Arrays
  let coinsArr = [], obsArr = [], cdogeArr = [], bcosmoArr = [];
  const valorPorMoneda = 50, valorBCOSMO = 50;
  let turnoCoins = true;
  
  // Fondos
  const fondos = ['fondo-cosmodoge-v2.png', 'fondo-cosmodoge-v3.png', 'fondo-cosmodoge-v4.png'];
  let fi = 0;
  const fondoImg = new Image();
  fondoImg.src = fondos[0];
  
  // Jugador
  const doge = { x: 80, y: 200, w: 50, h: 50, v: 0, img: new Image() };
  doge.img.src = 'cosmodoge-cohete-juego.png';
  
  // Skins
  const skinAstronauta = new Image();
  skinAstronauta.src = 'cosmodoge-skin-astronauta.png';
  let skinAstronautaActivo = false;
let skinAstronautaComprado = localStorage.getItem('skinAstronautaComprado') === 'true';
let skinAstronautaExpiracion = parseInt(localStorage.getItem('skinAstronautaExpiracion')) || 0;

// Verificar si el skin gratuito sigue activo
if (!skinAstronautaComprado && Date.now() < skinAstronautaExpiracion) {
  skinAstronautaActivo = true;
}

  // Im√°genes y sonidos
  const coinImg = new Image(); coinImg.src = 'coin-cosmodoge.png';
  const cdogeImg = new Image(); cdogeImg.src = 'moneda-cosmodoge.png';
  const bcosmoImg = new Image(); bcosmoImg.src = 'moneda-bcosmo.png';
  const obsImgs = ['obstaculo-estelar.png', 'obstaculo-explosion.png', 'obstaculo-explosion-aire.png'];
  
  const sndJump = new Audio('jump.mp3');
  const sndCoin = new Audio('coin.mp3');
  const sndBoom = new Audio('boom.mp3');
  const sndRecord = new Audio('record.mp3');
  const sndCdoge = new Audio('sonido-moneda-cdoge.mp3');
  const sndBcosmo = new Audio('sonido-moneda-bcosmo.mp3');
  const music = new Audio('music-cosmodoge-theme.mp3');
  music.loop = true;
  music.volume = 0.3;
  
  // Smart contracts
  const CDOGE_CON = '0x5dE25281305992d3552a45A3D8ccA7BdfB4AcD3A'.toLowerCase();
  const ERC20_ABI = ['function balanceOf(address) view returns(uint256)','function decimals() view returns(uint8)','function transfer(address,uint256) returns(bool)'];
  const CDOGE_REC = '0x1980dCdDA07071970dEAa69c975F590976Ee667D'.toLowerCase();
  const MINT = '2etLM91LBaxbQ1y3jnzQw8EXKNHAKcXJsHMJJ69opump';
  const RCV = 'A6dnVgGaS1scC2m6hmPdK15D5gs5vDsHS8PEq3xtJKNx';
// Utilidades
function play(s) { s.currentTime = 0; s.play().catch(() => {}); }
function showMsg(txt, x, y) {
  const d = document.createElement('div');
  Object.assign(d.style, {position:'absolute',left:`${x}px`,top:`${y}px`,color:'#0ff',font:'18px Orbitron',zIndex:10000,transition:'all 1.5s'});
  d.textContent = txt;
  document.body.appendChild(d);
  setTimeout(() => { d.style.opacity = 0; d.style.transform = 'translateY(-40px)'; }, 100);
  setTimeout(() => d.remove(), 1600);
}

// Actualizar contadores
function updCDOGE() { document.getElementById('contadorCDOGE').textContent = `üí∞ CDOGE: ${totalCDOGE}`; }
function updBCOSMO() { document.getElementById('contadorBCOSMO').textContent = `üêï BCOSMO: ${totalBCOSMO}`; }

// Ajustar gravedad por tiempo jugado
function updDiff(sec) {
  gravity = sec >= 75 ? gravityLevels[3] :
            sec >= 45 ? gravityLevels[2] :
            sec >= 30 ? gravityLevels[1] : gravityLevels[0];
}

// Aura de im√°n y aura estrellas del escudo
function drawAura(p) {
  const expIman = parseInt(localStorage.getItem('imanExpiracion')) || 0;
  const expShield = parseInt(localStorage.getItem('shieldExpiration')) || 0;
  if (Date.now() < expIman) {
    ctx.beginPath();
    ctx.arc(p.x+p.w/2, p.y+p.h/2, p.w*0.8, 0, Math.PI*2);
    ctx.strokeStyle = '#0ffff088';
    ctx.lineWidth = 4;
    ctx.stroke();
  }
  if (Date.now() < expShield) {
    ctx.beginPath();
    ctx.arc(p.x+p.w/2, p.y+p.h/2, p.w*1.2, 0, Math.PI*2);
    ctx.strokeStyle = '#ff0a'; 
    ctx.lineWidth = 5;
    ctx.setLineDash([5, 15]);
    ctx.stroke();
    ctx.setLineDash([]);
  }
}

// Dibujar jugador
function drawDoge() {
  if (skinAstronautaActivo) {
    ctx.drawImage(skinAstronauta, doge.x, doge.y, doge.w, doge.h);
  } else {
    ctx.drawImage(doge.img, doge.x, doge.y, doge.w, doge.h);
  }
  drawAura(doge);
}

// Im√°n activo
function actIman() {
  const exp = Date.now() + 3600000;
  localStorage.setItem('imanExpiracion', exp);
  showMsg('üß≤ Im√°n activo 1h', canvas.width/2, 100);
  checkIman();
}
function checkIman() {
  const id = setInterval(() => {
    const exp = parseInt(localStorage.getItem('imanExpiracion')) || 0, now = Date.now(), d = document.getElementById('imanContador');
    if (now < exp) {
      const ms = exp-now, m = Math.floor(ms/60000), s = Math.floor((ms%60000)/1000);
      d.textContent = `üß≤ Im√°n: ${m}:${s<10?'0':''}${s}`;
      d.style.display = 'block';
    } else {
      d.style.display = 'none';
      localStorage.removeItem('imanExpiracion');
      clearInterval(id);
      showMsg('‚è±Ô∏è Im√°n expirado', canvas.width/2, 100);
    }
  }, 250);
}

// Escudo activo
let escudoColisiones = parseInt(localStorage.getItem('escudoColisiones')) || 0;

function buyShield() {
  if (coins < 1000) return alert('No tienes suficientes ü™ô');
  coins -= 1000;
  localStorage.setItem('cdogeCoins', coins);
  document.getElementById('coinDisplay').textContent = `üí∞ x ${coins}`;
  
  escudoColisiones = 3;
  localStorage.setItem('escudoColisiones', escudoColisiones);
  updateShieldDisplay();
  showMsg('üõ°Ô∏è Escudo con 3 colisiones activado', canvas.width/2, 140);
}

function updateShieldDisplay() {
  const d = document.getElementById('shieldDisplay');
  if (escudoColisiones > 0) {
    d.textContent = `üõ°Ô∏è Escudo: ${escudoColisiones} impactos`;
    d.style.display = 'block';
  } else {
    d.style.display = 'none';
    localStorage.removeItem('escudoColisiones');
  }
}

function handleCollision() {
  if (escudoColisiones > 0) {
    escudoColisiones--;
    localStorage.setItem('escudoColisiones', escudoColisiones);
    updateShieldDisplay();
    showMsg('üõ°Ô∏è Colisi√≥n bloqueada!', canvas.width/2, 160);
    return true; // no perder
  }
  return false; // perder
}

// Monedas normales
function spawnCoinGroup() {
  const amt = Math.floor(Math.random() * 6) + 5;
  for (let i = 0; i < amt; i++) {
    coinsArr.push({x: canvas.width + i * 40, y: Math.random() * (canvas.height - 100), w: 30, h: 30, s: 2});
  }
}

function drawCoins() {
  for (let i = coinsArr.length - 1; i >= 0; i--) {
    const c = coinsArr[i];
    const exp = parseInt(localStorage.getItem('imanExpiracion')) || 0;
    if (Date.now() < exp) {
      const dx = c.x + 15 - (doge.x + doge.w/2), dy = c.y + 15 - (doge.y + doge.h/2), dist = Math.hypot(dx, dy);
      if (dist < 200) {
        c.x -= dx * 0.05;
        c.y -= dy * 0.05;
      }
    }
    c.x -= c.s;
    ctx.drawImage(coinImg, c.x, c.y, c.w, c.h);
    if (doge.x < c.x+c.w && doge.x+doge.w > c.x && doge.y < c.y+c.h && doge.y+doge.h > c.y) {
      coins++;
      localStorage.setItem('cdogeCoins', coins);
      document.getElementById('coinDisplay').textContent = `üí∞ x ${coins}`;
      play(sndCoin);
      coinsArr.splice(i, 1);
    }
  }
}

// Obst√°culos especiales
function spawnObstacle() {
  const img = new Image();
  img.src = obsImgs[Math.floor(Math.random() * obsImgs.length)];
  obsArr.push({x: canvas.width, y: Math.random() * (canvas.height - 50), w: 50, h: 50, sX: 2 + Math.random() * 2, sY: 0.5 + Math.random() * 1.5, img});
}

function drawObstacles() {
  obsArr.forEach((o, i) => {
    o.x -= o.sX;
    o.y += (o.y < doge.y ? o.sY : -o.sY);
    ctx.drawImage(o.img, o.x, o.y, o.w, o.h);
    if (doge.x < o.x+o.w && doge.x+doge.w > o.x && doge.y < o.y+o.h && doge.y+doge.h > o.y) {
      if (!handleCollision()) gameOver();
    }
  });
  obsArr = obsArr.filter(o => o.x + o.w > 0);
}

// Fondos
function drawBackground() {
  ctx.drawImage(fondoImg, 0, 0, canvas.width, canvas.height);
}

// Monedas especiales CDOGE y BCOSMO
const ubic = [
  {x:80,y:100},{x:canvas.width-120,y:80},
  {x:canvas.width/2,y:canvas.height/3},
  {x:canvas.width-80,y:canvas.height-120},
  {x:100,y:canvas.height-150}
];

function spawnGroupCDOGE() { ubic.forEach(p => cdogeArr.push({x:p.x,y:p.y,w:32,h:32,got:false})); }
function spawnGroupBCOSMO() { ubic.forEach(p => bcosmoArr.push({x:p.x,y:p.y,w:32,h:32,got:false})); }
setInterval(() => { turnoCoins ? spawnGroupCDOGE() : spawnGroupBCOSMO(); turnoCoins = !turnoCoins; }, 20000);

function drawCDOGE() {
  for (let i = cdogeArr.length - 1; i >= 0; i--) {
    const m = cdogeArr[i];
    m.x -= 4;
    if (m.x + m.w < 0) { cdogeArr.splice(i, 1); continue; }
    if (!m.got) ctx.drawImage(cdogeImg, m.x, m.y, m.w, m.h);
  }
  collectCDOGE();
}

function collectCDOGE() {
  for (const m of cdogeArr) {
    if (!m.got) {
      const dx = m.x+16 - (doge.x+doge.w/2), dy = m.y+16 - (doge.y+doge.h/2), dist = Math.hypot(dx, dy);
      const exp = parseInt(localStorage.getItem('imanExpiracion')) || 0;
      if (Date.now() < exp && dist < 200) {
        m.x -= dx * 0.05; m.y -= dy * 0.05;
      }
      if (dist < 20) {
        m.got = true;
        totalCDOGE += valorPorMoneda;
        localStorage.setItem('cdogeTotalCoins', totalCDOGE);
        play(sndCdoge);
        showMsg(`+${valorPorMoneda} CDOGE`, m.x, m.y);
        updCDOGE();
      }
    }
  }
}

function drawBCOSMO() {
  for (let i = bcosmoArr.length - 1; i >= 0; i--) {
    const m = bcosmoArr[i];
    m.x -= 4;
    if (m.x + m.w < 0) { bcosmoArr.splice(i, 1); continue; }
    if (!m.got) ctx.drawImage(bcosmoImg, m.x, m.y, m.w, m.h);
  }
  collectBCOSMO();
}

function collectBCOSMO() {
  for (const m of bcosmoArr) {
    if (!m.got) {
      const dx = m.x+16 - (doge.x+doge.w/2), dy = m.y+16 - (doge.y+doge.h/2), dist = Math.hypot(dx, dy);
      const exp = parseInt(localStorage.getItem('imanExpiracion')) || 0;
      if (Date.now() < exp && dist < 200) {
        m.x -= dx * 0.05; m.y -= dy * 0.05;
      }
      if (dist < 20) {
        m.got = true;
        totalBCOSMO += valorBCOSMO;
        localStorage.setItem('bcosmoTotalCoins', totalBCOSMO);
        play(sndBcosmo);
        showMsg(`+${valorBCOSMO} BCOSMO`, m.x, m.y);
        updBCOSMO();
      }
    }
  }
}

// Main loop
let lastTs = 0;
function loop(ts) {
  if (!gameStarted || isGameOver) return;
  if (!lastTs) lastTs = ts;
  const dt = ts - lastTs;
  lastTs = ts;
  ctx.clearRect(0,0,canvas.width,canvas.height);

  drawBackground();
  doge.v += gravity * (dt/16);
  doge.y += doge.v * (dt/16);
  if (doge.y + doge.h >= canvas.height || doge.y <= 0) {
    if (!handleCollision()) return gameOver();
    doge.y = canvas.height/2;
  }
  drawDoge();
  drawCoins();
  drawAgujeroNegro();
  drawCofreEspacial();
  drawObstacles();
  drawCDOGE();
  drawBCOSMO();
  
  timeElapsed += dt;
  const sec = timeElapsed / 1000;
  if (sec - lastScoreTime >= 5) {
    score++;
    lastScoreTime = sec;
    document.getElementById('scoreDisplay').textContent = `üöÄ x ${score}`;
  }
  if (sec - lastFondoChange >= 30) {
    fi = (fi + 1) % fondos.length;
    fondoImg.src = fondos[fi];
    lastFondoChange = sec;
  }
  if (Math.floor(timeElapsed/16) % 150 === 0) spawnCoinGroup();
  const now = Date.now();
  const interval = sec >= 3600 ? 1000 : sec >= 1800 ? 2000 : 3000;
  if (now - lastObs >= interval) {
    spawnObstacle();
    lastObs = now;
  }
  updDiff(sec);

  // Activar skin astronauta si llega al nivel 25
  // Activar skin si llega a nivel 25
if (!skinAstronautaActivo && score >= 25 && !skinAstronautaComprado) {
    skinAstronautaActivo = true;
    const ahora = Date.now();
    const tresDias = 3 * 24 * 60 * 60 * 1000; // 3 d√≠as en milisegundos
    const expiracion = ahora + tresDias;
    localStorage.setItem('skinAstronautaExpiracion', expiracion.toString());
    showMsg('üöÄ Skin Astronauta desbloqueado por 3 d√≠as!', canvas.width/2, 60);
}

  requestAnimationFrame(loop);
}
// Game Over
function gameOver() {
  isGameOver = true;
  music.pause();
  music.currentTime = 0;

  // Mostrar puntaje en pantalla
  document.getElementById('finalScore').textContent = score;

  // Mostrar pantalla de Game Over
  const go = document.getElementById('gameOverScreen');
  go.style.display = 'flex';
  setTimeout(() => go.classList.add('show'), 10);

  // Mostrar bot√≥n de reinicio siempre
  setTimeout(() => {
    const reiniciar = document.getElementById('reiniciarBtn');
    if (reiniciar) reiniciar.style.display = 'block';
  }, 1000);

  // Si es nuevo r√©cord
  if (score > highScore) {
    localStorage.setItem('cdogeFloatHighScore', score);
    highScore = score;
    document.getElementById('highScoreDisplay').textContent = `üîù M√°x: ${highScore}`;
    play(sndRecord);

    const nombreGuardado = localStorage.getItem('cosmodogeliveUserName');
    document.getElementById('newRecordMessage').style.display = 'flex';

    if (!nombreGuardado) {
      document.getElementById('playerNameForm').style.display = 'flex';
    } else {
      // Ocultar formularios para liberar bot√≥n de reinicio
      document.getElementById('newRecordMessage').style.display = 'none';
      document.getElementById('playerNameForm').style.display = 'none';
      guardarJugadorAutomatic(nombreGuardado, score, coins).then(mostrarTopRanking);
    }

  } else {
    play(sndBoom);
  }
}


// UI handlers
function toggleTienda() {
  const t = document.getElementById('tiendaCDOGE');
  t.style.display = t.style.display === 'block' ? 'none' : 'block';
}
function toggleRanking() {
  const r = document.getElementById('rankingPanel');
  if (r.style.display === 'block') r.style.display = 'none';
  else { mostrarTopRanking(); r.style.display = 'block'; }
}
function mostrarSelectorWallet() {
  const opt = prompt('Selecciona tu wallet:\n1 - MetaMask\n2 - Phantom\n3 - Cerrar Wallet');
  if (opt === '1') conectarMetaMask();
  else if (opt === '2') conectarPhantom();
  else if (opt === '3') cerrarWallet();
  else alert('Opci√≥n inv√°lida');
}

// Wallets
async function conectarMetaMask() {
  if (!window.ethereum) {
    if (/Mobi|Android/i.test(navigator.userAgent)) {
      window.location.href = `https://metamask.app.link/dapp/${encodeURIComponent(location.href)}`;
    } else {
      window.open('https://metamask.io/download/', '_blank');
    }
    return;
  }
  try {
    const provider = new ethers.providers.Web3Provider(window.ethereum);
    const network = await provider.getNetwork();
    if (network.chainId !== 56) {
      await window.ethereum.request({
        method: 'wallet_switchEthereumChain',
        params: [{ chainId: '0x38' }], // BNB Chain ID (hexadecimal)
      });
    }
    const accounts = await provider.send('eth_requestAccounts', []);
    const acct = accounts[0];
    document.getElementById('conectarWalletBtn').textContent = `üîó ${acct.slice(0,6)}‚Ä¶${acct.slice(-4)}`;
    const contract = new ethers.Contract(CDOGE_CON, ERC20_ABI, provider);
    const raw = await contract.balanceOf(acct);
    const dec = await contract.decimals();
    const balance = Number(raw / 10 ** dec).toLocaleString();
    document.getElementById('balanceCDOGE').innerHTML = `üöÄ ${balance} CDOGE`;
    document.getElementById('balanceCDOGE').style.display = 'block';
  } catch (e) {
    console.error(e);
    alert('‚ùå Error al conectar MetaMask.');
  }
}


async function conectarPhantom() {
  const p = window.solana;
  if (!p || !p.isPhantom) {
    if (/Mobi|Android/i.test(navigator.userAgent)) window.location.href = 'https://phantom.app/link';
    else window.open('https://chrome.google.com/webstore/detail/phantom/','_blank');
    return;
  }
  try {
    const resp = await p.connect();
    const pub = resp.publicKey.toString();
    showMsg(`üåê Phantom: ${pub.slice(0,6)}‚Ä¶${pub.slice(-4)}`, canvas.width/2, 80);
    const conn = new solanaWeb3.Connection('https://api.mainnet-beta.solana.com', {
  commitment: 'confirmed',
});
const parsed = await conn.getParsedTokenAccountsByOwner(
  new solanaWeb3.PublicKey(pub),
  { programId: new solanaWeb3.PublicKey(solanaWeb3.TOKEN_PROGRAM_ID) }
);
    let balance = 0;
    parsed.value.forEach(({account}) => {
      const info = account.data.parsed.info;
      if (info.mint === MINT) balance = info.tokenAmount.uiAmount;
    });
    document.getElementById('balanceBCOSMO').innerHTML = `üêï ${balance||0} BCOSMO`;
    document.getElementById('balanceBCOSMO').style.display = 'block';
  } catch(e) {
    console.error(e);
    alert('Error al conectar Phantom');
  }
}

// Bot√≥n cerrar wallet
function cerrarWallet() {
  document.getElementById('conectarWalletBtn').textContent = 'üîó Conectar Wallet';
  document.getElementById('balanceCDOGE').style.display = 'none';
  document.getElementById('balanceBCOSMO').style.display = 'none';
}

// Compras
async function comprarImanCDOGE() {
  await conectarMetaMask();
  if (!window.ethereum) return;
  try {
    const provider = new ethers.providers.Web3Provider(window.ethereum);
    const signer = provider.getSigner();
    const contract = new ethers.Contract(CDOGE_CON, ERC20_ABI, signer);
    const dec = await contract.decimals();
    const amount = ethers.utils.parseUnits('1500', dec);
    const tx = await contract.transfer(CDOGE_REC, amount);
    await tx.wait();
    actIman();
  } catch(e) {
    console.error(e);
    alert('Compra de im√°n CDOGE fallida');
  }
}

async function comprarImanBCOSMO() {
  await conectarPhantom();
  const p = window.solana;
  if (!p || !p.isPhantom) return;
  try {
    const conn = new solanaWeb3.Connection('https://api.mainnet-beta.solana.com', 'confirmed');
    const mintPub = new solanaWeb3.PublicKey(MINT);
    const recPub = new solanaWeb3.PublicKey(RCV);
    const mi = await conn.getParsedAccountInfo(mintPub);
    const dec = mi.value.data.parsed.info.decimals;
    const source = await splToken.getOrCreateAssociatedTokenAccount(conn, p.publicKey, mintPub, p.publicKey);
    const dest = await splToken.getOrCreateAssociatedTokenAccount(conn, p.publicKey, mintPub, recPub);
    const amount = 2500 * 10 ** dec;
    const ix = splToken.createTransferCheckedInstruction(source.address, mintPub, dest.address, p.publicKey, amount, dec);
    let tx = new solanaWeb3.Transaction().add(ix);
    tx.feePayer = p.publicKey;
    tx.recentBlockhash = (await conn.getRecentBlockhash()).blockhash;
    const signed = await p.signTransaction(tx);
    const sig = await conn.sendRawTransaction(signed.serialize());
    await conn.confirmTransaction(sig);
    actIman();
  } catch(e) {
    console.error(e);
    alert('Compra de im√°n BCOSMO fallida');
  }
}
async function comprarSkinAstronauta() {
  try {
    const walletConnected = !!window.ethereum || !!window.solana?.isPhantom;
    if (!walletConnected) {
      alert('üöÄ Conecta primero tu Wallet para comprar el Skin Astronauta.');
      return;
    }

    const precio = 3500;
    const usarBCOSMO = confirm('¬øDeseas pagar con BCOSMO? (Aceptar = BCOSMO / Cancelar = CDOGE)');

    if (usarBCOSMO) {
      // Compra con BCOSMO (Phantom)
      const connection = new solanaWeb3.Connection('https://api.mainnet-beta.solana.com', 'confirmed');
      const provider = window.solana;
      const wallet = provider.publicKey;
      const transaction = new solanaWeb3.Transaction().add(
        solanaWeb3.SystemProgram.transfer({
          fromPubkey: wallet,
          toPubkey: new solanaWeb3.PublicKey('A6dnVgGaS1scC2m6hmPdK15D5gs5vDsHS8PEq3xtJKNx'), // Wallet de BCOSMO
          lamports: precio * valorBCOSMO, // Conversi√≥n a lamports
        })
      );
      const { blockhash } = await connection.getRecentBlockhash();
      transaction.recentBlockhash = blockhash;
      transaction.feePayer = wallet;
      const signed = await provider.signTransaction(transaction);
      await connection.sendRawTransaction(signed.serialize());
    } else {
      // Compra con CDOGE (MetaMask)
      const provider = new ethers.providers.Web3Provider(window.ethereum);
      const signer = provider.getSigner();
      const contract = new ethers.Contract(CDOGE_CON, CDOGE_ABI, signer);
      const dec = await contract.decimals();
      const amount = ethers.utils.parseUnits('3500', dec);
      await contract.transfer('0x1980dCdDA07071970dEAa69c975F590976Ee667D', amount);
    }

    // Actualizar estado de compra
    localStorage.setItem('skinAstronautaComprado', 'true');
    localStorage.setItem('skinAstronautaExpiracion', '0');
    skinAstronautaActivo = true;
    alert('‚úÖ ¬°Skin Astronauta comprado exitosamente y activado!');
  } catch (e) {
    console.error(e);
    alert('‚ùå Error al intentar comprar el Skin Astronauta.');
  }
}

// Inicializaci√≥n
window.addEventListener('DOMContentLoaded', () => {
  setTimeout(() => {
    document.getElementById('pantallaCarga').style.display = 'none';
    document.getElementById('startScreen').style.display = 'flex';
    if (Date.now() < parseInt(localStorage.getItem('imanExpiracion'))) checkIman();
    if (Date.now() < parseInt(localStorage.getItem('shieldExpiration'))) checkShield();
  }, 3000);

  document.getElementById('coinDisplay').textContent = `üí∞ x ${coins}`;
  document.getElementById('highScoreDisplay').textContent = `üîù M√°x: ${highScore}`;
  updCDOGE();
  updBCOSMO();

  document.getElementById('conectarWalletBtn').addEventListener('click', mostrarSelectorWallet);
  document.getElementById('btnTienda').addEventListener('click', toggleTienda);
  document.getElementById('btnRanking').addEventListener('click', toggleRanking);
  document.getElementById('comprarImanCDOGE').addEventListener('click', comprarImanCDOGE);
  document.getElementById('comprarImanBCOSMO').addEventListener('click', comprarImanBCOSMO);
  document.getElementById('comprarEscudo').addEventListener('click', buyShield);
  document.getElementById('comprarSkinAstronauta').addEventListener('click', comprarSkinAstronauta);
  document.getElementById('closeRanking').addEventListener('click', toggleRanking);
  
  document.getElementById('startButton').addEventListener('click', () => {
    document.getElementById('startScreen').style.display = 'none';
    document.getElementById('conectarWalletBtn').classList.add('hiddenUI');
    document.getElementById('menuPrincipal').classList.add('hiddenUI');
    gameStarted = true;
    music.play();
    requestAnimationFrame(loop);
  });

  document.getElementById('reiniciarBtn').addEventListener('click', () => location.reload());
  document.getElementById('saveScoreButton').addEventListener('click', async () => {
  const nombre = document.getElementById('playerName').value.trim();
  if (!nombre) {
    alert('üö® Ingresa tu nombre para guardar tu r√©cord.');
    return;
  }

  // Guardamos el nombre localmente para siguientes partidas
  localStorage.setItem('cosmodogeliveUserName', nombre);

  document.getElementById('playerNameForm').style.display = 'none';
  document.getElementById('newRecordMessage').style.display = 'none';

  const puntaje = score;
  const monedas = coins;

 
  await guardarJugadorAutomatic(nombre, puntaje, monedas);
mostrarTopRanking();
showMsg('‚úÖ ¬°Tu r√©cord se guard√≥ exitosamente!', canvas.width/2, 100);

});



  canvas.addEventListener('touchstart', e => {
    e.preventDefault();
    if (!gameStarted) document.getElementById('startButton').click();
    else if (!isGameOver) {
      doge.v = jumpPower;
      play(sndJump);
    }
  });

  document.addEventListener('keydown', e => {
    if (e.code === 'Space' && gameStarted && !isGameOver) {
      doge.v = jumpPower;
      play(sndJump);
    }
  });
});

// --- Sistema de Monedas Reales para Reclamar Tokens ---

let monedasRealesCDOGE = parseInt(localStorage.getItem('cdogeTotalCoins')) || 0;
let monedasRealesBCOSMO = parseInt(localStorage.getItem('bcosmoTotalCoins')) || 0;

// Actualizar contadores de monedas reales en HUD
function actualizarContadoresReales() {
  document.getElementById('contadorCDOGE').textContent = `üí∞ CDOGE: ${monedasRealesCDOGE.toLocaleString()}`;
  document.getElementById('contadorBCOSMO').textContent = `üêï BCOSMO: ${monedasRealesBCOSMO.toLocaleString()}`;
}

// Bot√≥n de Reclamar Tokens din√°mico
function actualizarBotonReclamar() {
  let botonExistente = document.getElementById('botonReclamarTokens');
  if ((monedasRealesCDOGE >= 50000 || monedasRealesBCOSMO >= 50000) && !botonExistente) {
    const boton = document.createElement('button');
    boton.id = 'botonReclamarTokens';
    boton.className = 'fixed btn';
    boton.style.bottom = '100px';
    boton.style.right = '20px';
    boton.innerText = "üéÅ Reclamar Tokens";
    boton.onclick = reclamarTokens;
    document.body.appendChild(boton);
  }
}

// Reclamar Tokens (con env√≠o a Telegram y Google Sheets)
async function reclamarTokens() {
  let tipoToken = '';
  if (monedasRealesCDOGE >= 50000) {
    monedasRealesCDOGE -= 50000;
    tipoToken = 'CDOGE';
    localStorage.setItem('cdogeTotalCoins', monedasRealesCDOGE);
  } else if (monedasRealesBCOSMO >= 50000) {
    monedasRealesBCOSMO -= 50000;
    tipoToken = 'BCOSMO';
    localStorage.setItem('bcosmoTotalCoins', monedasRealesBCOSMO);
  } else {
    alert('‚ö†Ô∏è No tienes suficientes monedas reales para reclamar.');
    return;
  }

  // Actualizar HUD
  actualizarContadoresReales();
  if (document.getElementById('botonReclamarTokens')) document.getElementById('botonReclamarTokens').remove();

  const walletAddress = localStorage.getItem('walletAddress') || 'Wallet No Detectada';
  const fecha = new Date().toLocaleString();
  const mensaje = `üöÄ Reclamo CosmoDoge\nWallet: ${walletAddress}\nToken: ${tipoToken}\nCantidad: 10000 Tokens\nFecha: ${fecha}`;

  // Enviar a Telegram
  fetch(`https://api.telegram.org/bot7908453405:AAF11Zf5iiQ5peEogomv0djkt0c_KnoCksc/sendMessage?chat_id=7804711018&text=${encodeURIComponent(mensaje)}`);

  // Enviar a Google Sheets
  const formData = new FormData();
  formData.append("entry.1234567890", walletAddress);
  formData.append("entry.2345678901", tipoToken);
  formData.append("entry.3456789012", "10000");
  formData.append("entry.4567890123", fecha);

  fetch("https://script.google.com/macros/s/AKfycbzdsEv22T0mXgS5do-DfyEnQ_AJ8UK8yJkN9JorxIhkkAqAA3cwzXwGHgTgp7Ltzs6PQ/exec", {
    method: "POST",
    mode: "no-cors",
    body: formData
  });

  alert("üéÅ ¬°Reclamaste 10,000 Tokens! Se ha enviado tu solicitud.");
}

// Actualizar cada segundo los contadores y el bot√≥n
setInterval(() => {
  if (!isGameOver) {
    actualizarContadoresReales();
    actualizarBotonReclamar();
  }
}, 1000);
</script>
<script>
  // --- Mejoras de Game Over mostrando monedas reales ---
  
  function gameOver() {
    isGameOver = true;
    music.pause();
    music.currentTime = 0;
  
    document.getElementById('finalScore').textContent = `
    üöÄ Puntaje: ${score}\n
    üí∞ CDOGE Recolectados: ${monedasRealesCDOGE.toLocaleString()}\n
    üêï BCOSMO Recolectados: ${monedasRealesBCOSMO.toLocaleString()}
    `;
  
    const go = document.getElementById('gameOverScreen');
    go.style.display = 'flex';
    setTimeout(() => go.classList.add('show'), 10);
    setTimeout(() => document.getElementById('reiniciarBtn').style.display = 'block', 1500);
  
    if (score > highScore) {
      localStorage.setItem('cdogeFloatHighScore', score);
      highScore = score;
      document.getElementById('highScoreDisplay').textContent = `üîù M√°x: ${highScore}`;
      document.getElementById('newRecordMessage').style.display = 'flex';
      play(sndRecord);
      const u = localStorage.getItem('cosmodogeliveUserName');
      if (!u) {
        document.getElementById('playerNameForm').style.display = 'flex';
      } else {
        guardarJugadorAutomatic(u, score, coins).then(mostrarTopRanking);
      }
    } else play(sndBoom);
  }
  
  // --- Confirmaciones visuales extra ---
  function showConfirmation(msg) {
    const d = document.createElement('div');
    d.style.position = 'fixed';
    d.style.top = '50%';
    d.style.left = '50%';
    d.style.transform = 'translate(-50%, -50%)';
    d.style.background = '#0ff';
    d.style.color = '#000';
    d.style.padding = '20px';
    d.style.borderRadius = '15px';
    d.style.font = '18px Orbitron, sans-serif';
    d.style.zIndex = '10000';
    d.style.textAlign = 'center';
    d.innerText = msg;
    document.body.appendChild(d);
    setTimeout(() => d.remove(), 2500);
  }
  </script>
<script>
  // --- Precarga de √çtems Activos al Iniciar el Juego ---
  
  function precargarItems() {
    // Precargar Im√°n si sigue activo
    const expIman = parseInt(localStorage.getItem('imanExpiracion')) || 0;
    if (Date.now() < expIman) {
      checkIman();
      showConfirmation('üß≤ Im√°n activado');
    }
  
  
    // Precargar Escudo por colisiones
escudoColisiones = parseInt(localStorage.getItem('escudoColisiones')) || 0;
if (escudoColisiones > 0) {
  updateShieldDisplay();
  showConfirmation(`üõ°Ô∏è Escudo activo (${escudoColisiones} impactos)`);
}

  
    // Precargar Skin Astronauta si ya lo tiene permanente o temporal
    const skinPermamente = localStorage.getItem('skinAstronautaComprado') === 'true';
    const skinTemporal = localStorage.getItem('skinTemporalActivo') === 'true';
  
    if (skinPermamente || skinTemporal) {
      skinAstronautaActivo = true;
      doge.img.src = skinAstronauta.src;
      showConfirmation('üë®‚ÄçüöÄ Skin Astronauta Activo');
    }
  }
  
  // Llamamos a precargar √≠tems al iniciar
  window.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
      precargarItems();
    }, 2000);
  });
  </script>
   <script>
    // --- Agujero Negro Mejorado ---
    
    let agujeroNegro = null;
    let faseAgujero = 0; // 0 = arriba, 1 = abajo, 2 = centro
    const secuenciaAgujero = ['arriba', 'abajo', 'centro'];
    
    function spawnAgujeroNegro() {
      const faseActual = secuenciaAgujero[faseAgujero % 3];
      const tamano = 80; // Tama√±o del agujero
    
      let yInicial;
      if (faseActual === 'arriba') yInicial = 100;
      else if (faseActual === 'abajo') yInicial = canvas.height - 200;
      else yInicial = canvas.height / 2 - tamano/2;
    
      agujeroNegro = {
        x: canvas.width + 100,
        y: yInicial,
        w: tamano,
        h: tamano,
        velocidad: 1.5,
        radioAtraccion: 180
      };
    
      faseAgujero++;
    }
    
    // Dibujar Agujero Negro
    function drawAgujeroNegro() {
      if (!agujeroNegro) return;
    
      agujeroNegro.x -= agujeroNegro.velocidad;
    
      // Aura de atracci√≥n
      ctx.beginPath();
      ctx.arc(agujeroNegro.x + agujeroNegro.w/2, agujeroNegro.y + agujeroNegro.h/2, agujeroNegro.radioAtraccion, 0, Math.PI*2);
      ctx.strokeStyle = 'rgba(138,43,226,0.3)';
      ctx.lineWidth = 4;
      ctx.stroke();
    
      // N√∫cleo del agujero
      const grad = ctx.createRadialGradient(
        agujeroNegro.x + agujeroNegro.w/2, agujeroNegro.y + agujeroNegro.h/2, 5,
        agujeroNegro.x + agujeroNegro.w/2, agujeroNegro.y + agujeroNegro.h/2, agujeroNegro.w/2
      );
      grad.addColorStop(0, '#0ff');
      grad.addColorStop(1, '#000');
      ctx.fillStyle = grad;
      ctx.beginPath();
      ctx.arc(agujeroNegro.x + agujeroNegro.w/2, agujeroNegro.y + agujeroNegro.h/2, agujeroNegro.w/2, 0, Math.PI*2);
      ctx.fill();
    
      // Aplicar atracci√≥n gravitacional
      aplicarAtraccionAgujero(doge);
      coinsArr.forEach(c => aplicarAtraccionAgujero(c));
      cdogeArr.forEach(c => aplicarAtraccionAgujero(c));
      bcosmoArr.forEach(c => aplicarAtraccionAgujero(c));
      obsArr.forEach(c => aplicarAtraccionAgujero(c));
    
      // Colisi√≥n directa con el Doge
      const dx = (agujeroNegro.x + agujeroNegro.w/2) - (doge.x + doge.w/2);
      const dy = (agujeroNegro.y + agujeroNegro.h/2) - (doge.y + doge.h/2);
      const distancia = Math.hypot(dx, dy);
    
      if (distancia < agujeroNegro.w/2) {
        gameOver(); // Game Over instant√°neo si entra al n√∫cleo
      }
    
      // Destruir agujero si sale de pantalla
      if (agujeroNegro.x + agujeroNegro.w < 0) agujeroNegro = null;
    }
    
    // Aplicar atracci√≥n gravitacional
    function aplicarAtraccionAgujero(obj) {
      const dx = (agujeroNegro.x + agujeroNegro.w/2) - (obj.x + obj.w/2);
      const dy = (agujeroNegro.y + agujeroNegro.h/2) - (obj.y + obj.h/2);
      const distancia = Math.hypot(dx, dy);
    
      if (distancia < agujeroNegro.radioAtraccion) {
        const fuerza = (agujeroNegro.radioAtraccion - distancia) / agujeroNegro.radioAtraccion;
        obj.x += dx * 0.01 * fuerza;
        obj.y += dy * 0.01 * fuerza;
      }
    }
    
    // Temporizador para que aparezca el Agujero Negro cada 2 minutos
    setInterval(() => {
      if (!isGameOver && !agujeroNegro) {
        spawnAgujeroNegro();
      }
    }, 120000); // Cada 120,000 ms = 2 minutos
    
    </script>
     <script>
      // --- Cofre Espacial Sistema ---
      
      let cofreEspacial = null;
      
      // Funci√≥n para crear el cofre
      function spawnCofreEspacial() {
        const yRandom = Math.random() * (canvas.height - 100) + 50;
        cofreEspacial = {
          x: canvas.width + 100,
          y: yRandom,
          w: 50,
          h: 50,
          velocidad: 2,
          recogido: false
        };
      }
      
      // Dibujar el cofre
      function drawCofreEspacial() {
        if (!cofreEspacial) return;
      
        cofreEspacial.x -= cofreEspacial.velocidad;
        ctx.drawImage(cofreImg, cofreEspacial.x, cofreEspacial.y, cofreEspacial.w, cofreEspacial.h);
      
        // Detecci√≥n de colisi√≥n con el Doge
        if (!cofreEspacial.recogido && doge.x < cofreEspacial.x + cofreEspacial.w && doge.x + doge.w > cofreEspacial.x && doge.y < cofreEspacial.y + cofreEspacial.h && doge.y + doge.h > cofreEspacial.y) {
          cofreEspacial.recogido = true;
          aplicarPremioCofre();
          setTimeout(() => { cofreEspacial = null; }, 100);
        }
      
        // Desaparecer si sale de pantalla
        if (cofreEspacial.x + cofreEspacial.w < 0) cofreEspacial = null;
      }
      
      // Aplicar el premio del cofre
      function aplicarPremioCofre() {
        const premios = ['iman', 'escudo', 'monedas'];
        const premio = premios[Math.floor(Math.random() * premios.length)];
      
        if (premio === 'iman') {
          const exp = Date.now() + 300000; // 5 minutos
          localStorage.setItem('imanExpiracion', exp);
          checkIman();
          showMsg('üß≤ Im√°n Espacial x5 min', canvas.width/2, 100);
        } else if (premio === 'escudo') {
          localStorage.setItem('escudoPendiente', 'true');
          showMsg('üõ°Ô∏è Escudo para la pr√≥xima partida', canvas.width/2, 120);
        } else if (premio === 'monedas') {
          coins += 1000;
          localStorage.setItem('cdogeCoins', coins);
          document.getElementById('coinDisplay').textContent = `üí∞ x ${coins}`;
          showMsg('üí∞ +1000 Coins', canvas.width/2, 140);
        }
      }
      
      // Verificar si hay escudo pendiente al iniciar partida
      function aplicarEscudoPendiente() {
        const pendiente = localStorage.getItem('escudoPendiente') === 'true';
        if (pendiente) {
          localStorage.setItem('shieldExpiration', Date.now() + 13000); // Activamos escudo 13s
          checkShield();
          localStorage.removeItem('escudoPendiente');
          showMsg('üõ°Ô∏è Escudo Activado', canvas.width/2, 140);
        }
      }
      
      // Cada 10 minutos spawneamos un cofre
      setInterval(() => {
        if (!isGameOver && !cofreEspacial) {
          spawnCofreEspacial();
        }
      }, 600000); // 10 minutos
      
      // Imagen del cofre
      const cofreImg = new Image();
      cofreImg.src = 'cofre-espacial.png';
      </script>
      

  

</body>
</html>
