<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CosmoDoge Flotante 🚀</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    /* Estilos simplificados y responsivos */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { overflow: hidden; width: 100%; height: 100%; touch-action: none; }
    body { background: black; font-family: Arial, sans-serif; }
    canvas { display: block; margin: auto; max-width: 100vw; max-height: 100vh; }
    /* Contadores y UI */
    #scoreDisplay, #coinDisplay, #highScoreDisplay, #contadorCDOGE, #contadorIman {
      position: absolute; color: white; font-size: 18px; text-shadow: 2px 2px 5px #000;
      font-family: Orbitron, sans-serif;
    }
    #scoreDisplay { top: 10px; left: 10px; }
    #coinDisplay { top: 40px; left: 10px; }
    #highScoreDisplay { top: 70px; left: 10px; }
    #contadorCDOGE { top: 100px; left: 10px; color: #00ffcc; z-index: 1000; }
    #contadorIman { bottom: 10px; right: 20px; background: rgba(0,0,0,0.7); border-radius: 10px; padding: 8px 12px; display:none; z-index:1000; }
    #nombreJugador { position: fixed; top: 10px; left: 50%; transform: translateX(-50%); color: #00ffff; text-shadow:1px 1px 3px black; }
    #conectarWalletBtn { position: fixed; top: 20px; right: 20px; background: #00ffff; color: black; border:none; border-radius:12px; padding:10px 20px; cursor:pointer; z-index:10000; }
    #menuPrincipal { position: fixed; top: 70px; right: 20px; display:flex; flex-direction:column; gap:10px; }
    #tiendaCDOGE { position: fixed; bottom:20px; left:20px; background:rgba(0,0,0,0.85); border:2px solid #00ffff; border-radius:15px; padding:15px; display:none; backdrop-filter:blur(5px); z-index:1000; }
    #startScreen, #newRecordMessage { position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); display:flex; flex-direction:column; align-items:center; justify-content:center; color:white; z-index:10; }
    .btn { padding:1rem 2rem; background:#00ffff; border:none; border-radius:10px; font-weight:bold; cursor:pointer; transition:background 0.3s; }
    .btn:hover { background:#00e7f5; }
    #gameOverScreen { position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.85); color:white; display:none; flex-direction:column; align-items:center; justify-content:center; text-align:center; opacity:0; transition:opacity 1s ease-in-out; z-index:9998; }
    #gameOverScreen.show { display:flex; opacity:1; }
    #reiniciarBtn { margin-top:20px; display:none; }
    #playerNameForm { display:none; flex-direction:column; align-items:center; background:rgba(0,0,0,0.85); padding:20px; border-radius:10px; z-index:20; }
    #pantallaCarga { position:fixed; top:0; left:0; width:100vw; height:100vh; background:black; display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:9999; }
    .spinner { width:60px; height:60px; border:6px solid #ffffff22; border-top:6px solid #00ffff; border-radius:50%; animation:spin 1s linear infinite; }
    @keyframes spin { to { transform:rotate(360deg); } }
    #balanceCDOGE { position:fixed; top:110px; right:20px; background:rgba(0,0,0,0.7); color:#00ffcc; padding:10px; border-radius:10px; display:none; text-shadow:1px 1px 3px black; max-width:250px; }
  </style>
</head>
<body>
  <!-- Preloader -->
  <div id="pantallaCarga"><div class="spinner"></div><p style="color:white;font-family:'Orbitron';margin-top:20px;">Iniciando viaje...</p></div>
  <!-- UI Principal -->
  <button id="conectarWalletBtn">🔗 Conectar Wallet</button>
  <div id="balanceCDOGE"></div>
  <div id="menuPrincipal"><button class="btn" onclick="toggleTienda()">🛒 Tienda</button></div>
  <div id="tiendaCDOGE"><h3>🛒 Tienda CosmoDoge</h3><div><p>🧲 Imán Espacial</p><p>Atrae monedas 1h.</p><button class="btn" id="comprarIman">Comprar por 5,000 CDOGE</button></div></div>

  <!-- Canvas y contadores -->
  <canvas id="gameCanvas" width="480" height="640"></canvas>
  <div id="scoreDisplay">🚀 x 0</div>
  <div id="coinDisplay">💰 x 0</div>
  <div id="highScoreDisplay">🔝 Máx: 0</div>
  <div id="contadorCDOGE">💰 CDOGE: 0</div>
  <div id="contadorIman">🧲 Imán activo: 60:00</div>
  <div id="nombreJugador"></div>

  <!-- Pantallas de estado -->
  <div id="startScreen"><h1>🚀 Mantén a CosmoDoge flotando</h1><button class="btn" id="startButton">¡Comenzar!</button></div>
  <div id="gameOverScreen"><h1>🚨 GAME OVER 🚨</h1><p>Puntaje: <span id="finalScore">0</span></p><button class="btn" id="reiniciarBtn">Reiniciar</button></div>
  <div id="newRecordMessage"><h1>🌟 ¡Nuevo récord galáctico!</h1><p>🏆 Has superado todos los límites.</p></div>
  <div id="playerNameForm"><input type="text" id="playerName" placeholder="Tu nombre galáctico"><button class="btn" id="saveScoreButton">Guardar Puntaje</button></div>
  <div id="rankingPanel"><div id="topRanking"></div><button class="btn" onclick="document.getElementById('rankingPanel').style.display='none'">Cerrar</button></div>
  <button class="btn" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);" id="reanudarBtn">Reanudar Juego</button>

  <script type="module">
    // Constantes de configuración
    const tokenAddressGlobal = "0x5dE25281305992d3552a45A3D8ccA7BdfB4AcD3A";
    const walletDelJuego = "0x1980dCdDA07071970dEAa69c975F590976Ee667D";

    // Firebase init
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getFirestore, collection, query, orderBy, limit, getDocs, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";
    const app = initializeApp({ apiKey:"AIzaSy...", authDomain:"cosmodogelive.firebaseapp.com", projectId:"cosmodogelive" });
    const db = getFirestore(app);

    // Variables juego
    const canvas = document.getElementById("gameCanvas"), ctx = canvas.getContext("2d");
    let esMovil = /Mobi|Android/i.test(navigator.userAgent), lastTime=0, gameLoop, pausaPorCambioVentana=false;
    let gravity=0.5, gravityLevels=[0.5,0.6,0.8,1.0], jump=-10;
    let score=0, coins=0, highScore=0, totalCDOGERecolectado=0;
    let timeElapsed=0, lastScoreTime=0, lastFondoChange=0, lastObstacleSpawn=Date.now();

    // Datos del jugador
    let gameStarted=false, isGameOver=false;
    let mensajesTemporales=[];

    // Imágenes y arrays
    const fondos=["fondo-v2.png","fondo-v3.png","fondo-v4.png"], fondo=new Image(); fondo.src=fondos[0]; let fondoIndex=0;
    const doge={x:80,y:200,width:50,height:50,velocity:0,img:new Image()}; doge.img.src="cosmodoge.png";
    const coinImg=new Image(); coinImg.src="coin.png"; let coinsArray=[];
    const obstacleImgs=["obs1.png","obs2.png","obs3.png"], specialObstacles=[];
    let monedasCDOGE=[]; const valorPorMoneda=50; const imagenMoneda=new Image(); imagenMoneda.src="cdoge.png";

    // Audios
    const sndJump=new Audio("jump.mp3"), sndCoin=new Audio("coin.mp3"), sndBoom=new Audio("boom.mp3"), sndRecord=new Audio("record.mp3");
    const music=new Audio("music.mp3"); music.loop=true; music.volume=0.3;

    // Elementos UI
    const scoreDisplay=document.getElementById("scoreDisplay"), coinDisplay=document.getElementById("coinDisplay"), highScoreDisplay=document.getElementById("highScoreDisplay");
    const finalScoreElem=document.getElementById("finalScore"), playerNameForm=document.getElementById("playerNameForm");
    const nombreJugadorDiv=document.getElementById("nombreJugador");
    const contadorImanDiv=document.getElementById("contadorIman");

    // Funciones auxiliares
    function mostrarMensajeTemporal(msg,x,y){ mensajesTemporales.push({msg,x,y,start:Date.now()}); }
    function dibujarMensajes(){ const now=Date.now(); mensajesTemporales=mensajesTemporales.filter(m=>{ const d=now-m.start; if(d<1500){ ctx.font="20px Orbitron"; ctx.fillStyle="#00ffff"; ctx.fillText(m.msg,m.x,m.y); return true;} return false; }); }
    function dibujarMonedasCDOGE(){ monedasCDOGE.forEach(m=>{ if(!m.recolectada) ctx.drawImage(imagenMoneda,m.x,m.y,m.width,m.height); }); }
    function detectarColisionMonedas(){ monedasCDOGE.forEach(m=>{ const dx=doge.x-m.x, dy=doge.y-m.y, dist=Math.hypot(dx,dy);
        if(localStorage.getItem("imanExpiraEn")>Date.now() && dist<150){ m.x+=(doge.x-m.x)*0.05; m.y+=(doge.y-m.y)*0.05; }
        if(!m.recolectada && doge.x<m.x+m.width && doge.x+doge.width>m.x && doge.y<m.y+m.height && doge.y+doge.height>m.y){ m.recolectada=true; totalCDOGERecolectado+=valorPorMoneda; localStorage.setItem("cdogeRecolectados",totalCDOGERecolectado);
            sndCoin.play(); mostrarMensajeTemporal(`+${valorPorMoneda} $CDOGE`,m.x,m.y); document.getElementById("contadorCDOGE").textContent=`💰 CDOGE: ${totalCDOGERecolectado}`; }
    }); }

    // Mostrar ranking desde Firestore
    window.mostrarTopRanking = async function(){ const lista=document.getElementById("topRanking"); try{ const q=query(collection(db,"jugadores"),orderBy("puntaje","desc"),limit(5)); const snap=await getDocs(q);
        let html='<h2>🏆 Top 5</h2><ul>'; snap.forEach((doc,i)=>{const d=doc.data(); html+=`<li>#${i+1} ${d.nombre} - ${d.puntaje} pts - ${d.monedas} 🪙</li>`;}); lista.innerHTML=html+'</ul>';}catch(e){lista.innerHTML='<p>Error carga ranking.</p>';} };

    async function guardarJugadorAutomatic(username,puntaje,monedas){ try{ await addDoc(collection(db,"jugadores"),{ nombre:username,puntaje,monedas,fecha:serverTimestamp() }); }catch(e){console.error(e);} }

    // Lógica de juego
    function spawnCoinGroup(){ for(let i=0;i<5;i++){ coinsArray.push({ x:canvas.width+i*40, y:Math.random()*(canvas.height-100), width:30, height:30, speed:2 }); }}
    function drawCoins(){ coinsArray.forEach((c,i)=>{ c.x-=c.speed; ctx.drawImage(coinImg,c.x,c.y,c.width,c.height); if(doge.x<c.x+c.width && doge.x+doge.width>c.x && doge.y<c.y+c.height && doge.y+doge.height>c.y){ coins++; localStorage.setItem("cdogeCoins",coins); coinDisplay.textContent=`💰 x ${coins}`; sndCoin.play(); coinsArray.splice(i,1); }}); }
    function spawnObstacle(){ const img=new Image(); img.src=obstacleImgs[Math.floor(Math.random()*obstacleImgs.length)]; specialObstacles.push({ x:canvas.width, y:Math.random()*canvas.height, width:50, height:50, speedX:2+Math.random()*2, speedY:0.5+Math.random()*1.5, img }); }
    function drawObstacles(){ specialObstacles.forEach((o,i)=>{ o.x-=o.speedX; o.y+=o.y<doge.y?o.speedY:-o.speedY; ctx.drawImage(o.img,o.x,o.y,o.width,o.height); if(doge.x<o.x+o.width&&doge.x+doge.width>o.x&&doge.y<o.y+o.height&&doge.y+doge.height>o.y){ gameOver(); } }); specialObstacles = specialObstacles.filter(o=>o.x+o.width>0); }

    function updateGame(ts){ if(isGameOver) return; if(!lastTime) lastTime=ts; const dt=ts-lastTime; lastTime=ts;
      ctx.clearRect(0,0,canvas.width,canvas.height);
      drawBackground(); dibujarMensajes(); doge.velocity+=gravity*(dt/16); doge.y+=doge.velocity*(dt/16);
      drawDoge(); drawCoins(); drawObstacles(); dibujarMonedasCDOGE(); detectarColisionMonedas();
      timeElapsed+=dt; const secs=timeElapsed/1000;
      if(secs-lastScoreTime>5){ score++; lastScoreTime=secs; scoreDisplay.textContent=`🚀 x ${score}`; }
      if(secs-lastFondoChange>30){ fondoIndex=(fondoIndex+1)%fondos.length; fondo.src=fondos[fondoIndex]; lastFondoChange=secs; }
      if(Date.now()-lastObstacleSpawn>3000){ spawnObstacle(); lastObstacleSpawn=Date.now(); }
      mensajesTemporales = mensajesTemporales.filter(m=>Date.now()-m.start<1500);
      gameLoop=requestAnimationFrame(updateGame);
    }

    function gameOver(){ isGameOver=true; music.pause(); finalScoreElem.textContent=score;
      const go=document.getElementById("gameOverScreen"); go.classList.add("show"); setTimeout(()=>document.getElementById("reiniciarBtn").style.display="block",1500);
      if(score>highScore){ localStorage.setItem("cdogeFloatHighScore",score); highScore=score; highScoreDisplay.textContent=`🔝 Máx: ${highScore}`;
        document.getElementById("newRecordMessage").style.display="flex"; sndRecord.play(); const u=localStorage.getItem("cosmodogeliveUserName");
        if(u) guardarJugadorAutomatic(u,score,coins); else playerNameForm.style.display="flex";
      } else sndBoom.play();
    }

    // Eventos
    document.addEventListener("keydown",e=>{ if(e.code==="Space"&&gameStarted&&!isGameOver){ doge.velocity=jump; sndJump.play(); }});
    if(esMovil) document.addEventListener("touchstart",()=>{ if(gameStarted&&!isGameOver){ doge.velocity=jump; sndJump.play(); }});

    document.getElementById("startButton").onclick=()=>{ document.getElementById("startScreen").style.display="none"; music.play(); gameStarted=true; gameLoop=requestAnimationFrame(updateGame); };
    document.getElementById("reiniciarBtn").onclick=()=>location.reload();
    document.getElementById("saveScoreButton").onclick=()=>{ const n=document.getElementById("playerName").value.trim(); if(n){ localStorage.setItem("cosmodogeliveUserName",n); guardarJugadorAutomatic(n,score,coins); playerNameForm.style.display="none";} else alert("Ingresa nombre."); };
    window.addEventListener("DOMContentLoaded",()=>{ document.getElementById("pantallaCarga").style.display="none"; document.getElementById("startScreen").style.display="flex"; });

    function toggleTienda(){ const t=document.getElementById("tiendaCDOGE"); t.style.display=t.style.display==="block"?"none":"block"; }
    document.getElementById("comprarIman").onclick=async ()=>{ try{ const provider=new ethers.providers.Web3Provider(window.ethereum); const signer=provider.getSigner(); const token=new ethers.Contract(tokenAddressGlobal,["function decimals() view returns(uint8)","function transfer(address,uint256) returns(bool)"],signer);
        const dec=await token.decimals(); const txAmount=ethers.utils.parseUnits("5000",dec); mostrarMensajeTemporal("⏳ Confirmando compra...",canvas.width/2,120);
        const tx=await token.transfer(walletDelJuego,txAmount); await tx.wait(); mostrarMensajeTemporal("✅ Imán activado",canvas.width/2,140);
        localStorage.setItem("imanExpiraEn",Date.now()+3600000);
      }catch(e){ mostrarMensajeTemporal("❌ Error compra",canvas.width/2,140); console.error(e);} };

    function drawBackground(){ ctx.drawImage(fondo,0,0,canvas.width,canvas.height); }
    function drawDoge(){ ctx.drawImage(doge.img,doge.x,doge.y,doge.width,doge.height); }
  </script>
</body>
</html>
