<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CosmoDoge Flotante üöÄ</title>

  <!-- Google Fonts: Orbitron -->
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet" />

  <!-- On-Chain Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.41.0/lib/index.iife.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@solana/spl-token@0.3.5/lib/index.iife.min.js"></script>

  <style>
    /* RESET & BASE */
    * { margin:0; padding:0; box-sizing:border-box; }
    html, body { width:100%; height:100%; background:#000; font-family:'Orbitron',sans-serif; overflow:hidden; }
    canvas { display:block; }

    /* HUD & UI */
    .hud { position:absolute; color:#fff; text-shadow:2px2px5px#000; font-size:18px; z-index:1000; }
    #scoreDisplay { top:10px; left:10px; }
    #coinDisplay { top:40px; left:10px; }
    #highScoreDisplay { top:70px; left:10px; }
    #contadorCDOGE { top:100px; left:10px; color:#0ff; }
    #contadorBCOSMO { top:130px; left:10px; color:#faa200; }
    #shieldDisplay { top:160px; left:10px; color:#faa; display:none; }

    /* Fixed Controls */
    .fixed { position:fixed; z-index:1000; }
    #conectarWalletBtn { top:20px; right:20px; background:#0ff; color:#000; border:none; padding:10px 20px; border-radius:12px; cursor:pointer; }
    #menuPrincipal { top:70px; right:20px; display:flex; flex-direction:column; gap:10px; }

    /* Panels */
    #tiendaCDOGE, #rankingPanel { position:fixed; background:rgba(0,0,0,0.85); padding:15px; border-radius:10px; box-shadow:0 0 10px #0ff; color:#fff; display:none; z-index:1001; }
    #tiendaCDOGE { bottom:20px; left:20px; width:300px; }
    #rankingPanel { top:200px; left:50%; transform:translateX(-50%); }

    .btn { background:#0ff; color:#000; border:none; padding:0.8rem 1.5rem; border-radius:8px; cursor:pointer; font-weight:bold; }

    /* Overlays */
    #pantallaCarga, #startScreen, #gameOverScreen, #newRecordMessage { position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.9); display:flex; flex-direction:column; align-items:center; justify-content:center; color:#fff; z-index:2000; text-align:center; }
    #pantallaCarga .spinner { width:50px; height:50px; border:5px solid #444; border-top:5px solid #0ff; border-radius:50%; animation:spin 1s linear infinite; }
    @keyframes spin { to { transform:rotate(360deg);} }
    #gameOverScreen, #newRecordMessage { display:none; }
    #reiniciarBtn { margin-top:20px; }

    /* Name Form */
    #playerNameForm { display:none; position:fixed; top:40%; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.95); padding:20px; border-radius:10px; z-index:2100; }
    #playerNameForm input { padding:8px; border:none; border-radius:6px; margin-bottom:10px; width:180px; text-align:center; }
  </style>
</head>
<body>
  <!-- Preloader -->
  <div id="pantallaCarga"><div class="spinner"></div><p>Cargando CosmoDoge...</p></div>

  <!-- HUD & UI -->
  <button id="conectarWalletBtn" class="fixed">üîó Conectar Wallet</button>
  <div id="scoreDisplay" class="hud">üöÄ x 0</div>
  <div id="coinDisplay" class="hud">üí∞ x 0</div>
  <div id="highScoreDisplay" class="hud">üîù M√°x: 0</div>
  <div id="contadorCDOGE" class="hud">üí∞ CDOGE: 0</div>
  <div id="contadorBCOSMO" class="hud">üêï BCOSMO: 0</div>
  <div id="shieldDisplay" class="hud"></div>

  <div id="menuPrincipal" class="fixed">
    <button id="btnTienda" class="btn">üõí Tienda</button>
    <button id="btnRanking" class="btn">üèÜ Ranking</button>
  </div>

  <!-- Tienda -->
  <div id="tiendaCDOGE">
    <h3>üõí Tienda</h3>
    <button id="comprarImanCDOGE" class="btn">Im√°n CDOGE (1500)</button><br/><br/>
    <button id="comprarImanBCOSMO" class="btn">Im√°n BCOSMO (2500)</button><br/><br/>
    <button id="comprarEscudo" class="btn">Escudo (1000 monedas)</button>
  </div>

  <!-- Canvas -->
  <canvas id="gameCanvas"></canvas>

  <!-- Overlays -->
  <div id="startScreen"><h1>üöÄ CosmoDoge Flotante</h1><button id="startButton" class="btn">¬°Comenzar!</button></div>
  <div id="gameOverScreen"><h1>üö® GAME OVER</h1><p>Puntaje: <span id="finalScore">0</span></p><button id="reiniciarBtn" class="btn">Reiniciar</button></div>
  <div id="newRecordMessage"><h1>üåü ¬°Nuevo r√©cord gal√°ctico!</h1><p>Ingresa tu nombre abajo:</p></div>

  <!-- Registro Nombre -->
  <div id="playerNameForm">
    <input id="playerName" placeholder="Nombre gal√°ctico" maxlength="12" /><br/>
    <button id="saveScoreButton" class="btn">Guardar</button>
  </div>

  <!-- Ranking -->
  <div id="rankingPanel"><div id="topRanking"></div><button id="closeRanking" class="btn">Cerrar</button></div>

  <!-- Firebase & On-Chain -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getFirestore, collection, query, where, orderBy, limit, getDocs, addDoc, serverTimestamp }
      from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDaM9HtMtTlJXc-V4HfsZ7bbC__ZPe9zIk",
      authDomain: "cosmodogelive.firebaseapp.com",
      projectId: "cosmodogelive",
      storageBucket: "cosmodogelive.appspot.com",
      messagingSenderId: "648227069914",
      appId: "1:648227069914:web:3ef7ac8da4ab52c30deae3"
    };
    initializeApp(firebaseConfig);
    window.db = getFirestore();

    window.guardarJugadorAutomatic = async (nombre, puntaje, monedas) => {
      await addDoc(collection(db, "jugadores"), { nombre, puntaje, monedas, fecha: serverTimestamp() });
    };

    window.mostrarTopRanking = async () => {
      const lista = document.getElementById("topRanking");
      const snap = await getDocs(query(collection(db, "jugadores"), orderBy("puntaje","desc"), limit(5)));
      let html = "<h2>üèÜ Top 5</h2><ul>";
      snap.forEach((doc, i) => { const d = doc.data(); html += `<li>#${i+1} ${d.nombre} ‚Äì ${d.puntaje}</li>`; });
      lista.innerHTML = html + "</ul>";
    };
  </script>

  <!-- Game Logic -->
  <script>
    // Canvas setup
    const canvas = document.getElementById('gameCanvas'), ctx = canvas.getContext('2d');
    function resizeCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    // State
    let score = 0, coins = 0, highScore = 0, totalCDOGE = 0, totalBCOSMO = 0;
    let gameStarted = false, isGameOver = false;
    let timeElapsed = 0, lastScoreTime = 0, spawnTimer = 0;

    // Assets
    const fondos = ['assets/bg1.png','assets/bg2.png','assets/bg3.png']; let bgIndex = 0;
    const fondoImg = new Image(); fondoImg.src = fondos[0];
    const dogeImg = new Image(); dogeImg.src = 'assets/cosmodoge-cohete-juego.png';
    const coinImg = new Image(); coinImg.src = 'assets/coin-cosmodoge.png';
    const cdogeImg = new Image(); cdogeImg.src = 'assets/moneda-cosmodoge.png';
    const bcosmoImg = new Image(); bcosmoImg.src = 'assets/moneda-bcosmo.png';
    const obsImgs = ['assets/obs1.png','assets/obs2.png','assets/obs3.png'];

    // Sounds
    const sndJump = new Audio('assets/jump.mp3');
    const sndCoin = new Audio('assets/coin.mp3');
    const sndBoom = new Audio('assets/boom.mp3');
    const sndRecord = new Audio('assets/record.mp3');
    const sndCdoge = new Audio('assets/sonido-moneda-cdoge.mp3');
    const sndBcosmo = new Audio('assets/sonido-moneda-bcosmo.mp3');
    const music = new Audio('assets/music.mp3');
    music.loop = true; music.volume = 0.3;

    // Player
    const doge = { x:80, y:200, w:50, h:50, vy:0 };
    const gravity = 0.6, jumpPower = -12;

    // Entities
    let backgrounds = [], obstacles = [], coinsArr = [], cdogeArr = [], bcosmoArr = [];

    // Utility
    function play(sound) { sound.currentTime = 0; sound.play().catch(() => {}); }
    function showMsg(txt, x, y) {
      const d = document.createElement('div');
      Object.assign(d.style, { position:'absolute', left:`${x}px`, top:`${y}px`, color:'#0ff', font:'18px Orbitron', zIndex:1500, transition:'opacity 1s' });
      d.textContent = txt; document.body.appendChild(d);
      setTimeout(()=>{ d.style.opacity = '0'; }, 1000);
      setTimeout(()=>d.remove(), 2000);
    }

    // Wallet selectors
    function mostrarSelectorWallet() {
      const opt = prompt('Selecciona wallet:\n1.MetaMask\n2.Phantom');
      if(opt==='1') conectarMetaMask(); else if(opt==='2') conectarPhantom();
    }

    // Toggle UI
    function toggleTienda() { document.getElementById('tiendaCDOGE').style.display = document.getElementById('tiendaCDOGE').style.display==='block'?'none':'block'; }
    function toggleRanking() { const r = document.getElementById('rankingPanel'); r.style.display = r.style.display==='block'?'none':'block'; mostrarTopRanking(); }

    // On-chain constants
    const CDOGE_CON = '0x5dE25281305992d3552a45A3D8ccA7BdfB4AcD3A';
    const ERC20_ABI = [ 'function balanceOf(address) view returns(uint256)', 'function decimals() view returns(uint8)', 'function transfer(address,uint256)' ];
    const CDOGE_REC = '0x1980dCdDA07071970dEAa69c975F590976Ee667D';
    const MINT = '2etLM91LBaxbQ1y3jnzQw8EXKNHAKcXJsHMJJ69opump';
    const RCV = 'A6dnVgGaS1scC2m6hmPdK15D5gs5vDsHS8PEq3xtJKNx';

    // Wallet functions
    async function conectarMetaMask() {
      if(!window.ethereum) return window.open('https://metamask.io/download.html','_blank');
      const acc = await ethereum.request({ method:'eth_requestAccounts'});
      const acct = acc[0]; document.getElementById('conectarWalletBtn').textContent = `üîó ${acct}`;
      const provider = new ethers.providers.Web3Provider(window.ethereum);
      const contract = new ethers.Contract(CDOGE_CON, ERC20_ABI, provider);
      const bal = await contract.balanceOf(acct); const dec = await contract.decimals(); totalCDOGE = Number(bal/10**dec);
      document.getElementById('contadorCDOGE').textContent = `üí∞ CDOGE: ${totalCDOGE}`;
    }
    async function conectarPhantom() {
      const p = window.solana; if(!p||!p.isPhantom) return window.open('https://phantom.app','_blank');
      const resp = await p.connect(); const pub = resp.publicKey;
      const conn = new solanaWeb3.Connection('https://api.mainnet-beta.solana.com');
      const toks = await conn.getParsedTokenAccountsByOwner(pub,{programId:solanaWeb3.TOKEN_PROGRAM_ID});
      toks.value.forEach(t=>{ const info=t.account.data.parsed.info; if(info.mint===MINT) totalBCOSMO=info.tokenAmount.uiAmount; });
      document.getElementById('contadorBCOSMO').textContent = `üêï BCOSMO: ${totalBCOSMO}`;
    }

    // Purchases
    async function comprarImanCDOGE(){ await conectarMetaMask(); const provider=new ethers.providers.Web3Provider(window.ethereum); const signer=provider.getSigner(); const contract=new ethers.Contract(CDOGE_CON,ERC20_ABI,signer); const dec=await contract.decimals(); const tx=await contract.transfer(CDOGE_REC,ethers.utils.parseUnits('1500',dec)); await tx.wait(); showMsg('üß≤ Im√°n activo 1h',canvas.width/2,100); }
    async function comprarImanBCOSMO(){ await conectarPhantom(); // similar SPL transfer logic here }
    function buyShield(){ if(coins<1000) return alert('No tienes suficientes'); coins-=1000; showMsg('üõ°Ô∏è Escudo 13s',canvas.width/2,140); }

    // Game loop
    function loop(ts) { if(!gameStarted) return; ctx.clearRect(0,0,canvas.width,canvas.height); ctx.drawImage(fondoImg,0,0,canvas.width,canvas.height); /* rest update & draw */ requestAnimationFrame(loop); }

    // New record form
    function handleNewRecord(){ document.getElementById('newRecordMessage').style.display='flex'; const f=document.getElementById('playerNameForm'); f.style.display='flex'; document.getElementById('playerName').focus(); }
    async function setupSaveListener(){ document.getElementById('saveScoreButton').onclick = async()=>{ const name=document.getElementById('playerName').value.trim(); if(!name) return alert('Ingresa nombre'); const q= query(collection(db,'jugadores'),where('nombre','==',name),limit(1)); const snap=await getDocs(q); if(!snap.empty) return alert('Nombre existe'); await guardarJugadorAutomatic(name,score,coins); mostrarTopRanking(); document.getElementById('playerNameForm').style.display='none'; document.getElementById('reiniciarBtn').style.display='block'; }; }

    // Modified gameOver
    function gameOver(){ isGameOver=true; document.getElementById('finalScore').textContent=score; document.getElementById('gameOverScreen').style.display='flex'; document.getElementById('reiniciarBtn').style.display='none'; if(score>highScore){ handleNewRecord(); } else { document.getElementById('reiniciarBtn').style.display='block'; } }

    // Init
    window.addEventListener('DOMContentLoaded', ()=>{
      setupSaveListener();
      document.getElementById('conectarWalletBtn').addEventListener('click', mostrarSelectorWallet);
      document.getElementById('btnTienda').addEventListener('click', toggleTienda);
      document.getElementById('btnRanking').addEventListener('click', toggleRanking);
      document.getElementById('comprarImanCDOGE').addEventListener('click', comprarImanCDOGE);
      document.getElementById('comprarImanBCOSMO').addEventListener('click', comprarImanBCOSMO);
      document.getElementById('comprarEscudo').addEventListener('click', buyShield);
      document.getElementById('startButton').addEventListener('click', ()=>{ document.getElementById('startScreen').style.display='none'; gameStarted=true; music.play(); requestAnimationFrame(loop); });
      document.getElementById('reiniciarBtn').addEventListener('click', ()=>location.reload());
      window.addEventListener('keydown',e=>{ if(e.code==='Space'&&gameStarted&&!isGameOver){ /* jump logic */ } });
    });
  </script>
</body>
</html>
